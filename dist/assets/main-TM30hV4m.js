(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const oe={INPUT:2,PING:3,FRAME:18,DEAD:19,PONG:20},W={POSITION:1,ANGLE:2,HP:4,XP:8,LEVEL:16,DRONES:32,TERRITORY:64,TRAIL:128},E={PLAYER_JOIN:1,PLAYER_LEAVE:2,PLAYER_KILL:3,COIN_SPAWN:4,COIN_PICKUP:5,HITSCAN:6,CAPTURE:7,LEVEL_UP:8,SNIP_START:9},be={POS_MAX:65535,ANGLE_MAX:255,ANGLE_SCALE:65535,HP_MAX:255};function I(l,e){return l/be.POS_MAX*e}function Fe(l){return l/be.ANGLE_MAX*Math.PI*2}function Ue(l,e){return l/be.HP_MAX*e}function gt(l){const e=l>>8&255,t=l>>4&15,n=l&15;return{hue:e/255,sat:t/15,lum:n/15}}class yt{constructor(e){this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.view=new DataView(this.buffer),this.offset=0}readU8(){return this.view.getUint8(this.offset++)}readU16(){const e=this.view.getUint16(this.offset,!0);return this.offset+=2,e}readU32(){const e=this.view.getUint32(this.offset,!0);return this.offset+=4,e}readI8(){return this.view.getInt8(this.offset++)}readI16(){const e=this.view.getInt16(this.offset,!0);return this.offset+=2,e}readF32(){const e=this.view.getFloat32(this.offset,!0);return this.offset+=4,e}readString(){const e=this.readU8(),t=new Uint8Array(this.buffer,this.offset,e);return this.offset+=e,new TextDecoder().decode(t)}readBytes(e){const t=new Uint8Array(this.buffer,this.offset,e);return this.offset+=e,t}hasMore(){return this.offset<this.buffer.byteLength}}const C={DISCONNECTED:0,CONNECTING:1,CONNECTED:2,RECONNECTING:3};class St{constructor(e={}){this.url=e.url||"ws://localhost:8787/room/default",this.reconnectDelay=e.reconnectDelay||1e3,this.maxReconnectDelay=e.maxReconnectDelay||3e4,this.inputThrottleMs=e.inputThrottleMs||50,this.ws=null,this.state=C.DISCONNECTED,this.reconnectAttempts=0,this.playerId=null,this.mapSize=0,this.rtt=0,this.lastPingTime=0,this.pingInterval=null,this.lastInputTime=0,this.pendingAngle=null,this.onStateChange=e.onStateChange||(()=>{}),this.onInit=e.onInit||(()=>{}),this.onFrame=e.onFrame||(()=>{}),this.onEvent=e.onEvent||(()=>{}),this.onError=e.onError||(()=>{}),this.onReset=e.onReset||(()=>{})}connect(e){if(this.state===C.DISCONNECTED){this.playerName=e,this.isSpectator=!1,this.setState(C.CONNECTING);try{this.ws=new WebSocket(this.url),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>this.handleOpen(),this.ws.onmessage=t=>this.handleMessage(t),this.ws.onclose=t=>this.handleClose(t),this.ws.onerror=t=>this.handleError(t)}catch(t){this.onError(t),this.scheduleReconnect()}}}connectSpectate(){if(this.state===C.DISCONNECTED){this.playerName=null,this.isSpectator=!0,this.setState(C.CONNECTING);try{this.ws=new WebSocket(this.url),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>this.handleOpenSpectate(),this.ws.onmessage=e=>this.handleMessage(e),this.ws.onclose=e=>this.handleClose(e),this.ws.onerror=e=>this.handleError(e)}catch(e){this.onError(e),this.scheduleReconnect()}}}disconnect(){this.reconnectAttempts=0,this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.ws&&(this.ws.onclose=null,this.ws.close(),this.ws=null),this.setState(C.DISCONNECTED)}sendInput(e){if(this.state!==C.CONNECTED)return;const t=Date.now();if(t-this.lastInputTime<this.inputThrottleMs){this.pendingAngle=e;return}this.lastInputTime=t,this.pendingAngle=null;const n=new ArrayBuffer(3),s=new DataView(n);s.setUint8(0,oe.INPUT);const i=(e+Math.PI)/(Math.PI*2),a=Math.round(i*be.ANGLE_SCALE)&65535;s.setUint16(1,a,!0),this.ws.send(n)}flushInput(){if(this.pendingAngle!==null){const e=this.pendingAngle;this.pendingAngle=null,this.lastInputTime=0,this.sendInput(e)}}sendPing(){if(this.state!==C.CONNECTED)return;this.lastPingTime=performance.now();const e=new ArrayBuffer(9),t=new DataView(e);t.setUint8(0,oe.PING),t.setFloat64(1,this.lastPingTime,!0),this.ws.send(e)}sendReset(){!this.ws||this.ws.readyState!==WebSocket.OPEN||this.ws.send(JSON.stringify({type:"reset"}))}handleOpen(){this.reconnectAttempts=0,this.ws.send(JSON.stringify({type:"hello",name:this.playerName})),this.pingInterval=setInterval(()=>this.sendPing(),2e3)}handleOpenSpectate(){this.reconnectAttempts=0,this.ws.send(JSON.stringify({type:"hello",spectate:!0})),this.pingInterval=setInterval(()=>this.sendPing(),2e3)}handleMessage(e){try{e.data instanceof ArrayBuffer?this.handleBinaryMessage(e.data):this.handleTextMessage(JSON.parse(e.data))}catch(t){console.error("Message parse error:",t)}}handleBinaryMessage(e){const t=new DataView(e);switch(t.getUint8(0)){case oe.FRAME:this.handleFrame(e);break;case oe.PONG:this.handlePong(t);break;case oe.DEAD:this.handleDead(t);break}}handleTextMessage(e){switch(e.type){case"init":this.handleInit(e);break;case"error":this.onError(new Error(e.error));break;case"pong":this.rtt=Date.now()-e.t;break;case"reset":console.log("%cðŸ”„ Room reset, reconnecting...","color: orange; font-weight: bold;"),this.onReset();break;default:this.onEvent(e)}}handleInit(e){this.playerId=e.playerId,this.mapSize=e.mapSize,this.setState(C.CONNECTED),this.onInit({playerId:e.playerId,mapSize:e.mapSize,player:e.player,players:e.players,coins:e.coins})}handleFrame(e){const t=new yt(e),n=this.mapSize;t.readU8();const s=t.readU32(),i=t.readU8();let a=null;i&&(a=this.readPlayerFull(t,n));const o=t.readU8(),h=[];for(let S=0;S<o;S++)h.push(this.readPlayerFull(t,n));const r=t.readU8(),u=[];for(let S=0;S<r;S++)u.push(this.readPlayerDelta(t,n));const c=t.readU8(),f=[];for(let S=0;S<c;S++)f.push(t.readU16());const m=t.readU8(),g=[];for(let S=0;S<m;S++)g.push({id:t.readU16(),x:t.readU16(),y:t.readU16()});const T=t.readU8(),y=[];for(let S=0;S<T;S++)y.push(this.readEvent(t,n));this.onFrame({frame:s,selfPlayer:a,newPlayers:h,updatedPlayers:u,removedPlayerIds:f,coins:g,events:y})}readPlayerFull(e,t){const n=e.readU16(),s=e.readString(),i=I(e.readU16(),t),a=I(e.readU16(),t),o=Fe(e.readU16()),h=Ue(e.readU8(),100),r=e.readU8(),u=e.readU16(),c=e.readU8()/100,f=e.readU8(),m=(f&1)!==0,g=(f&2)!==0,T=gt(e.readU8()),y=e.readU8()/255,S=e.readU8()/255,v=e.readU8(),b=[];for(let H=0;H<v;H++)b.push({x:I(e.readU16(),t),y:I(e.readU16(),t)});const V=e.readU8(),w=[];for(let H=0;H<V;H++)w.push({x:I(e.readU16(),t),y:I(e.readU16(),t)});const R=e.readU8();return{num:n,name:s,x:i,y:a,angle:o,hp:h,maxHp:100,level:r,xp:u,sizeScale:c,dead:m,isSnipped:g,base:{hue:T,sat:y,lum:S},territory:b,trail:w,droneCount:R}}readPlayerDelta(e,t){const n=e.readU16(),s=e.readU8(),i={num:n};if(s&W.POSITION&&(i.x=I(e.readU16(),t),i.y=I(e.readU16(),t)),s&W.ANGLE&&(i.angle=Fe(e.readU16())),s&W.HP&&(i.hp=Ue(e.readU8(),100)),s&W.XP&&(i.xp=e.readU16()),s&W.LEVEL&&(i.level=e.readU8()),s&W.DRONES&&(i.droneCount=e.readU8()),s&W.TERRITORY){const a=e.readU8();i.territory=[];for(let o=0;o<a;o++)i.territory.push({x:I(e.readU16(),t),y:I(e.readU16(),t)})}if(s&W.TRAIL){const a=e.readU8();i.trail=[];for(let o=0;o<a;o++)i.trail.push({x:I(e.readU16(),t),y:I(e.readU16(),t)})}return i}readEvent(e,t){const n=e.readU8(),s={type:n};switch(n){case E.PLAYER_JOIN:s.player=this.readPlayerFull(e,t);break;case E.PLAYER_LEAVE:s.num=e.readU16(),s.silent=e.readU8()===1;break;case E.PLAYER_KILL:s.killerNum=e.readU16(),s.victimNum=e.readU16(),s.killType=e.readU8();break;case E.COIN_SPAWN:s.id=e.readU16(),s.x=I(e.readU16(),t),s.y=I(e.readU16(),t),s.value=e.readU8();break;case E.COIN_PICKUP:s.id=e.readU16(),s.playerNum=e.readU16();break;case E.HITSCAN:s.ownerNum=e.readU16(),s.targetNum=e.readU16(),s.damage=e.readU8();break;case E.CAPTURE:s.playerNum=e.readU16(),s.x=I(e.readU16(),t),s.y=I(e.readU16(),t),s.xpGained=e.readU8();break;case E.LEVEL_UP:s.playerNum=e.readU16(),s.newLevel=e.readU8();break;case E.SNIP_START:s.playerNum=e.readU16(),s.snipperNum=e.readU16();break}return s}handlePong(e){const t=e.getFloat64(1,!0);this.rtt=performance.now()-t}handleDead(e){const t=e.getUint16(1,!0),n=e.getUint8(3);this.onEvent({type:"dead",killerNum:t,killType:n})}handleClose(e){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.ws=null,this.state!==C.DISCONNECTED&&this.scheduleReconnect()}handleError(e){console.error("WebSocket error:",e),this.onError(new Error("WebSocket error"))}scheduleReconnect(){this.setState(C.RECONNECTING);const e=Math.min(this.reconnectDelay*Math.pow(2,this.reconnectAttempts),this.maxReconnectDelay);this.reconnectAttempts++,setTimeout(()=>{this.state===C.RECONNECTING&&(this.setState(C.DISCONNECTED),this.connect(this.playerName))},e)}setState(e){this.state!==e&&(this.state=e,this.onStateChange(e))}getRTT(){return this.rtt}isConnected(){return this.state===C.CONNECTED}}function Ae(){for(let l=0;l<arguments.length;l++)if(arguments[l]<0||arguments[l]>1)throw new RangeError("H, S, L, and A parameters must be between [0, 1]")}function Tt(l,e,t){let n,s,i;if(e===0)n=s=i=t;else{const a=(r,u,c)=>(c<0&&(c+=1),c>1&&(c-=1),c<.16666666666666666?r+(u-r)*6*c:c<.5?u:c<.6666666666666666?r+(u-r)*(.6666666666666666-c)*6:r),o=t<.5?t*(1+e):t+e-t*e,h=2*t-o;n=a(h,o,l+1/3),s=a(h,o,l),i=a(h,o,l-1/3)}return[Math.round(n*255),Math.round(s*255),Math.round(i*255)]}class Y{constructor(e,t,n,s=1){Ae(e,t,n),s!==1&&Ae(s),Object.defineProperties(this,{hue:{value:e,enumerable:!0},sat:{value:t,enumerable:!0},lum:{value:n,enumerable:!0},alpha:{value:s,enumerable:!0}})}deriveLumination(e){let t=Math.min(Math.max(this.lum+e,0),1);return new Y(this.hue,this.sat,t,this.alpha)}deriveHue(e){const t=this.hue-e;return new Y(t-Math.floor(t),this.sat,this.lum,this.alpha)}deriveSaturation(e){let t=Math.min(Math.max(this.sat+e,0),1);return new Y(this.hue,t,this.lum,this.alpha)}deriveAlpha(e){return Ae(e),new Y(this.hue,this.sat,this.lum,e)}lighter(e){return this.deriveLumination(e)}darker(e){return this.deriveLumination(-e)}rgbString(){const e=Tt(this.hue,this.sat,this.lum);return`rgba(${e[0]}, ${e[1]}, ${e[2]}, ${this.alpha})`}static fromData(e){return new Y(e.hue,e.sat,e.lum,e.alpha??1)}static possColors(){const e=[192,150,100].map(s=>s/240),t=[0,10,20,25,30,35,40,45,50,60,70,100,110,120,125,130,135,140,145,150,160,170,180,190,200,210,220].map(s=>s/240),n=[];for(const s of e)for(const i of t)n.push(new Y(i,s,.5,1));for(let s=n.length-1;s>0;s--){const i=Math.floor(Math.random()*(s+1));[n[s],n[i]]=[n[i],n[s]]}return n}}const M={CELL_WIDTH:40,SPEED:4,BORDER_WIDTH:20,LEADERBOARD_NUM:5,SNIP_FUSE_SPEED_MULT:1.5,SNIP_EXP_ACCEL_PER_SEC:.6375,SNIP_FUSE_MAX_SPEED_MULT:6,SNIP_GRACE_PERIOD:.25,COIN_RADIUS:8,TRAIL_SPEED_BUFF_MAX:1.4,TRAIL_SPEED_BUFF_RAMP_TIME:5,TRAIL_SPEED_BUFF_EASE:2,XP_BASE_PER_LEVEL:100,XP_INCREMENT_PER_LEVEL:25,DRONE_ORBIT_RADIUS:55,DRONE_ORBIT_SPEED:2,DRONE_RADIUS:10};let d=null,A=null,D=!1;const p={masterVolume:.6,sfxVolume:.8,musicVolume:.3,enabled:!0,volumes:{playerLaser:.3,enemyLaser:.2,playerFuse:1,enemyFuse:.7,capture:1,levelUp:.8,death:2,kill:2,coinPickup:1,hit:1.5,trailing:.4,speedRush:.5}};let q=null,N=null,de=null,O=null,k=null,fe=null,U=null,_=null,F=null,x=null,L=null,Q=!1,J=[],te=[],se=0,B=null,he=!1;const vt="/music/playlist/menu/SwarmBlitz - Main Menu Theme.mp3";function Qe(l){const e=[...l];for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function Mt(){if(!D)try{d=new(window.AudioContext||window.webkitAudioContext),A=d.createGain(),A.gain.value=p.masterVolume,A.connect(d.destination),D=!0,console.log("[SoundManager] Initialized")}catch(l){console.warn("[SoundManager] Web Audio API not supported:",l),p.enabled=!1}}function z(){d&&d.state==="suspended"&&d.resume()}function bt(l){p.enabled=!!l}function je(l){p.masterVolume=Math.max(0,Math.min(1,l)),A&&(A.gain.value=p.masterVolume),ot()}function Je(l){p.musicVolume=Math.max(0,Math.min(1,l)),ot()}function Ze(l){p.sfxVolume=Math.max(0,Math.min(1,l))}function wt(l){for(const[e,t]of Object.entries(l))Object.prototype.hasOwnProperty.call(p.volumes,e)&&(p.volumes[e]=Math.max(0,Math.min(1,t)))}function Ve(){return{enabled:p.enabled,masterVolume:p.masterVolume,sfxVolume:p.sfxVolume,musicVolume:p.musicVolume,volumes:{...p.volumes}}}function Et(){if(!D||!p.enabled||p.volumes.playerLaser<=0)return;z();const l=p.volumes.playerLaser,e=d.currentTime,t=.15,n=d.createOscillator(),s=d.createOscillator(),i=d.createGain(),a=d.createBiquadFilter();n.type="sawtooth",s.type="square",n.frequency.setValueAtTime(1800,e),n.frequency.exponentialRampToValueAtTime(400,e+t*.7),s.frequency.setValueAtTime(1400,e),s.frequency.exponentialRampToValueAtTime(300,e+t*.7),a.type="lowpass",a.frequency.setValueAtTime(4e3,e),a.frequency.exponentialRampToValueAtTime(800,e+t),a.Q.value=2,i.gain.setValueAtTime(0,e),i.gain.linearRampToValueAtTime(.35*p.sfxVolume*l,e+.01),i.gain.exponentialRampToValueAtTime(.01,e+t),n.connect(a),s.connect(a),a.connect(i),i.connect(A),n.start(e),s.start(e),n.stop(e+t),s.stop(e+t)}function Pt(l,e=800){if(!D||!p.enabled||p.volumes.enemyLaser<=0)return;z();const t=p.volumes.enemyLaser,n=Math.max(0,1-l/e);if(n<.05)return;const s=d.currentTime,i=.12,a=d.createOscillator(),o=d.createOscillator(),h=d.createGain(),r=d.createBiquadFilter();a.type="sawtooth",o.type="triangle",a.frequency.setValueAtTime(900,s),a.frequency.exponentialRampToValueAtTime(250,s+i*.8),o.frequency.setValueAtTime(700,s),o.frequency.exponentialRampToValueAtTime(180,s+i*.8),r.type="lowpass",r.frequency.setValueAtTime(2500,s),r.frequency.exponentialRampToValueAtTime(500,s+i),r.Q.value=3;const u=.25*p.sfxVolume*t*n;h.gain.setValueAtTime(0,s),h.gain.linearRampToValueAtTime(u,s+.008),h.gain.exponentialRampToValueAtTime(.01,s+i),a.connect(r),o.connect(r),r.connect(h),h.connect(A),a.start(s),o.start(s),a.stop(s+i),o.stop(s+i)}function At(l=!0){if(!D||!p.enabled||p.volumes.capture<=0)return;z();const e=p.volumes.capture,t=d.currentTime,n=(l?1:.3)*e,s=d.sampleRate*.4,i=d.createBuffer(1,s,d.sampleRate),a=i.getChannelData(0);for(let u=0;u<s;u++)a[u]=Math.random()*2-1;const o=d.createBufferSource();o.buffer=i;const h=d.createGain(),r=d.createBiquadFilter();if(r.type="bandpass",r.frequency.setValueAtTime(300,t),r.frequency.exponentialRampToValueAtTime(2e3,t+.15),r.frequency.exponentialRampToValueAtTime(500,t+.4),r.Q.value=1,h.gain.setValueAtTime(0,t),h.gain.linearRampToValueAtTime(.15*p.sfxVolume*n,t+.05),h.gain.exponentialRampToValueAtTime(.01,t+.4),o.connect(r),r.connect(h),h.connect(A),o.start(t),o.stop(t+.4),l){const u=[523.25,659.25,783.99],c=.35;u.forEach((f,m)=>{const g=d.createOscillator(),T=d.createGain();g.type="sine",g.frequency.value=f;const y=t+m*.03;T.gain.setValueAtTime(0,y),T.gain.linearRampToValueAtTime(.12*p.sfxVolume*n,y+.02),T.gain.exponentialRampToValueAtTime(.01,y+c),g.connect(T),T.connect(A),g.start(y),g.stop(y+c)})}}function Oe(l=!1,e=0,t=400){if(!D||!p.enabled||p.volumes.death<=0)return;z();const n=p.volumes.death,s=d.currentTime;let i;if(l)i=1*n;else{const b=Math.max(0,1-e/t);if(b<.1)return;i=.5*n*b}const a=d.createOscillator(),o=d.createOscillator(),h=d.createGain(),r=d.createBiquadFilter();a.type="sine",o.type="triangle",a.frequency.setValueAtTime(600,s),a.frequency.exponentialRampToValueAtTime(80,s+.8),o.frequency.setValueAtTime(603,s),o.frequency.exponentialRampToValueAtTime(82,s+.8),r.type="lowpass",r.frequency.setValueAtTime(2e3,s),r.frequency.exponentialRampToValueAtTime(200,s+.7),h.gain.setValueAtTime(.25*p.sfxVolume*i,s),h.gain.linearRampToValueAtTime(.2*p.sfxVolume*i,s+.1),h.gain.exponentialRampToValueAtTime(.01,s+.9),a.connect(r),o.connect(r),r.connect(h),h.connect(A),a.start(s),o.start(s),a.stop(s+.9),o.stop(s+.9);const u=.15,c=d.sampleRate*u,f=d.createBuffer(1,c,d.sampleRate),m=f.getChannelData(0);for(let b=0;b<c;b++){const V=b/d.sampleRate,w=Math.random()>.7?Math.random()*2-1:0,R=Math.exp(-V*15);m[b]=w*R}const g=d.createBufferSource();g.buffer=f;const T=d.createGain(),y=d.createBiquadFilter();y.type="highpass",y.frequency.value=2e3,y.Q.value=1,T.gain.setValueAtTime(.18*p.sfxVolume*i,s),T.gain.exponentialRampToValueAtTime(.01,s+u),g.connect(y),y.connect(T),T.connect(A),g.start(s),g.stop(s+u);const S=d.createOscillator(),v=d.createGain();S.type="sine",S.frequency.setValueAtTime(60,s),S.frequency.exponentialRampToValueAtTime(25,s+.3),v.gain.setValueAtTime(0,s),v.gain.linearRampToValueAtTime(.3*p.sfxVolume*i,s+.015),v.gain.exponentialRampToValueAtTime(.01,s+.35),S.connect(v),v.connect(A),S.start(s),S.stop(s+.35),l&&[180,190,270].forEach(V=>{const w=d.createOscillator(),R=d.createGain();w.type="sine",w.frequency.setValueAtTime(V,s),w.frequency.exponentialRampToValueAtTime(V*.5,s+.6),R.gain.setValueAtTime(0,s+.02),R.gain.linearRampToValueAtTime(.08*p.sfxVolume*n,s+.05),R.gain.exponentialRampToValueAtTime(.01,s+.7),w.connect(R),R.connect(A),w.start(s),w.stop(s+.7)})}function It(){if(!D||!p.enabled||p.volumes.coinPickup<=0)return;z();const l=p.volumes.coinPickup,e=d.currentTime,t=d.createOscillator(),n=d.createOscillator(),s=d.createGain();t.type="sine",n.type="triangle",t.frequency.setValueAtTime(800,e),t.frequency.exponentialRampToValueAtTime(1400,e+.08),n.frequency.setValueAtTime(1200,e),n.frequency.exponentialRampToValueAtTime(2100,e+.08),s.gain.setValueAtTime(0,e),s.gain.linearRampToValueAtTime(.2*p.sfxVolume*l,e+.015),s.gain.exponentialRampToValueAtTime(.01,e+.2),t.connect(s),n.connect(s),s.connect(A),t.start(e),n.start(e),t.stop(e+.2),n.stop(e+.2);const i=d.createOscillator(),a=d.createGain();i.type="sine",i.frequency.setValueAtTime(2400,e+.02),i.frequency.exponentialRampToValueAtTime(3200,e+.1),a.gain.setValueAtTime(0,e+.02),a.gain.linearRampToValueAtTime(.08*p.sfxVolume*l,e+.04),a.gain.exponentialRampToValueAtTime(.01,e+.15),i.connect(a),a.connect(A),i.start(e+.02),i.stop(e+.15)}function Rt(){if(!D||!p.enabled||q)return;z();const e=d.sampleRate*1.5,t=d.createBuffer(1,e,d.sampleRate),n=t.getChannelData(0);for(let m=0;m<e;m++){const g=m/d.sampleRate,T=(Math.random()*2-1)*.5,y=Math.random()>.7?(Math.random()*2-1)*.6:0,S=Math.random()>.97?(Math.random()*2-1)*1:0,v=Math.sin(g*150+Math.random()*2)*.2*(Math.random()>.5?1:0);n[m]=T+y+S+v}const s=d.createBufferSource();s.buffer=t,s.loop=!0;const i=d.createBiquadFilter();i.type="highpass",i.frequency.value=1500,i.Q.value=.7;const a=d.createBiquadFilter();a.type="peaking",a.frequency.value=5e3,a.Q.value=1,a.gain.value=6;const o=d.createOscillator();o.type="sawtooth",o.frequency.value=80;const h=d.createGain();h.gain.value=.08;const r=d.createBiquadFilter();r.type="bandpass",r.frequency.value=200,r.Q.value=3,N=d.createGain();const u=p.volumes.playerFuse??1;N.gain.value=.15*p.sfxVolume*u;const c=d.createOscillator();c.type="sine",c.frequency.value=12;const f=d.createGain();f.gain.value=.02,s.connect(i),i.connect(a),a.connect(N),o.connect(r),r.connect(h),h.connect(N),c.connect(f),f.connect(N.gain),N.connect(A),s.start(),o.start(),c.start(),q={noise:s,burnOsc:o,lfo:c},de=a}function Ct(){if(q)try{if(N){const l=d.currentTime;N.gain.linearRampToValueAtTime(0,l+.1)}setTimeout(()=>{try{q&&(q.noise.stop(),q.burnOsc.stop(),q.lfo.stop())}catch{}q=null,N=null,de=null},150)}catch{q=null,N=null,de=null}}function kt(l){if(!N||!D||!p.enabled||p.volumes.playerFuse<=0)return;const e=p.volumes.playerFuse,t=.15,s=(t+(.45-t)*l)*p.sfxVolume*e,i=d.currentTime;if(N.gain.linearRampToValueAtTime(s,i+.05),de){const h=4+6*l;de.gain.linearRampToValueAtTime(h,i+.05)}}function Dt(){if(!D||!p.enabled||O)return;z();const e=d.sampleRate*1.5,t=d.createBuffer(1,e,d.sampleRate),n=t.getChannelData(0);for(let m=0;m<e;m++){const g=m/d.sampleRate,T=(Math.random()*2-1)*.4,y=Math.random()>.75?(Math.random()*2-1)*.5:0,S=Math.random()>.96?(Math.random()*2-1)*.8:0,v=Math.sin(g*100+Math.random()*2)*.15*(Math.random()>.6?1:0);n[m]=T+y+S+v}const s=d.createBufferSource();s.buffer=t,s.loop=!0;const i=d.createBiquadFilter();i.type="highpass",i.frequency.value=800,i.Q.value=.5;const a=d.createBiquadFilter();a.type="peaking",a.frequency.value=2500,a.Q.value=1.5,a.gain.value=5;const o=d.createOscillator();o.type="sawtooth",o.frequency.value=50;const h=d.createGain();h.gain.value=.1;const r=d.createBiquadFilter();r.type="bandpass",r.frequency.value=150,r.Q.value=2,k=d.createGain();const u=p.volumes.enemyFuse??.7;k.gain.value=.06*p.sfxVolume*u;const c=d.createOscillator();c.type="sine",c.frequency.value=8;const f=d.createGain();f.gain.value=.015,s.connect(i),i.connect(a),a.connect(k),o.connect(r),r.connect(h),h.connect(k),c.connect(f),f.connect(k.gain),k.connect(A),s.start(),o.start(),c.start(),O={noise:s,burnOsc:o,lfo:c},fe=a}function Lt(){if(O)try{if(k){const l=d.currentTime;k.gain.linearRampToValueAtTime(0,l+.1)}setTimeout(()=>{try{O&&(O.noise.stop(),O.burnOsc.stop(),O.lfo.stop())}catch{}O=null,k=null,fe=null},150)}catch{O=null,k=null,fe=null}}function Nt(l,e=300){if(!k||!D||!p.enabled||p.volumes.enemyFuse<=0)return;const t=p.volumes.enemyFuse,n=Math.max(0,1-l/e),s=d.currentTime;if(n<.1){k.gain.linearRampToValueAtTime(0,s+.05);return}const i=.08,o=(i+(.3-i)*n)*p.sfxVolume*t;if(k.gain.linearRampToValueAtTime(o,s+.05),fe){const u=3+4*n;fe.gain.linearRampToValueAtTime(u,s+.05)}}function xe(){return O!==null}function _t(){if(!D||!p.enabled||U)return;z();const e=d.sampleRate*2,t=d.createBuffer(1,e,d.sampleRate),n=t.getChannelData(0);for(let u=0;u<e;u++){const c=u/d.sampleRate,f=(Math.random()*2-1)*.5,m=Math.sin(c*12)*.2*(Math.random()*2-1),g=Math.sin(c*6)*.08;n[u]=f+m+g}F=d.createBufferSource(),F.buffer=t,F.loop=!0,F.playbackRate.value=1;const s=d.createBiquadFilter();s.type="bandpass",s.frequency.value=600,s.Q.value=1.2;const i=d.createBiquadFilter();i.type="highpass",i.frequency.value=300,i.Q.value=.7,x=d.createOscillator(),x.type="sawtooth",x.frequency.value=100;const a=d.createGain();a.gain.value=.02;const o=d.createBiquadFilter();o.type="lowpass",o.frequency.value=200,_=d.createGain(),_.gain.value=0,F.connect(s),s.connect(i),i.connect(_),x.connect(o),o.connect(a),a.connect(_),_.connect(A),F.start(),x.start(),U={noiseSource:F,oscillator:x,bandpass:s};const h=d.currentTime,r=p.volumes.speedRush??.5;_.gain.linearRampToValueAtTime(.12*p.sfxVolume*r,h+.3)}function Ie(){if(U)try{if(_){const l=d.currentTime;_.gain.linearRampToValueAtTime(0,l+.2)}setTimeout(()=>{try{U&&(U.noiseSource.stop(),U.oscillator.stop())}catch{}U=null,_=null,F=null,x=null},250)}catch{U=null,_=null,F=null,x=null}}function Ft(l){if(!U||!_||!D||!p.enabled||p.volumes.speedRush<=0)return;const e=p.volumes.speedRush??.5,t=d.currentTime,n=Math.min(1,Math.max(0,(l-1.1)/.1)),s=1+(1.5-1)*n;F&&F.playbackRate.linearRampToValueAtTime(s,t+.1);const i=(.1+(.25-.1)*n)*p.sfxVolume*e;if(_.gain.linearRampToValueAtTime(i,t+.1),x){const a=100+80*n;x.frequency.linearRampToValueAtTime(a,t+.1)}if(U.bandpass){const a=500+700*n;U.bandpass.frequency.linearRampToValueAtTime(a,t+.1)}}async function Ut(){try{return J=(await(await fetch("/api/playlist")).json()).tracks||[],console.log("[SoundManager] Playlist loaded:",J.length,"tracks"),J.length>0}catch(l){return console.warn("[SoundManager] Could not fetch playlist:",l),!1}}function Le(){tt()}function et(){if(!Q||te.length===0)return;const l=te[se],e=`/music/playlist/${encodeURIComponent(l)}`;console.log("[SoundManager] Playing track:",l,`(${se+1}/${te.length})`),L&&(L.pause(),L.removeEventListener("ended",Le)),L=new Audio(e),L.volume=p.musicVolume*p.masterVolume,L.addEventListener("ended",Le),L.play().catch(t=>{console.warn("[SoundManager] Could not play track:",t),tt()})}function tt(){Q&&(se++,se>=te.length&&(console.log("[SoundManager] All tracks played, reshuffling playlist"),te=Qe(J),se=0),et())}async function st(){if(!(!p.enabled||Q)){if(Q=!0,J.length===0&&!await Ut()){console.warn("[SoundManager] No tracks in playlist"),Q=!1;return}te=Qe(J),se=0,et(),console.log("[SoundManager] Background music started with",J.length,"tracks")}}function nt(){if(Q){if(Q=!1,L){L.removeEventListener("ended",Le);const l=L,e=setInterval(()=>{l.volume>.05?l.volume=Math.max(0,l.volume-.05):(clearInterval(e),l.pause())},30)}console.log("[SoundManager] Background music stopped")}}function it(){!p.enabled||he||(Q&&nt(),he=!0,B&&B.pause(),B=new Audio(vt),B.volume=p.musicVolume*p.masterVolume,B.loop=!0,B.play().catch(l=>{console.warn("[SoundManager] Could not play menu music:",l),he=!1}),console.log("[SoundManager] Menu music started"))}function at(){if(he){if(he=!1,B){const l=B,e=setInterval(()=>{l.volume>.05?l.volume=Math.max(0,l.volume-.05):(clearInterval(e),l.pause())},30)}console.log("[SoundManager] Menu music stopped")}}function ot(){const l=p.musicVolume*p.masterVolume;L&&(L.volume=l),B&&(B.volume=l)}const G=45,X=5,Z=M.CELL_WIDTH/2,Vt=M.DRONE_RADIUS,Ot=400,Be=65;class Se{constructor(e){this.num=e.num,this.name=e.name||"Player",this.x=e.x,this.y=e.y,this.angle=e.angle||0,this.serverX=e.x,this.serverY=e.y,this.serverAngle=e.angle||0,this.correctionX=0,this.correctionY=0,this.hp=e.hp||100,this.maxHp=e.maxHp||100,this.level=e.level||1,this.xp=e.xp||0,this.sizeScale=e.sizeScale||1,this.dead=e.dead||!1,this.isSnipped=e.isSnipped||!1,this.territory=e.territory||[],this.trail=e.trail||[],this.droneCount=e.droneCount!==void 0?e.droneCount:this.level,this.droneOrbitPhase=0,this.drones=[],e.base?this.base=new Y(e.base.hue,e.base.sat,e.base.lum):this.base=new Y(Math.random(),.8,.5)}update(e,t=!1){if(t&&e.x!==void 0&&e.y!==void 0){const n=e.x-this.x,s=e.y-this.y;this.correctionX+=n,this.correctionY+=s,Math.sqrt(n*n+s*s)>100&&(this.x=e.x,this.y=e.y,this.correctionX=0,this.correctionY=0)}e.x!==void 0&&(this.serverX=e.x),e.y!==void 0&&(this.serverY=e.y),e.angle!==void 0&&(this.serverAngle=e.angle),e.hp!==void 0&&(this.hp=e.hp),e.maxHp!==void 0&&(this.maxHp=e.maxHp),e.level!==void 0&&(this.level=e.level),e.xp!==void 0&&(this.xp=e.xp),e.sizeScale!==void 0&&(this.sizeScale=e.sizeScale),e.droneCount!==void 0?this.droneCount=e.droneCount:e.level!==void 0&&(this.droneCount=e.level),e.dead!==void 0&&(this.dead=e.dead),e.isSnipped!==void 0&&(this.isSnipped=e.isSnipped),e.territory!==void 0&&(this.territory=e.territory||[]),e.trail!==void 0&&(this.trail=e.trail||[])}updateDrones(e){const t=M.DRONE_ORBIT_RADIUS,n=M.DRONE_ORBIT_SPEED;for(this.droneOrbitPhase+=n*(e/1e3),this.droneOrbitPhase>Math.PI*2&&(this.droneOrbitPhase-=Math.PI*2);this.drones.length<this.droneCount;)this.drones.push({id:this.drones.length,x:this.x,y:this.y,targetId:null});for(;this.drones.length>this.droneCount;)this.drones.pop();for(let s=0;s<this.drones.length;s++){const i=this.drones[s],a=s/this.droneCount*Math.PI*2,o=this.droneOrbitPhase+a;i.x=this.x+Math.cos(o)*t,i.y=this.y+Math.sin(o)*t}}predict(e,t,n,s){this.x+=this.correctionX*.08,this.y+=this.correctionY*.08,this.correctionX*=1-.08,this.correctionY*=1-.08;let a=this.serverAngle-this.angle;for(;a>Math.PI;)a-=Math.PI*2;for(;a<-Math.PI;)a+=Math.PI*2;this.angle+=a*.03;const o=9*(e/1e3);let h=s-this.angle;for(;h>Math.PI;)h-=Math.PI*2;for(;h<-Math.PI;)h+=Math.PI*2;for(Math.abs(h)>o&&(h=Math.sign(h)*o),this.angle+=h;this.angle>Math.PI;)this.angle-=Math.PI*2;for(;this.angle<-Math.PI;)this.angle+=Math.PI*2;const r=t*(e/1e3)*60;this.x+=Math.cos(this.angle)*r,this.y+=Math.sin(this.angle)*r;const u=15;this.x=Math.max(u,Math.min(n-u,this.x)),this.y=Math.max(u,Math.min(n-u,this.y)),this.updateDrones(e)}interpolateOther(e,t){let n=this.serverAngle-this.angle;for(;n>Math.PI;)n-=Math.PI*2;for(;n<-Math.PI;)n+=Math.PI*2;const s=Math.min(1,.2*(e/16.67));for(this.angle+=n*s;this.angle>Math.PI;)this.angle-=Math.PI*2;for(;this.angle<-Math.PI;)this.angle+=Math.PI*2;const i=t*(e/1e3)*60;this.x+=Math.cos(this.angle)*i,this.y+=Math.sin(this.angle)*i;const a=this.serverX-this.x,o=this.serverY-this.y,h=Math.sqrt(a*a+o*o);if(h>200)this.x=this.serverX,this.y=this.serverY;else{const r=Math.min(.25,.05+h*.002);this.x+=a*r,this.y+=o*r}this.updateDrones(e)}}class Re{constructor(e){this.id=e.id,this.x=e.x,this.y=e.y,this.value=e.value||5}}class re{constructor(e,t,n,s="burst"){if(this.x=e,this.y=t,this.color=n,this.type=s,s==="burst"){const i=Math.random()*Math.PI*2,a=3+Math.random()*8;this.vx=Math.cos(i)*a,this.vy=Math.sin(i)*a,this.size=4+Math.random()*8,this.life=1,this.decay=.015+Math.random()*.02,this.rotation=Math.random()*Math.PI*2,this.rotationSpeed=(Math.random()-.5)*.3,this.gravity=.15}else if(s==="spark"){const i=Math.random()*Math.PI*2,a=8+Math.random()*12;this.vx=Math.cos(i)*a,this.vy=Math.sin(i)*a,this.size=2+Math.random()*3,this.life=1,this.decay=.04+Math.random()*.03,this.trail=[]}else if(s==="ring")this.radius=5,this.maxRadius=80+Math.random()*40,this.expandSpeed=4+Math.random()*2,this.life=1,this.decay=.025,this.lineWidth=8;else if(s==="shard"){const i=Math.random()*Math.PI*2,a=2+Math.random()*5;this.vx=Math.cos(i)*a,this.vy=Math.sin(i)*a,this.points=this.generateShardShape(),this.life=1,this.decay=.012+Math.random()*.01,this.rotation=Math.random()*Math.PI*2,this.rotationSpeed=(Math.random()-.5)*.15,this.gravity=.08}}generateShardShape(){const e=[],t=3+Math.floor(Math.random()*3),n=10+Math.random()*20;for(let s=0;s<t;s++){const i=s/t*Math.PI*2,a=n*(.5+Math.random()*.5);e.push({x:Math.cos(i)*a,y:Math.sin(i)*a})}return e}update(){return this.type==="burst"?(this.x+=this.vx,this.y+=this.vy,this.vy+=this.gravity,this.vx*=.98,this.rotation+=this.rotationSpeed,this.life-=this.decay):this.type==="spark"?(this.trail.push({x:this.x,y:this.y,life:this.life}),this.trail.length>8&&this.trail.shift(),this.x+=this.vx,this.y+=this.vy,this.vx*=.92,this.vy*=.92,this.life-=this.decay):this.type==="ring"?(this.radius+=this.expandSpeed,this.lineWidth*=.96,this.life-=this.decay):this.type==="shard"&&(this.x+=this.vx,this.y+=this.vy,this.vy+=this.gravity,this.rotation+=this.rotationSpeed,this.life-=this.decay),this.life>0}render(e){const t=Math.max(0,this.life);if(this.type==="burst")e.save(),e.translate(this.x,this.y),e.rotate(this.rotation),e.globalAlpha=t,e.fillStyle=this.color,e.fillRect(-this.size/2,-this.size/2,this.size,this.size),e.shadowColor=this.color,e.shadowBlur=10*t,e.fillRect(-this.size/2,-this.size/2,this.size,this.size),e.shadowBlur=0,e.restore();else if(this.type==="spark"){e.save(),e.beginPath(),e.moveTo(this.x,this.y);for(let n=this.trail.length-1;n>=0;n--){const s=this.trail[n];e.lineTo(s.x,s.y)}e.strokeStyle=this.color,e.lineWidth=this.size*t,e.globalAlpha=t*.6,e.stroke(),e.globalAlpha=t,e.fillStyle="#fff",e.beginPath(),e.arc(this.x,this.y,this.size*.8,0,Math.PI*2),e.fill(),e.restore()}else if(this.type==="ring")e.save(),e.beginPath(),e.arc(this.x,this.y,this.radius,0,Math.PI*2),e.strokeStyle=this.color,e.lineWidth=Math.max(1,this.lineWidth*t),e.globalAlpha=t*.7,e.stroke(),e.restore();else if(this.type==="shard"){e.save(),e.translate(this.x,this.y),e.rotate(this.rotation),e.globalAlpha=t*.8,e.beginPath(),e.moveTo(this.points[0].x,this.points[0].y);for(let n=1;n<this.points.length;n++)e.lineTo(this.points[n].x,this.points[n].y);e.closePath(),e.fillStyle=this.color,e.fill(),e.restore()}e.globalAlpha=1}}class xt{constructor(e,t,n,s,i){this.fromX=e,this.fromY=t,this.toX=n,this.toY=s,this.color=i,this.startTime=performance.now(),this.duration=100}isExpired(){return performance.now()-this.startTime>this.duration}getAlpha(){const e=performance.now()-this.startTime;return Math.max(0,1-e/this.duration)}}const Bt=1,Ge=40,Ce=10,Gt=120,Xt=.8;class qt{constructor(e,t,n,s,i){this.x=e,this.y=t,this.xpGained=n,this.player=s,this.isLocalPlayer=i,this.spawnTime=performance.now(),this.color=s?s.base:null,this.pulseRadius=Ce,this.pulseLife=1,this.particles=[];const a=i?Ge:Math.floor(Ge*.6);for(let o=0;o<a;o++){const h=Math.random()*Math.PI*2,r=2+Math.random()*6;this.particles.push({x:e,y:t,vx:Math.cos(h)*r,vy:Math.sin(h)*r,size:3+Math.random()*5,life:1,decay:.015+Math.random()*.02})}this.textY=t-20,this.textAlpha=1}easeOutQuad(e){return e*(2-e)}update(){const e=(performance.now()-this.spawnTime)/1e3,t=Math.min(1,e/Bt),n=Math.min(1,e/Xt);this.pulseRadius=Ce+(Gt-Ce)*this.easeOutQuad(n),this.pulseLife=1-n;for(const s of this.particles)s.x+=s.vx,s.y+=s.vy,s.vx*=.96,s.vy*=.96,s.vy+=.1,s.life-=s.decay;return this.textY-=.8,this.textAlpha=Math.max(0,1-t),t<1}render(e){const t=this.color?this.color.rgbString():"#FFD700",n=this.color?this.color.lighter(.3).rgbString():"#FFEC8B";this.pulseLife>0&&(e.save(),e.strokeStyle=this.color?this.color.deriveAlpha(this.pulseLife*.8).rgbString():`rgba(255, 215, 0, ${this.pulseLife*.8})`,e.lineWidth=4*this.pulseLife,e.beginPath(),e.arc(this.x,this.y,this.pulseRadius,0,Math.PI*2),e.stroke(),e.strokeStyle=this.color?this.color.deriveAlpha(this.pulseLife*.4).rgbString():`rgba(255, 255, 200, ${this.pulseLife*.4})`,e.lineWidth=8*this.pulseLife,e.beginPath(),e.arc(this.x,this.y,this.pulseRadius*.8,0,Math.PI*2),e.stroke(),e.restore());for(const s of this.particles)s.life<=0||(e.save(),e.globalAlpha=Math.max(0,s.life),e.fillStyle=n,e.shadowColor=t,e.shadowBlur=8*s.life,e.beginPath(),e.arc(s.x,s.y,s.size*s.life,0,Math.PI*2),e.fill(),e.restore());if(this.textAlpha>0&&this.xpGained>0){e.save(),e.globalAlpha=this.textAlpha,e.fillStyle="#9370DB",e.strokeStyle="rgba(0, 0, 0, 0.6)",e.lineWidth=3,e.font="bold 18px Changa",e.textAlign="center",e.textBaseline="middle";const s=`+${this.xpGained} XP`;e.strokeText(s,this.x,this.textY),e.fillText(s,this.x,this.textY),e.restore()}e.globalAlpha=1}}class rt{constructor(e,t={}){this.canvas=e,this.ctx=e.getContext("2d"),this.net=new St({url:t.wsUrl||"ws://localhost:8787/room/default",onStateChange:n=>this.handleStateChange(n),onInit:n=>this.handleInit(n),onFrame:n=>this.handleFrame(n),onEvent:n=>this.handleEvent(n),onError:n=>this.handleError(n)}),this.mapSize=0,this.playerId=null,this.players=new Map,this.coins=new Map,this.effects=[],this.cameraX=0,this.cameraY=0,this.cameraTargetX=0,this.cameraTargetY=0,this.cameraScale=1,this.mouseX=0,this.mouseY=0,this.targetAngle=0,this.mouseSet=!1,this.wasdKeys={w:!1,a:!1,s:!1,d:!1},this.useWasd=!1,this.wasdCurrentAngle=0,this.lastFrameTime=performance.now(),this.networkTickMs=100,this.interpolationDelay=this.networkTickMs,this.onDeath=t.onDeath||(()=>{}),this.onKill=t.onKill||(()=>{}),this.onLevelUp=t.onLevelUp||(()=>{}),this.debugMode=!1,this.lastNetworkUpdate=0,this.networkGaps=[],this.snipFuses=new Map,this._localSnippedPrev=!1,this.speedBuffState=new Map,this.speedSpikeState={active:!1,playerX:0,playerY:0,playerAngle:0,speedRatio:0,baseColor:null,pulsePhase:0},this.deathParticles=[],this.dyingPlayers=[],this.screenShake={x:0,y:0,intensity:0,decay:.92},this.captureEffects=[],this.localOutlineThicken={active:!1,startTime:0,duration:500},this.lastCleanupTime=0,this.cleanupIntervalMs=2e3,this.handleMouseMove=this.handleMouseMove.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),this.gameLoop=this.gameLoop.bind(this),this.setupInput()}startSnipFuse(e,t){const n=this.players.get(e);if(!n)return;const s=n.trail||[],i=t===65535,a=e===this.playerId;let o,h=0;if(s.length>=2){let r={x:n.x,y:n.y};if(!i){const c=this.players.get(t);c&&(r={x:c.x,y:c.y})}const u=this._furthestHitOnTrailByPos(r,s,i?3:0);o=u.point||{x:s[0].x,y:s[0].y},h=u.index>=0?u.index:0}else s.length===1?(o={x:s[0].x,y:s[0].y},h=0):(o={x:n.x,y:n.y},h=0);this.snipFuses.set(e,{playerNum:e,snipperNum:t,startPoint:o,segmentIndex:h,elapsed:0,progressDist:0,fusePos:{x:o.x,y:o.y},ratio:0,remainingPoints:null,isLocalVictim:a,sawSnipped:!1})}_closestPointOnTrail(e,t){let n={dist2:1/0,point:null,index:0};for(let s=0;s<t.length-1;s++){const i=t[s],a=t[s+1],o=this._closestPointOnSegment(e,i,a),h=e.x-o.x,r=e.y-o.y,u=h*h+r*r;u<n.dist2&&(n={dist2:u,point:o,index:s})}return n}_furthestHitOnTrailByPos(e,t,n=0){const s=M.CELL_WIDTH/2;let i={dist2:1/0,point:null,index:-1};const a=Math.max(0,t.length-1-n);for(let o=0;o<a;o++){const h=t[o],r=t[o+1],u=this._closestPointOnSegment(e,h,r),c=e.x-u.x,f=e.y-u.y,m=c*c+f*f;m<s*s&&o>i.index&&(i={dist2:m,point:u,index:o})}return i.point===null?this._closestPointOnTrail(e,t):i}_closestPointOnSegment(e,t,n){const s=n.x-t.x,i=n.y-t.y,a=e.x-t.x,o=e.y-t.y,h=s*s+i*i;if(h===0)return{x:t.x,y:t.y};let r=(a*s+o*i)/h;return r=Math.max(0,Math.min(1,r)),{x:t.x+s*r,y:t.y+i*r}}_pointAtDistance(e,t){if(e.length===0)return null;if(e.length===1)return{x:e[0].x,y:e[0].y};let n=t;for(let s=0;s<e.length-1;s++){const i=e[s],a=e[s+1],o=Math.hypot(a.x-i.x,a.y-i.y);if(!(o<=1e-4)){if(n<=o){const h=n/o;return{x:i.x+(a.x-i.x)*h,y:i.y+(a.y-i.y)*h}}n-=o}}return{x:e[e.length-1].x,y:e[e.length-1].y}}_pointAtDistanceWithIndex(e,t){if(e.length===0)return{point:null,index:0};if(e.length===1)return{point:{x:e[0].x,y:e[0].y},index:0};let n=t;for(let s=0;s<e.length-1;s++){const i=e[s],a=e[s+1],o=Math.hypot(a.x-i.x,a.y-i.y);if(!(o<=1e-4)){if(n<=o){const h=n/o;return{point:{x:i.x+(a.x-i.x)*h,y:i.y+(a.y-i.y)*h},index:s}}n-=o}}return{point:{x:e[e.length-1].x,y:e[e.length-1].y},index:e.length-2}}_sumLength(e){let t=0;for(let n=0;n<e.length-1;n++)t+=Math.hypot(e[n+1].x-e[n].x,e[n+1].y-e[n].y);return t}updateSnipFuses(e){const t=e/1e3;for(const[i,a]of Array.from(this.snipFuses.entries())){const o=this.players.get(i);if(!o){this.snipFuses.delete(i);continue}if(o.isSnipped&&(a.sawSnipped=!0),a.sawSnipped&&!o.isSnipped){this.snipFuses.delete(i);continue}if(a.elapsed>10){this.snipFuses.delete(i);continue}if(!o.trail||o.trail.length<2){a.elapsed+=t;continue}a.elapsed+=t;const h=M.SPEED,r=M.SNIP_FUSE_SPEED_MULT,u=M.SNIP_EXP_ACCEL_PER_SEC,c=M.SNIP_GRACE_PERIOD,f=Math.max(0,a.elapsed-c),m=h*r*60,g=Math.exp(u*f);let T=m*g;const y=M.SNIP_FUSE_MAX_SPEED_MULT;T=Math.min(T,h*y*60),a.elapsed>c&&(a.progressDist+=T*t);const S=Math.max(0,Math.min(o.trail.length-2,a.segmentIndex)),v=[a.startPoint,...o.trail.slice(S+1),{x:o.x,y:o.y}],b=this._sumLength(v),V=Math.max(1,b);a.ratio=Math.max(0,Math.min(1,a.progressDist/V));const w=this._pointAtDistanceWithIndex(v,Math.min(a.progressDist,V));a.fusePos=w.point;const R=v.slice(w.index+1);a.remainingPoints=[a.fusePos,...R]}const n=this.players.get(this.playerId),s=!!(n&&n.isSnipped);if(s&&!this._localSnippedPrev&&Rt(),!s&&this._localSnippedPrev&&Ct(),this._localSnippedPrev=s,s){const i=this.snipFuses.get(this.playerId);i&&kt(i.ratio)}if(n){let i=null,a=1/0;for(const[h,r]of this.snipFuses){if(h===this.playerId)continue;const u=this.players.get(h);if(!u||!(u.isSnipped||!r.sawSnipped))continue;const f=r.fusePos.x-n.x,m=r.fusePos.y-n.y,g=Math.sqrt(f*f+m*m);g<a&&(a=g,i=r)}const o=i!==null&&a<800;o&&!xe()?Dt():!o&&xe()&&Lt(),o&&Nt(a,800)}}setupInput(){this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),this.canvas.addEventListener("touchstart",this.handleTouchMove,{passive:!1}),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp)}cleanupInput(){this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("touchmove",this.handleTouchMove),this.canvas.removeEventListener("touchstart",this.handleTouchMove),window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp)}handleKeyDown(e){const t=document.activeElement,n=t&&t.tagName?t.tagName.toLowerCase():"";if(n==="input"||n==="textarea"||n==="select"||e.repeat)return;const s=(e.key||"").toLowerCase();if(e.key==="F3"){this.debugMode=!this.debugMode,console.log("Debug mode:",this.debugMode?"ON":"OFF");return}if(s==="r"){console.log("%cðŸ”„ RESETTING ROOM...","color: orange; font-weight: bold;"),this.net.sendReset();return}(s==="w"||s==="a"||s==="s"||s==="d")&&this.setKeyState(s,!0)}handleKeyUp(e){const t=(e.key||"").toLowerCase();(t==="w"||t==="a"||t==="s"||t==="d")&&this.setKeyState(t,!1)}setKeyState(e,t){const n=(e||"").toLowerCase();n in this.wasdKeys&&(this.wasdKeys[n]=!!t,this.useWasd=!!(this.wasdKeys.w||this.wasdKeys.a||this.wasdKeys.s||this.wasdKeys.d))}handleMouseMove(e){const t=this.canvas.getBoundingClientRect();this.mouseX=e.clientX-t.left,this.mouseY=e.clientY-t.top,this.mouseSet=!0,this.updateTargetAngle()}handleTouchMove(e){if(e.preventDefault(),e.touches.length>0){const t=this.canvas.getBoundingClientRect();this.mouseX=e.touches[0].clientX-t.left,this.mouseY=e.touches[0].clientY-t.top,this.mouseSet=!0,this.updateTargetAngle()}}updateTargetAngle(){const e=this.players.get(this.playerId);if(!e)return;const t=this.cameraX+(this.mouseX-this.canvas.width/2)/this.cameraScale,n=this.cameraY+(this.mouseY-this.canvas.height/2)/this.cameraScale;this.targetAngle=Math.atan2(n-e.y,t-e.x),this.useWasd||(this.wasdCurrentAngle=this.targetAngle)}connect(e){this.playerName=e,this.net.connect(e)}connectSpectate(){this.spectateMode=!0,this.net.connectSpectate()}disconnect(){this.net.disconnect(),this.stopGameLoop(),this.cleanupInput()}handleStateChange(e){console.log("Connection state:",e)}handleInit(e){this.playerId=e.playerId,this.mapSize=e.mapSize,this.players.clear(),this.coins.clear(),this.effects=[];for(const t of e.players)this.players.set(t.num,new Se(t));for(const t of e.coins)this.coins.set(t.id,new Re(t));if(this.spectateMode){this.cameraX=this.mapSize/2,this.cameraY=this.mapSize/2,this.cameraTargetX=this.mapSize/2,this.cameraTargetY=this.mapSize/2;const t=50;this.cameraScale=Math.min(this.canvas.width/(this.mapSize+t*2),this.canvas.height/(this.mapSize+t*2))}else{const t=this.players.get(this.playerId);t&&(this.cameraX=t.x,this.cameraY=t.y,this.cameraTargetX=t.x,this.cameraTargetY=t.y)}this.startGameLoop()}handleFrame(e){const t=performance.now();if(this.lastNetworkUpdate){const n=t-this.lastNetworkUpdate;this.networkGaps.push(n),this.networkGaps.length>20&&this.networkGaps.shift(),n>150&&this.debugMode&&console.warn(`[NET] Long gap between updates: ${n.toFixed(0)}ms`)}if(this.lastNetworkUpdate=t,e.selfPlayer){let n=this.players.get(e.selfPlayer.num);n?n.update(e.selfPlayer,!0):(n=new Se(e.selfPlayer),this.players.set(e.selfPlayer.num,n))}for(const n of e.newPlayers)this.players.has(n.num)||this.players.set(n.num,new Se(n));for(const n of e.updatedPlayers){const s=this.players.get(n.num);s&&s.update(n,!1)}this.coins.clear();for(const n of e.coins)this.coins.set(n.id,new Re(n));for(const n of e.events)this.handleEvent(n);for(const n of e.removedPlayerIds)this.players.delete(n),this.snipFuses.delete(n),this.speedBuffState.delete(n)}handleEvent(e){switch(e.type){case E.HITSCAN:this.addHitscanEffect(e);break;case E.PLAYER_KILL:{const t=this.players.get(e.victimNum),n=e.victimNum===this.playerId;t&&this.spawnDeathEffect(t,n),n?this.onDeath(e):e.killerNum===this.playerId&&this.onKill(e);break}case E.LEVEL_UP:e.playerNum===this.playerId&&this.onLevelUp(e);break;case E.PLAYER_JOIN:e.player&&!this.players.has(e.player.num)&&this.players.set(e.player.num,new Se(e.player));break;case E.PLAYER_LEAVE:this.players.delete(e.num);break;case E.COIN_SPAWN:this.coins.set(e.id,new Re(e));break;case E.COIN_PICKUP:this.coins.delete(e.id),e.playerNum===this.playerId&&It();break;case E.SNIP_START:this.startSnipFuse(e.playerNum,e.snipperNum);break;case E.CAPTURE:{const t=this.players.get(e.playerNum),n=e.playerNum===this.playerId;console.log("[CAPTURE] Event received:",e,"isLocal:",n,"player:",t),t&&this.spawnCaptureEffect(e.x,e.y,e.xpGained,t,n);break}case"dead":{const t=this.players.get(this.playerId);t&&this.spawnDeathEffect(t,!0),this.onDeath(e);break}}}addHitscanEffect(e){const t=this.players.get(e.ownerNum),n=this.players.get(e.targetNum);if(!t||!n)return;const s=t.base;let i=t.x,a=t.y;if(t.drones.length>0){const h=t.drones[Math.floor(Math.random()*t.drones.length)];i=h.x,a=h.y}this.effects.push(new xt(i,a,n.x,n.y,s));const o=this.players.get(this.playerId);if(o)if(e.ownerNum===this.playerId)Et();else{const h=Math.hypot(i-o.x,a-o.y);Pt(h)}}handleError(e){console.error("Network error:",e)}startGameLoop(){this.running=!0,this.lastFrameTime=performance.now(),requestAnimationFrame(this.gameLoop)}stopGameLoop(){this.running=!1}gameLoop(e){if(!this.running)return;const t=e-this.lastFrameTime;this.lastFrameTime=e,this.update(t),this.render(),this.net.flushInput(),requestAnimationFrame(this.gameLoop)}update(e){const t=this.players.get(this.playerId);if(!this.spectateMode&&t&&!t.dead){const s=this.computeInputAngle(t,e);typeof s=="number"&&Number.isFinite(s)&&(this.targetAngle=s,this.net.sendInput(this.targetAngle))}for(const[s,i]of this.players)!this.spectateMode&&s===this.playerId&&t&&!t.dead?i.predict(e,M.SPEED,this.mapSize,this.targetAngle):i.interpolateOther(e,M.SPEED);if(this.spectateMode){this.cameraX=this.mapSize/2,this.cameraY=this.mapSize/2;const s=50;this.cameraScale=Math.min(this.canvas.width/(this.mapSize+s*2),this.canvas.height/(this.mapSize+s*2))}else if(t){this.cameraTargetX=t.x,this.cameraTargetY=t.y;const s=.15;this.cameraX+=(this.cameraTargetX-this.cameraX)*s,this.cameraY+=(this.cameraTargetY-this.cameraY)*s}this.updateSnipFuses(e),this.updateSpeedBuffEffects(e),this.updateDeathEffects(),this.updateCaptureEffects(),this.effects=this.effects.filter(s=>!s.isExpired());const n=performance.now();n-this.lastCleanupTime>this.cleanupIntervalMs&&(this.lastCleanupTime=n,this.cleanupOrphanedState())}cleanupOrphanedState(){for(const[t,n]of Array.from(this.snipFuses.entries())){if(!this.players.get(t)){this.snipFuses.delete(t);continue}n.elapsed>5&&!n.sawSnipped&&this.snipFuses.delete(t)}for(const[t]of Array.from(this.speedBuffState.entries()))this.players.has(t)||this.speedBuffState.delete(t);for(const[,t]of this.players){if(t.dead){t.trail=[],t.territory=[];continue}if(t.trail&&t.trail.length>0&&!t.isSnipped){const n=t.trail[0],s=n.x-t.x,i=n.y-t.y;Math.sqrt(s*s+i*i)>500&&(t.trail=[])}if(t.territory&&t.territory.length>3){let n=0,s=0;for(const h of t.territory)n+=h.x,s+=h.y;n/=t.territory.length,s/=t.territory.length;const i=t.x-n,a=t.y-s;Math.sqrt(i*i+a*a)>1e3&&(t.territory=[])}}const e=performance.now()-5e3;this.dyingPlayers=this.dyingPlayers.filter(t=>t.deathTime>e)}calculateSpeedBuff(e){const t=M.TRAIL_SPEED_BUFF_MAX,n=M.TRAIL_SPEED_BUFF_RAMP_TIME,s=M.TRAIL_SPEED_BUFF_EASE,i=Math.min(1,e/n),a=Math.pow(i,s);return 1+(t-1)*a}pointInPolygon(e,t,n){if(!n||n.length<3)return!1;let s=!1;for(let i=0,a=n.length-1;i<n.length;a=i++){const o=n[i].x,h=n[i].y,r=n[a].x,u=n[a].y;h>t!=u>t&&e<(r-o)*(t-h)/(u-h)+o&&(s=!s)}return s}updateSpeedBuffEffects(e){const n=performance.now();for(const[i,a]of this.players){if(a.dead)continue;let o=this.speedBuffState.get(i);o||(o={trailStartTime:null,lastSpeedBuff:1,speedRushActive:!1},this.speedBuffState.set(i,o));const h=a.trail&&a.trail.length>0;if(a.isSnipped){o.trailStartTime=null,o.lastSpeedBuff=1,i===this.playerId&&o.speedRushActive&&(Ie(),o.speedRushActive=!1);continue}if(h){o.trailStartTime===null&&(o.trailStartTime=n);const u=(n-o.trailStartTime)/1e3,c=this.calculateSpeedBuff(u);o.lastSpeedBuff=c;const f=M.TRAIL_SPEED_BUFF_MAX;a._speedRatio=Math.min(1,Math.max(0,(c-1.1)/(f-1.1))),a._hasSpeedBuff=c>=1.1,i===this.playerId&&(c>=1.1?(o.speedRushActive||(_t(),o.speedRushActive=!0),Ft(c)):o.speedRushActive&&(Ie(),o.speedRushActive=!1))}else o.trailStartTime=null,o.lastSpeedBuff=1,a._speedRatio=0,a._hasSpeedBuff=!1,i===this.playerId&&o.speedRushActive&&(Ie(),o.speedRushActive=!1)}const s=this.players.get(this.playerId);if(s&&s._hasSpeedBuff){const i=6+(s._speedRatio||0)*8;this.speedSpikeState.pulsePhase+=i*(e/1e3),this.speedSpikeState.active=!0}else this.speedSpikeState.active=!1}spawnDeathEffect(e,t=!1){const n=e.x,s=e.y,i=e.base?e.base.rgbString():"#ff4444",a=e.base?e.base.lighter(.3).rgbString():"#ff8888",o=t?40:25;for(let r=0;r<o;r++)this.deathParticles.push(new re(n,s,i,"burst"));const h=t?20:12;for(let r=0;r<h;r++)this.deathParticles.push(new re(n,s,a,"spark"));if(this.deathParticles.push(new re(n,s,i,"ring")),t&&setTimeout(()=>{this.deathParticles.push(new re(n,s,a,"ring"))},100),e.territory&&e.territory.length>3){const r=t?15:8;for(let u=0;u<r;u++){const c=Math.floor(Math.random()*e.territory.length),f=e.territory[c];this.deathParticles.push(new re(f.x,f.y,i,"shard"))}}if(t&&(this.screenShake.intensity=25),this.dyingPlayers.push({num:e.num,x:e.x,y:e.y,angle:e.angle,color:e.base,sizeScale:e.sizeScale||1,territory:e.territory?[...e.territory]:[],trail:e.trail?[...e.trail]:[],deathTime:performance.now(),dissolveProgress:0}),t)Oe(!0);else{const r=this.players.get(this.playerId);if(r){const u=e.x-r.x,c=e.y-r.y,f=Math.sqrt(u*u+c*c);Oe(!1,f)}}}updateDeathEffects(){for(let t=this.deathParticles.length-1;t>=0;t--)this.deathParticles[t].update()||this.deathParticles.splice(t,1);this.screenShake.intensity>.5?(this.screenShake.x=(Math.random()-.5)*this.screenShake.intensity*2,this.screenShake.y=(Math.random()-.5)*this.screenShake.intensity*2,this.screenShake.intensity*=this.screenShake.decay):(this.screenShake.x=0,this.screenShake.y=0,this.screenShake.intensity=0);const e=performance.now();for(let t=this.dyingPlayers.length-1;t>=0;t--){const n=this.dyingPlayers[t];n.dissolveProgress=Math.min(1,(e-n.deathTime)/1500),n.dissolveProgress>=1&&this.dyingPlayers.splice(t,1)}}renderDeathParticles(e){for(const t of this.deathParticles)t.render(e)}spawnCaptureEffect(e,t,n,s,i){this.captureEffects.push(new qt(e,t,n,s,i)),i&&(this.localOutlineThicken.active=!0,this.localOutlineThicken.startTime=performance.now()),i&&At()}updateCaptureEffects(){for(let e=this.captureEffects.length-1;e>=0;e--)this.captureEffects[e].update()||this.captureEffects.splice(e,1);this.localOutlineThicken.active&&performance.now()-this.localOutlineThicken.startTime>=this.localOutlineThicken.duration&&(this.localOutlineThicken.active=!1)}renderCaptureEffects(e){for(const t of this.captureEffects)t.render(e)}getOutlineThickness(e){if(e===this.playerId&&this.localOutlineThicken.active){const t=performance.now()-this.localOutlineThicken.startTime;return 1+2*(1-Math.min(1,t/this.localOutlineThicken.duration))}return 1}getDissolveProgress(e){const t=this.dyingPlayers.find(n=>n.num===e);return t?t.dissolveProgress:0}renderDyingPlayers(e){for(const t of this.dyingPlayers){if(t.dissolveProgress>=1)continue;const n=Math.max(0,1-t.dissolveProgress),s=t.color;if(!s)continue;if(e.save(),e.globalAlpha=n,t.territory&&t.territory.length>=3){e.fillStyle=s.deriveAlpha(.4*n).rgbString(),e.beginPath(),e.moveTo(t.territory[0].x,t.territory[0].y);for(let h=1;h<t.territory.length;h++)e.lineTo(t.territory[h].x,t.territory[h].y);e.closePath(),e.fill(),e.strokeStyle=s.deriveAlpha(.9*n).rgbString(),e.lineWidth=2.5,e.stroke()}if(t.trail&&t.trail.length>=2){const h=s.lighter(.2);e.strokeStyle=h.deriveAlpha(n).rgbString(),e.lineWidth=Z,e.lineCap="round",e.lineJoin="round",e.beginPath(),e.moveTo(t.trail[0].x,t.trail[0].y);for(let r=1;r<t.trail.length;r++)e.lineTo(t.trail[r].x,t.trail[r].y);e.lineTo(t.x,t.y),e.stroke()}const i=Z*t.sizeScale;e.fillStyle=s.darker(.3).deriveAlpha(n).rgbString(),e.beginPath(),e.arc(t.x+2,t.y+4,i,0,Math.PI*2),e.fill(),e.fillStyle=s.deriveAlpha(n).rgbString(),e.beginPath(),e.arc(t.x,t.y,i,0,Math.PI*2),e.fill();const a=t.x+Math.cos(t.angle)*i*.6,o=t.y+Math.sin(t.angle)*i*.6;e.fillStyle=s.lighter(.1).deriveAlpha(n).rgbString(),e.beginPath(),e.arc(a,o,i*.3,0,Math.PI*2),e.fill(),e.restore()}}computeInputAngle(e,t){if(this.useWasd){let h=0,r=0;if(this.wasdKeys.w&&(r-=1),this.wasdKeys.s&&(r+=1),this.wasdKeys.a&&(h-=1),this.wasdKeys.d&&(h+=1),h===0&&r===0)return null;const u=Math.atan2(r,h);let c=u-this.wasdCurrentAngle;for(;c>Math.PI;)c-=Math.PI*2;for(;c<-Math.PI;)c+=Math.PI*2;const f=.15*(t/16.67);for(Math.abs(c)<=f?this.wasdCurrentAngle=u:this.wasdCurrentAngle+=Math.sign(c)*f;this.wasdCurrentAngle>Math.PI;)this.wasdCurrentAngle-=Math.PI*2;for(;this.wasdCurrentAngle<-Math.PI;)this.wasdCurrentAngle+=Math.PI*2;return this.wasdCurrentAngle}if(!this.mouseSet)return null;const n=this.cameraX+(this.mouseX-this.canvas.width/2)/this.cameraScale,s=this.cameraY+(this.mouseY-this.canvas.height/2)/this.cameraScale,i=n-e.x,a=s-e.y;if(i*i+a*a<100)return null;const o=Math.atan2(a,i);return this.wasdCurrentAngle=o,o}render(){const e=this.ctx,t=this.canvas.width,n=this.canvas.height,s=n-G;e.fillStyle="#e2ebf3",e.fillRect(0,0,t,n),e.save(),e.translate(0,G),e.beginPath(),e.rect(0,0,t,s),e.clip(),e.translate(t/2+this.screenShake.x,s/2+this.screenShake.y),e.scale(this.cameraScale,this.cameraScale),e.translate(-this.cameraX,-this.cameraY),this.drawGrid(e);const i=Array.from(this.players.values()).sort((a,o)=>a.num-o.num);for(const a of i)this.drawTerritory(e,a);for(const a of this.coins.values())this.drawCoin(e,a);for(const a of i)this.drawTrail(e,a);for(const a of i)!a.dead&&a._hasSpeedBuff&&this.drawSpeedSpikes(e,a);for(const a of i)a.dead||this.drawPlayer(e,a);this.renderDyingPlayers(e);for(const a of this.effects)this.drawHitscan(e,a);this.renderCaptureEffects(e),this.renderDeathParticles(e),e.restore(),this.drawTopBar(e),this.drawLeaderboard(e),this.drawXPBar(e),this.debugMode&&this.drawDebugHUD(e)}drawDebugHUD(e){let n=150;const s=16;e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(5,n-15,250,180),e.fillStyle="#00ff00",e.font="12px monospace",e.textAlign="left",e.fillText("=== DEBUG MODE (press D to toggle) ===",10,n),n+=s;let i=0,a=0,o=0;for(const[m,g]of this.players){if(m===this.playerId||g.dead)continue;const T=g.serverX-g.x,y=g.serverY-g.y,S=Math.sqrt(T*T+y*y);i+=S,a=Math.max(a,S),o++}const h=o>0?i/o:0;e.fillText(`Players: ${this.players.size} (${o} others)`,10,n),n+=s,e.fillText(`Avg position error: ${h.toFixed(1)}px`,10,n),n+=s,e.fillText(`Max position error: ${a.toFixed(1)}px`,10,n),n+=s;const r=this.networkGaps.length>0?this.networkGaps.reduce((m,g)=>m+g,0)/this.networkGaps.length:0,u=this.networkGaps.length>0?Math.max(...this.networkGaps):0,c=performance.now()-this.lastNetworkUpdate;e.fillText(`Net update gap: avg ${r.toFixed(0)}ms, max ${u.toFixed(0)}ms`,10,n),n+=s,e.fillStyle=c>150?"#ff0000":"#00ff00",e.fillText(`Time since last update: ${c.toFixed(0)}ms`,10,n),e.fillStyle="#00ff00",n+=s;const f=this.players.get(this.playerId);if(f){n+=s,e.fillStyle="#ffff00",e.fillText("--- Local Player ---",10,n),n+=s,e.fillStyle="#00ff00",e.fillText(`Pos: (${f.x.toFixed(1)}, ${f.y.toFixed(1)})`,10,n),n+=s,e.fillText(`Server: (${f.serverX.toFixed(1)}, ${f.serverY.toFixed(1)})`,10,n),n+=s;const m=Math.sqrt(Math.pow(f.serverX-f.x,2)+Math.pow(f.serverY-f.y,2));e.fillText(`Correction offset: ${m.toFixed(1)}px`,10,n)}}drawGrid(e){const t=this.mapSize,n=M.BORDER_WIDTH;e.fillStyle="rgb(211, 225, 237)",e.fillRect(0,0,t,t),e.strokeStyle="rgba(180, 200, 220, 0.5)",e.lineWidth=1;const s=M.CELL_WIDTH*2;e.beginPath();for(let i=0;i<=t;i+=s)e.moveTo(i,0),e.lineTo(i,t);for(let i=0;i<=t;i+=s)e.moveTo(0,i),e.lineTo(t,i);e.stroke(),e.fillStyle="lightgray",e.fillRect(-n,0,n,t),e.fillRect(-n,-n,t+n*2,n),e.fillRect(t,0,n,t),e.fillRect(-n,t,t+n*2,n)}drawTerritory(e,t){if(!t.territory||t.territory.length<3)return;const n=t.base,s=t.isSnipped;let i=1;if(s){const o=Date.now()/100;i=.3+.5*(.5+.5*Math.sin(o*4))}e.fillStyle=n.deriveAlpha(.4*i).rgbString(),e.beginPath(),e.moveTo(t.territory[0].x,t.territory[0].y);for(let o=1;o<t.territory.length;o++)e.lineTo(t.territory[o].x,t.territory[o].y);e.closePath(),e.fill();const a=this.getOutlineThickness(t.num);e.strokeStyle=n.deriveAlpha(.9*i).rgbString(),e.lineWidth=2.5*a,e.lineJoin="round",e.lineCap="round",e.stroke()}drawTrail(e,t){if(!t.trail||t.trail.length<1)return;const s=t.base.lighter(.2);e.strokeStyle=s.rgbString(),e.lineWidth=Z,e.lineCap="round",e.lineJoin="round";const i=t.x,a=t.y,o=this.snipFuses.get(t.num);if(o&&(t.isSnipped||!o.sawSnipped)){if(o.remainingPoints&&o.remainingPoints.length>=2&&o.fusePos){e.beginPath(),e.moveTo(o.remainingPoints[0].x,o.remainingPoints[0].y);for(let r=1;r<o.remainingPoints.length;r++)e.lineTo(o.remainingPoints[r].x,o.remainingPoints[r].y);e.stroke(),this._drawFuseSpark(e,o.fusePos,o.remainingPoints,t.num);return}if(t.trail&&t.trail.length>=1){const r=M.SPEED,u=M.SNIP_FUSE_SPEED_MULT,f=r*u*60*o.elapsed,m=[...t.trail,{x:t.x,y:t.y}],g=this._sumLength(m),T=Math.min(f,g),y=this._pointAtDistanceWithIndex(m,T);if(y.point){const S=m.slice(y.index+1),v=[y.point,...S];if(v.length>=2){e.beginPath(),e.moveTo(v[0].x,v[0].y);for(let b=1;b<v.length;b++)e.lineTo(v[b].x,v[b].y);e.stroke(),this._drawFuseSpark(e,y.point,v,t.num);return}}}if(t.trail&&t.trail.length>=1){const r={x:t.trail[0].x,y:t.trail[0].y};e.beginPath(),e.moveTo(t.trail[0].x,t.trail[0].y);for(let u=1;u<t.trail.length;u++)e.lineTo(t.trail[u].x,t.trail[u].y);e.lineTo(i,a),e.stroke(),this._drawFuseSpark(e,r,t.trail,t.num);return}}e.beginPath(),e.moveTo(t.trail[0].x,t.trail[0].y);for(let r=1;r<t.trail.length-1;r++)e.lineTo(t.trail[r].x,t.trail[r].y);if(t.trail.length>1){const r=t.trail[t.trail.length-1];if(Math.hypot(r.x-i,r.y-a)>Z*2){const c=r.x+(i-r.x)*.5,f=r.y+(a-r.y)*.5;e.lineTo(c,f)}}e.lineTo(i,a),e.stroke()}_sparkDirection(e){if(!e||e.length<2)return 0;const t=e[0],n=e[1];return Math.atan2(n.y-t.y,n.x-t.x)}_drawFuseSpark(e,t,n,s){const i=performance.now(),a=.75+.25*Math.sin(i*.02+s),o=Z*.6*a;e.save(),e.globalCompositeOperation="lighter";const h=e.createRadialGradient(t.x,t.y,0,t.x,t.y,o*2);h.addColorStop(0,"rgba(255,255,200,0.95)"),h.addColorStop(.35,"rgba(255,180,60,0.65)"),h.addColorStop(1,"rgba(255,40,0,0)"),e.fillStyle=h,e.beginPath(),e.arc(t.x,t.y,o*2,0,Math.PI*2),e.fill();const r=this._sparkDirection(n);for(let u=0;u<6;u++){const c=(u*.9+i*.03+s)%(Math.PI*2),f=r+Math.sin(c)*.7,m=o*2.2*(.4+.6*((Math.sin(c*1.7)+1)*.5)),g=t.x+Math.cos(f)*m,T=t.y+Math.sin(f)*m;e.strokeStyle="rgba(255,200,80,0.9)",e.lineWidth=2,e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(g,T),e.stroke()}e.restore()}drawSpeedSpikes(e,t){const n=t._speedRatio||0;if(n<=0)return;const s=t.x,i=t.y,a=t.angle,o=t.base,h=this.speedSpikeState.pulsePhase,r=3+Math.floor(n*2),u=.8+n*.6,c=18+n*25,f=8+n*6,m=12,g=o.lighter(.3).rgbString(),T=o.rgbString();e.save();for(let y=0;y<r;y++){const S=r>1?y/(r-1)-.5:0,v=a+Math.PI+S*u,b=y/r*Math.PI*2,w=.4+(Math.sin(h+b)*.5+.5)*.6,R=c*w,H=f*w;if(R<3)continue;const ie=s+Math.cos(v)*m,ae=i+Math.sin(v)*m,Ee=ie+Math.cos(v)*R,Pe=ae+Math.sin(v)*R,me=v+Math.PI/2,ge=H/2,_e=(.6+n*.3)*(.6+w*.4);e.globalAlpha=_e;const ye=e.createLinearGradient(ie,ae,Ee,Pe);ye.addColorStop(0,g),ye.addColorStop(.4,T),ye.addColorStop(1,"rgba(0, 0, 0, 0)"),e.fillStyle=ye,e.beginPath(),e.moveTo(ie+Math.cos(me)*ge,ae+Math.sin(me)*ge),e.lineTo(ie-Math.cos(me)*ge,ae-Math.sin(me)*ge),e.lineTo(Ee,Pe),e.closePath(),e.fill(),e.globalAlpha=_e*.7,e.strokeStyle=g,e.lineWidth=Math.max(1,H*.25),e.lineCap="round",e.beginPath(),e.moveTo(ie,ae),e.lineTo(Ee,Pe),e.stroke()}e.restore()}drawCoin(e,t){const n=M.COIN_RADIUS;e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.arc(t.x+2,t.y+2,n,0,Math.PI*2),e.fill(),e.fillStyle="#FFD700",e.shadowBlur=5,e.shadowColor="rgba(0, 0, 0, 0.3)",e.beginPath(),e.arc(t.x,t.y,n,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="rgba(255, 255, 255, 0.6)",e.beginPath(),e.arc(t.x-n*.3,t.y-n*.3,n*.3,0,Math.PI*2),e.fill()}drawPlayer(e,t){const n=Z*(t.sizeScale||1),s=t.base,i=s.darker(.3),a=s.lighter(.1),o=t.isSnipped;let h=1;if(o){const c=Date.now()/100;h=.3+.5*(.5+.5*Math.sin(c*4))}for(const c of t.drones)this.drawDrone(e,c,s,t);if(e.fillStyle=i.deriveAlpha(h).rgbString(),e.beginPath(),e.arc(t.x+2,t.y+4,n,0,Math.PI*2),e.fill(),o){const c=.5+.5*Math.sin(Date.now()/100*4);e.fillStyle=`rgba(255, ${Math.floor(100*c)}, ${Math.floor(100*c)}, ${h})`}else e.fillStyle=s.rgbString();if(e.beginPath(),e.arc(t.x,t.y,n,0,Math.PI*2),e.fill(),o){const c=.5+.5*Math.sin(Date.now()/100*6);e.strokeStyle=`rgba(255, 50, 50, ${.5+.5*c})`,e.lineWidth=3+2*c,e.beginPath(),e.arc(t.x,t.y,n+4+2*c,0,Math.PI*2),e.stroke()}const r=t.x+Math.cos(t.angle)*n*.6,u=t.y+Math.sin(t.angle)*n*.6;if(e.fillStyle=a.deriveAlpha(h).rgbString(),e.beginPath(),e.arc(r,u,n*.3,0,Math.PI*2),e.fill(),t.hp<t.maxHp){const c=n*2.5,f=6*(t.sizeScale||1),m=t.x-c/2,g=t.y+n+8;e.fillStyle="rgba(20, 20, 20, 0.8)",e.fillRect(m,g,c,f);const T=Math.max(0,t.hp/t.maxHp);T>.5?e.fillStyle="#44ff44":T>.25?e.fillStyle="#ffcc00":e.fillStyle="#ff4444",e.fillRect(m,g,c*T,f),e.strokeStyle="rgba(0, 0, 0, 0.8)",e.lineWidth=Math.max(1,1.5*(t.sizeScale||1));for(let y=1;y<=3;y++){const S=m+c*y/4;e.beginPath(),e.moveTo(S,g),e.lineTo(S,g+f),e.stroke()}e.strokeStyle="#000000",e.lineWidth=Math.max(1,2*(t.sizeScale||1)),e.strokeRect(m,g,c,f)}if(e.fillStyle=i.rgbString(),e.textAlign="center",e.font="bold 14px Arial",o&&(e.fillStyle="rgba(255, 50, 50, 1)",e.fillText("SNIPPED!",t.x,t.y-n-22),e.fillStyle=i.deriveAlpha(h).rgbString()),e.fillText(t.name,t.x,t.y-n-8),this.debugMode&&t.num!==this.playerId){e.strokeStyle="rgba(0, 255, 0, 0.8)",e.lineWidth=2,e.beginPath(),e.arc(t.serverX,t.serverY,n+5,0,Math.PI*2),e.stroke();const c=t.serverX-t.x,f=t.serverY-t.y,m=Math.sqrt(c*c+f*f);m>1&&(e.strokeStyle="rgba(255, 0, 0, 0.8)",e.lineWidth=2,e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(t.serverX,t.serverY),e.stroke()),e.strokeStyle="rgba(0, 100, 255, 0.8)",e.lineWidth=2,e.beginPath(),e.moveTo(t.serverX,t.serverY),e.lineTo(t.serverX+Math.cos(t.serverAngle)*40,t.serverY+Math.sin(t.serverAngle)*40),e.stroke(),e.fillStyle="rgba(255, 255, 0, 1)",e.font="10px monospace",e.fillText(`err: ${m.toFixed(1)}px`,t.x,t.y+n+25)}}drawDrone(e,t,n,s){const i=Vt,a=s&&s.isSnipped,o=s&&s.num===this.playerId;if(e.save(),e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.arc(t.x+2,t.y+2,i,0,Math.PI*2),e.fill(),t.targetId!==null&&!a){const h=Date.now()/150,r=.4+.3*Math.sin(h*4);e.shadowBlur=12*r,e.shadowColor=o?"#FFD700":n?n.rgbString():"#FF6600"}if(a?e.fillStyle="rgba(100, 100, 100, 0.5)":n?e.fillStyle=n.deriveAlpha(o?.95:.8).rgbString():e.fillStyle=o?"rgba(100, 200, 100, 0.95)":"rgba(200, 100, 100, 0.8)",e.beginPath(),e.arc(t.x,t.y,i,0,Math.PI*2),e.fill(),a?e.strokeStyle="rgba(60, 60, 60, 0.6)":e.strokeStyle=n?n.darker(.2).rgbString():"#444",e.lineWidth=2,e.stroke(),e.shadowBlur=0,a?e.fillStyle="rgba(80, 80, 80, 0.4)":e.fillStyle=n?n.lighter(.3).deriveAlpha(.7).rgbString():"rgba(255, 255, 255, 0.5)",e.beginPath(),e.arc(t.x-i*.25,t.y-i*.25,i*.35,0,Math.PI*2),e.fill(),t.targetId!==null&&!a){const h=Date.now()/100,r=.5+.5*Math.sin(h*5);e.fillStyle=`rgba(255, 100, 100, ${.6+.4*r})`,e.beginPath(),e.arc(t.x,t.y,i*.3,0,Math.PI*2),e.fill()}if(a){e.strokeStyle="rgba(255, 80, 80, 0.8)",e.lineWidth=2,e.lineCap="round";const h=i*.5;e.beginPath(),e.moveTo(t.x-h,t.y-h),e.lineTo(t.x+h,t.y+h),e.moveTo(t.x+h,t.y-h),e.lineTo(t.x-h,t.y+h),e.stroke()}e.restore()}drawHitscan(e,t){const n=t.getAlpha(),s=t.color;e.save(),e.lineCap="round",e.lineWidth=12*n,e.strokeStyle=s.deriveAlpha(.5*n).rgbString(),e.beginPath(),e.moveTo(t.fromX,t.fromY),e.lineTo(t.toX,t.toY),e.stroke(),e.lineWidth=5*n,e.strokeStyle=s.lighter(.4).deriveAlpha(.95*n).rgbString(),e.beginPath(),e.moveTo(t.fromX,t.fromY),e.lineTo(t.toX,t.toY),e.stroke(),e.lineWidth=2*n,e.strokeStyle=`rgba(255, 255, 255, ${n})`,e.beginPath(),e.moveTo(t.fromX,t.fromY),e.lineTo(t.toX,t.toY),e.stroke();const i=20*n,a=e.createRadialGradient(t.toX,t.toY,0,t.toX,t.toY,i);a.addColorStop(0,s.lighter(.6).deriveAlpha(n).rgbString()),a.addColorStop(.4,s.deriveAlpha(.6*n).rgbString()),a.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=a,e.beginPath(),e.arc(t.toX,t.toY,i,0,Math.PI*2),e.fill(),e.restore()}drawTopBar(e){const t=this.players.get(this.playerId);if(!t)return;e.fillStyle="#3a3a3a",e.fillRect(0,0,this.canvas.width,G),e.textAlign="left",e.textBaseline="alphabetic";const n=t.level||1;t.drones&&t.drones.length;let s=15;const i=G/2+6;e.fillStyle="#88CCFF",e.font="bold 16px Arial",e.fillText("RTT:",s,i),s+=e.measureText("RTT:").width+5,e.fillStyle="white",e.fillText(`${Math.round(this.net.getRTT())}ms`,s,i),s+=e.measureText(`${Math.round(this.net.getRTT())}ms`).width+20,e.fillStyle="#FFD700",e.font="bold 16px Arial",e.fillText("Level:",s,i),s+=e.measureText("Level:").width+5,e.fillStyle="white",e.fillText(n,s,i),s+=e.measureText(String(n)).width+20,e.fillStyle="#FF6B6B",e.font="bold 16px Arial",e.fillText("HP:",s,i),s+=e.measureText("HP:").width+5,e.fillStyle="white",e.fillText(`${Math.round(t.hp)}/${t.maxHp}`,s,i),s+=e.measureText(`${Math.round(t.hp)}/${t.maxHp}`).width+20,e.fillStyle="#9370DB",e.font="bold 16px Arial",e.fillText("XP:",s,i),s+=e.measureText("XP:").width+5,e.fillStyle="white",e.fillText(t.xp,s,i)}drawLeaderboard(e){const t=Array.from(this.players.values()).filter(s=>!s.dead).sort((s,i)=>i.level-s.level||i.xp-s.xp),n=Math.min(M.LEADERBOARD_NUM,t.length);e.font="18px Arial",e.textAlign="left";for(let s=0;s<n;s++){const i=t[s],a=i.name||"Unnamed",o=i.base,h=o.darker(.3),r=1-s/n,u=Math.ceil((Ot-Be)*r+Be),c=this.canvas.width-u,f=G*(s+1),m=s===0?10:0;e.fillStyle="rgba(10, 10, 10, 0.3)",e.fillRect(c-10,f+10-m,u+10,G+m),e.fillStyle=o.rgbString(),e.fillRect(c,f,u,G-X),e.fillStyle=h.rgbString(),e.fillRect(c,f+G-X,u,X);const g=e.measureText(a).width;e.fillStyle="black",e.fillText(a,c-g-15,f+27);const T=i.num===this.playerId;e.fillStyle=T?"#FFD700":"white",e.fillText(`Lv.${i.level}`,c+5,f+G-15)}}drawXPBar(e){const t=this.players.get(this.playerId);if(!t)return;const n=t.level||1,s=t.xp||0,i=M.XP_BASE_PER_LEVEL+(n-1)*M.XP_INCREMENT_PER_LEVEL,a=250,o=28,h=(this.canvas.width-a)/2,r=this.canvas.height-45,u=Math.min(1,s/i),c=t.base,f=c.darker(.3);if(e.fillStyle="rgba(10, 10, 10, 0.5)",e.fillRect(h-60,r-2,a+70,o+4),e.font="bold 18px Arial",e.fillStyle="#FFD700",e.textAlign="left",e.fillText(`Lv.${n}`,h-55,r+o-8),e.fillStyle="rgba(60, 60, 60, 0.8)",e.fillRect(h,r,a,o-X),e.fillStyle="rgba(40, 40, 40, 0.8)",e.fillRect(h,r+o-X,a,X),u>0){const m=a*u;e.fillStyle=c.rgbString(),e.fillRect(h,r,m,o-X),e.fillStyle=f.rgbString(),e.fillRect(h,r+o-X,m,X)}e.font="16px Arial",e.fillStyle="white",e.textAlign="center",e.fillText(`${Math.floor(s)}/${i} XP`,h+a/2,r+o-9)}getSelfPlayer(){return this.players.get(this.playerId)}resize(e,t){this.canvas.width=e,this.canvas.height=t}}let $,ne,K,j,ce,Te,le,Ne,P,lt,ht,ct,ve,ut,Me,Xe,ee,qe,Ye,ze,we=0,pe=1;const dt="swarmblitz.audio.v1";function Yt(){try{const l=localStorage.getItem(dt);if(!l)return null;const e=JSON.parse(l);return e&&typeof e=="object"?e:null}catch{return null}}function ke(){try{const l=Ve?Ve():null;if(!l)return;localStorage.setItem(dt,JSON.stringify(l))}catch{}}function zt(){const l=document.getElementById("vol-master"),e=document.getElementById("vol-music"),t=document.getElementById("vol-sfx"),n=document.getElementById("vol-master-val"),s=document.getElementById("vol-music-val"),i=document.getElementById("vol-sfx-val");l&&n&&(n.textContent=`${l.value}%`),e&&s&&(s.textContent=`${e.value}%`),t&&i&&(i.textContent=`${t.value}%`)}function Ht(){const l=Yt();if(!l)return;typeof l.masterVolume=="number"&&je(l.masterVolume),typeof l.musicVolume=="number"&&Je(l.musicVolume),typeof l.sfxVolume=="number"&&Ze(l.sfxVolume),l.volumes&&typeof l.volumes=="object"&&wt(l.volumes),typeof l.enabled=="boolean"&&bt(l.enabled);const e=document.getElementById("vol-master"),t=document.getElementById("vol-music"),n=document.getElementById("vol-sfx");e&&typeof l.masterVolume=="number"&&(e.value=String(Math.round(l.masterVolume*100))),t&&typeof l.musicVolume=="number"&&(t.value=String(Math.round(l.musicVolume*100))),n&&typeof l.sfxVolume=="number"&&(n.value=String(Math.round(l.sfxVolume*100))),zt()}function ue(){Mt(),z(),ne&&ne.style.display!=="none"&&it()}function He(){$=document.getElementById("main-ui"),ne=document.getElementById("begin"),K=document.getElementById("wasted"),j=document.getElementById("settings"),ce=document.getElementById("name"),Te=document.querySelector(".start.start-btn.primary"),le=document.querySelector(".spectate.start-btn.secondary"),Ne=document.getElementById("error"),lt=document.getElementById("death-score"),ht=document.getElementById("death-kills"),ct=document.getElementById("death-level"),ve=document.getElementById("death-killer-info"),ut=document.getElementById("death-killer-name"),Me=K.querySelector(".start.orange"),Xe=K.querySelector(".menu.yellow"),ee=K.querySelector(".spectate.green"),qe=document.querySelector(".toggle.yellow"),Ye=document.getElementById("settings-close"),ze=document.getElementById("settings-menu-btn"),We(),window.addEventListener("resize",We),Te.addEventListener("click",De),ce.addEventListener("keypress",t=>{t.key==="Enter"&&!Te.disabled&&De()}),console.log("[INIT] spectateButton:",le),console.log("[INIT] spectateDeathButton:",ee),le?le.addEventListener("click",()=>{console.log("[CLICK] Spectate button clicked!"),Ke()}):console.error("[INIT] spectateButton not found!"),ee?ee.addEventListener("click",()=>{console.log("[CLICK] Spectate death button clicked!"),Ke()}):console.error("[INIT] spectateDeathButton not found!"),Me.addEventListener("click",De),Xe.addEventListener("click",$e),qe.addEventListener("click",Kt),Ye.addEventListener("click",()=>{j.style.display="none"}),ze.addEventListener("click",()=>{j.style.display="none",$e()});const l=document.getElementById("how-to-play-toggle"),e=document.getElementById("how-to-play-content");l&&e&&l.addEventListener("click",()=>{const t=e.style.display!=="none";e.style.display=t?"none":"block",l.classList.toggle("expanded",!t)}),Wt(),Ht(),document.addEventListener("pointerdown",ue,{once:!0}),document.addEventListener("touchstart",ue,{once:!0,passive:!0}),document.addEventListener("keydown",ue,{once:!0}),$t(),ce.focus()}function Wt(){const l=document.getElementById("vol-master"),e=document.getElementById("vol-music"),t=document.getElementById("vol-sfx"),n=document.getElementById("vol-master-val"),s=document.getElementById("vol-music-val"),i=document.getElementById("vol-sfx-val");l&&n&&l.addEventListener("input",()=>{n.textContent=`${l.value}%`,je(parseInt(l.value,10)/100),ke()}),e&&s&&e.addEventListener("input",()=>{s.textContent=`${e.value}%`,Je(parseInt(e.value,10)/100),ke()}),t&&i&&t.addEventListener("input",()=>{i.textContent=`${t.value}%`,Ze(parseInt(t.value,10)/100),ke()})}function $t(){Te.disabled=!1,le.disabled=!1,Me.disabled=!1,ee.disabled=!1,Ne.textContent="Ready to play!",Ne.style.color="#4caf50"}function We(){$&&($.width=window.innerWidth,$.height=window.innerHeight,P&&P.resize($.width,$.height))}function Kt(){const l=j.style.display!=="none";j.style.display=l?"none":"block"}function $e(){P&&(P.disconnect(),P=null),K.style.display="none",j.style.display="none",ne.style.display="flex",ce.focus(),we=0,pe=1,nt(),it()}function De(){const l=ce.value.trim()||"Player";ue(),ne.style.display="none",K.style.display="none",j.style.display="none",we=0,pe=1,at(),st();const e=window.location.search.includes("prod");let t;e?(t="wss://swarmblitz.dev-1dd.workers.dev/room/default",console.log("%câ˜ï¸ CONNECTING TO PRODUCTION SERVER","background: #4caf50; color: white; font-size: 16px; padding: 4px 8px;")):(t="ws://localhost:8787/room/default",console.log("%cðŸ”§ CONNECTING TO LOCAL SERVER","background: #ff9800; color: black; font-size: 16px; padding: 4px 8px;")),console.log("WebSocket URL:",t),P=new rt($,{wsUrl:t,onDeath:ft,onKill:pt,onLevelUp:mt}),P.connect(l)}function Ke(){console.log("[SPECTATE] startSpectate() called"),ue(),console.log("[SPECTATE] Hiding screens..."),ne.style.display="none",K.style.display="none",j.style.display="none",at(),st();const l=window.location.search.includes("prod");let e;l?(e="wss://swarmblitz.dev-1dd.workers.dev/room/default",console.log("%cðŸ‘ SPECTATING PRODUCTION SERVER","background: #9c27b0; color: white; font-size: 16px; padding: 4px 8px;")):(e="ws://localhost:8787/room/default",console.log("%cðŸ‘ SPECTATING LOCAL SERVER","background: #9c27b0; color: white; font-size: 16px; padding: 4px 8px;")),console.log("[SPECTATE] wsUrl:",e),console.log("[SPECTATE] Creating GameClient..."),P=new rt($,{wsUrl:e,spectateMode:!0,onDeath:ft,onKill:pt,onLevelUp:mt}),console.log("[SPECTATE] GameClient created:",P),console.log("[SPECTATE] Calling connectSpectate()..."),P.connectSpectate(),console.log("[SPECTATE] connectSpectate() called")}function ft(l){console.log("You died!",l);const e=P?P.getSelfPlayer():null,t=e?e.level:pe,n="0.00%";if(lt.textContent=n,ht.textContent=we.toString(),ct.textContent=t.toString(),l.killerNum!==void 0&&l.killerNum!==65535){const s=P?P.players.get(l.killerNum):null;s?(ut.textContent=s.name,ve.style.display="block"):ve.style.display="none"}else ve.style.display="none";setTimeout(()=>{P&&(P.disconnect(),P=null),Me.disabled=!1,ee.disabled=!1,K.style.display="flex"},1500)}function pt(l){console.log("You killed someone!",l),we++}function mt(l){console.log("Level up!",l),l.newLevel>pe&&(pe=l.newLevel)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",He):He();window.getGameClient=()=>P;
