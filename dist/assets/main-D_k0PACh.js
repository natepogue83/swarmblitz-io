(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const le={INPUT:2,PING:3,FRAME:18,DEAD:19,PONG:20},$={POSITION:1,ANGLE:2,HP:4,XP:8,LEVEL:16,DRONES:32,TERRITORY:64,TRAIL:128},I={PLAYER_JOIN:1,PLAYER_LEAVE:2,PLAYER_KILL:3,COIN_SPAWN:4,COIN_PICKUP:5,HITSCAN:6,CAPTURE:7,LEVEL_UP:8,SNIP_START:9},we={POS_MAX:65535,ANGLE_MAX:255,ANGLE_SCALE:65535,HP_MAX:255};function R(h,e){return h/we.POS_MAX*e}function Ue(h){return h/we.ANGLE_MAX*Math.PI*2}function Oe(h,e){return h/we.HP_MAX*e}function yt(h){const e=h>>8&255,t=h>>4&15,n=h&15;return{hue:e/255,sat:t/15,lum:n/15}}class St{constructor(e){this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.view=new DataView(this.buffer),this.offset=0}readU8(){return this.view.getUint8(this.offset++)}readU16(){const e=this.view.getUint16(this.offset,!0);return this.offset+=2,e}readU32(){const e=this.view.getUint32(this.offset,!0);return this.offset+=4,e}readI8(){return this.view.getInt8(this.offset++)}readI16(){const e=this.view.getInt16(this.offset,!0);return this.offset+=2,e}readF32(){const e=this.view.getFloat32(this.offset,!0);return this.offset+=4,e}readString(){const e=this.readU8(),t=new Uint8Array(this.buffer,this.offset,e);return this.offset+=e,new TextDecoder().decode(t)}readBytes(e){const t=new Uint8Array(this.buffer,this.offset,e);return this.offset+=e,t}hasMore(){return this.offset<this.buffer.byteLength}}const k={DISCONNECTED:0,CONNECTING:1,CONNECTED:2,RECONNECTING:3};class Tt{constructor(e={}){this.url=e.url||"ws://localhost:8787/room/default",this.reconnectDelay=e.reconnectDelay||1e3,this.maxReconnectDelay=e.maxReconnectDelay||3e4,this.inputThrottleMs=e.inputThrottleMs||50,this.ws=null,this.state=k.DISCONNECTED,this.reconnectAttempts=0,this.playerId=null,this.mapSize=0,this.rtt=0,this.lastPingTime=0,this.pingInterval=null,this.lastInputTime=0,this.pendingAngle=null,this.onStateChange=e.onStateChange||(()=>{}),this.onInit=e.onInit||(()=>{}),this.onFrame=e.onFrame||(()=>{}),this.onEvent=e.onEvent||(()=>{}),this.onError=e.onError||(()=>{}),this.onReset=e.onReset||(()=>{})}connect(e){if(this.state===k.DISCONNECTED){this.playerName=e,this.isSpectator=!1,this.setState(k.CONNECTING);try{this.ws=new WebSocket(this.url),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>this.handleOpen(),this.ws.onmessage=t=>this.handleMessage(t),this.ws.onclose=t=>this.handleClose(t),this.ws.onerror=t=>this.handleError(t)}catch(t){this.onError(t),this.scheduleReconnect()}}}connectSpectate(){if(this.state===k.DISCONNECTED){this.playerName=null,this.isSpectator=!0,this.setState(k.CONNECTING);try{this.ws=new WebSocket(this.url),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>this.handleOpenSpectate(),this.ws.onmessage=e=>this.handleMessage(e),this.ws.onclose=e=>this.handleClose(e),this.ws.onerror=e=>this.handleError(e)}catch(e){this.onError(e),this.scheduleReconnect()}}}disconnect(){this.reconnectAttempts=0,this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.ws&&(this.ws.onclose=null,this.ws.close(),this.ws=null),this.setState(k.DISCONNECTED)}sendInput(e){if(this.state!==k.CONNECTED)return;const t=Date.now();if(t-this.lastInputTime<this.inputThrottleMs){this.pendingAngle=e;return}this.lastInputTime=t,this.pendingAngle=null;const n=new ArrayBuffer(3),s=new DataView(n);s.setUint8(0,le.INPUT);const i=(e+Math.PI)/(Math.PI*2),a=Math.round(i*we.ANGLE_SCALE)&65535;s.setUint16(1,a,!0),this.ws.send(n)}flushInput(){if(this.pendingAngle!==null){const e=this.pendingAngle;this.pendingAngle=null,this.lastInputTime=0,this.sendInput(e)}}sendPing(){if(this.state!==k.CONNECTED)return;this.lastPingTime=performance.now();const e=new ArrayBuffer(9),t=new DataView(e);t.setUint8(0,le.PING),t.setFloat64(1,this.lastPingTime,!0),this.ws.send(e)}sendReset(){!this.ws||this.ws.readyState!==WebSocket.OPEN||this.ws.send(JSON.stringify({type:"reset"}))}handleOpen(){this.reconnectAttempts=0,this.ws.send(JSON.stringify({type:"hello",name:this.playerName})),this.pingInterval=setInterval(()=>this.sendPing(),2e3)}handleOpenSpectate(){this.reconnectAttempts=0,this.ws.send(JSON.stringify({type:"hello",spectate:!0})),this.pingInterval=setInterval(()=>this.sendPing(),2e3)}handleMessage(e){try{e.data instanceof ArrayBuffer?this.handleBinaryMessage(e.data):this.handleTextMessage(JSON.parse(e.data))}catch(t){console.error("Message parse error:",t)}}handleBinaryMessage(e){const t=new DataView(e);switch(t.getUint8(0)){case le.FRAME:this.handleFrame(e);break;case le.PONG:this.handlePong(t);break;case le.DEAD:this.handleDead(t);break}}handleTextMessage(e){switch(e.type){case"init":this.handleInit(e);break;case"error":this.onError(new Error(e.error));break;case"pong":this.rtt=Date.now()-e.t;break;case"reset":console.log("%cðŸ”„ Room reset, reconnecting...","color: orange; font-weight: bold;"),this.onReset();break;default:this.onEvent(e)}}handleInit(e){this.playerId=e.playerId,this.mapSize=e.mapSize,this.setState(k.CONNECTED),this.onInit({playerId:e.playerId,mapSize:e.mapSize,player:e.player,players:e.players,coins:e.coins})}handleFrame(e){const t=new St(e),n=this.mapSize;t.readU8();const s=t.readU32(),i=t.readU8();let a=null;i&&(a=this.readPlayerFull(t,n));const o=t.readU8(),r=[];for(let S=0;S<o;S++)r.push(this.readPlayerFull(t,n));const l=t.readU8(),c=[];for(let S=0;S<l;S++)c.push(this.readPlayerDelta(t,n));const u=t.readU8(),f=[];for(let S=0;S<u;S++)f.push(t.readU16());const p=t.readU8(),g=[];for(let S=0;S<p;S++)g.push({id:t.readU16(),x:t.readU16(),y:t.readU16()});const T=t.readU8(),y=[];for(let S=0;S<T;S++)y.push(this.readEvent(t,n));this.onFrame({frame:s,selfPlayer:a,newPlayers:r,updatedPlayers:c,removedPlayerIds:f,coins:g,events:y})}readPlayerFull(e,t){const n=e.readU16(),s=e.readString(),i=R(e.readU16(),t),a=R(e.readU16(),t),o=Ue(e.readU16()),r=Oe(e.readU8(),100),l=e.readU8(),c=e.readU16(),u=e.readU8()/100,f=e.readU8(),p=(f&1)!==0,g=(f&2)!==0,T=yt(e.readU8()),y=e.readU8()/255,S=e.readU8()/255,v=e.readU8(),E=[];for(let W=0;W<v;W++)E.push({x:R(e.readU16(),t),y:R(e.readU16(),t)});const _=e.readU8(),A=[];for(let W=0;W<_;W++)A.push({x:R(e.readU16(),t),y:R(e.readU16(),t)});const C=e.readU8();return{num:n,name:s,x:i,y:a,angle:o,hp:r,maxHp:100,level:l,xp:c,sizeScale:u,dead:p,isSnipped:g,base:{hue:T,sat:y,lum:S},territory:E,trail:A,droneCount:C}}readPlayerDelta(e,t){const n=e.readU16(),s=e.readU8(),i={num:n};if(s&$.POSITION&&(i.x=R(e.readU16(),t),i.y=R(e.readU16(),t)),s&$.ANGLE&&(i.angle=Ue(e.readU16())),s&$.HP&&(i.hp=Oe(e.readU8(),100)),s&$.XP&&(i.xp=e.readU16()),s&$.LEVEL&&(i.level=e.readU8()),s&$.DRONES&&(i.droneCount=e.readU8()),s&$.TERRITORY){const a=e.readU8();i.territory=[];for(let o=0;o<a;o++)i.territory.push({x:R(e.readU16(),t),y:R(e.readU16(),t)})}if(s&$.TRAIL){const a=e.readU8();i.trail=[];for(let o=0;o<a;o++)i.trail.push({x:R(e.readU16(),t),y:R(e.readU16(),t)})}return i}readEvent(e,t){const n=e.readU8(),s={type:n};switch(n){case I.PLAYER_JOIN:s.player=this.readPlayerFull(e,t);break;case I.PLAYER_LEAVE:s.num=e.readU16(),s.silent=e.readU8()===1;break;case I.PLAYER_KILL:s.killerNum=e.readU16(),s.victimNum=e.readU16(),s.killType=e.readU8();break;case I.COIN_SPAWN:s.id=e.readU16(),s.x=R(e.readU16(),t),s.y=R(e.readU16(),t),s.value=e.readU8();break;case I.COIN_PICKUP:s.id=e.readU16(),s.playerNum=e.readU16();break;case I.HITSCAN:s.ownerNum=e.readU16(),s.targetNum=e.readU16(),s.damage=e.readU8();break;case I.CAPTURE:s.playerNum=e.readU16(),s.x=R(e.readU16(),t),s.y=R(e.readU16(),t),s.xpGained=e.readU8();break;case I.LEVEL_UP:s.playerNum=e.readU16(),s.newLevel=e.readU8();break;case I.SNIP_START:s.playerNum=e.readU16(),s.snipperNum=e.readU16();break}return s}handlePong(e){const t=e.getFloat64(1,!0);this.rtt=performance.now()-t}handleDead(e){const t=e.getUint16(1,!0),n=e.getUint8(3);this.onEvent({type:"dead",killerNum:t,killType:n})}handleClose(e){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.ws=null,this.state!==k.DISCONNECTED&&this.scheduleReconnect()}handleError(e){console.error("WebSocket error:",e),this.onError(new Error("WebSocket error"))}scheduleReconnect(){this.setState(k.RECONNECTING);const e=Math.min(this.reconnectDelay*Math.pow(2,this.reconnectAttempts),this.maxReconnectDelay);this.reconnectAttempts++,setTimeout(()=>{this.state===k.RECONNECTING&&(this.setState(k.DISCONNECTED),this.connect(this.playerName))},e)}setState(e){this.state!==e&&(this.state=e,this.onStateChange(e))}getRTT(){return this.rtt}isConnected(){return this.state===k.CONNECTED}}function Ae(){for(let h=0;h<arguments.length;h++)if(arguments[h]<0||arguments[h]>1)throw new RangeError("H, S, L, and A parameters must be between [0, 1]")}function vt(h,e,t){let n,s,i;if(e===0)n=s=i=t;else{const a=(l,c,u)=>(u<0&&(u+=1),u>1&&(u-=1),u<.16666666666666666?l+(c-l)*6*u:u<.5?c:u<.6666666666666666?l+(c-l)*(.6666666666666666-u)*6:l),o=t<.5?t*(1+e):t+e-t*e,r=2*t-o;n=a(r,o,h+1/3),s=a(r,o,h),i=a(r,o,h-1/3)}return[Math.round(n*255),Math.round(s*255),Math.round(i*255)]}class H{constructor(e,t,n,s=1){Ae(e,t,n),s!==1&&Ae(s),Object.defineProperties(this,{hue:{value:e,enumerable:!0},sat:{value:t,enumerable:!0},lum:{value:n,enumerable:!0},alpha:{value:s,enumerable:!0}})}deriveLumination(e){let t=Math.min(Math.max(this.lum+e,0),1);return new H(this.hue,this.sat,t,this.alpha)}deriveHue(e){const t=this.hue-e;return new H(t-Math.floor(t),this.sat,this.lum,this.alpha)}deriveSaturation(e){let t=Math.min(Math.max(this.sat+e,0),1);return new H(this.hue,t,this.lum,this.alpha)}deriveAlpha(e){return Ae(e),new H(this.hue,this.sat,this.lum,e)}lighter(e){return this.deriveLumination(e)}darker(e){return this.deriveLumination(-e)}rgbString(){const e=vt(this.hue,this.sat,this.lum);return`rgba(${e[0]}, ${e[1]}, ${e[2]}, ${this.alpha})`}static fromData(e){return new H(e.hue,e.sat,e.lum,e.alpha??1)}static possColors(){const e=[192,150,100].map(s=>s/240),t=[0,10,20,25,30,35,40,45,50,60,70,100,110,120,125,130,135,140,145,150,160,170,180,190,200,210,220].map(s=>s/240),n=[];for(const s of e)for(const i of t)n.push(new H(i,s,.5,1));for(let s=n.length-1;s>0;s--){const i=Math.floor(Math.random()*(s+1));[n[s],n[i]]=[n[i],n[s]]}return n}}const M={CELL_WIDTH:40,SPEED:4,BORDER_WIDTH:20,LEADERBOARD_NUM:5,SNIP_FUSE_SPEED_MULT:1.5,SNIP_EXP_ACCEL_PER_SEC:.6375,SNIP_FUSE_MAX_SPEED_MULT:6,SNIP_GRACE_PERIOD:.25,COIN_RADIUS:8,TRAIL_SPEED_BUFF_MAX:1.4,TRAIL_SPEED_BUFF_RAMP_TIME:5,TRAIL_SPEED_BUFF_EASE:2,XP_BASE_PER_LEVEL:100,XP_INCREMENT_PER_LEVEL:25,DRONE_ORBIT_RADIUS:55,DRONE_ORBIT_SPEED:2,DRONE_RADIUS:10,DRONE_RANGE:158};let d=null,P=null,L=!1;const m={masterVolume:.6,sfxVolume:.8,musicVolume:.3,enabled:!0,volumes:{playerLaser:.3,enemyLaser:.2,playerFuse:1,enemyFuse:.7,capture:1,levelUp:.8,death:2,kill:2,coinPickup:1,hit:1.5,trailing:.4,speedRush:.5}};let z=null,F=null,fe=null,B=null,D=null,pe=null,O=null,V=null,U=null;const w={playerLasers:[],enemyLasers:[],maxConcurrent:4,windowMs:100,minCooldownMs:20,attenuationFactor:.6,maxDelayMs:35};let x=null,N=null,j=!1,ee=[],ne=[],ie=0,G=null,ce=!1;const Mt="/music/playlist/menu/SwarmBlitz - Main Menu Theme.mp3";function je(h){const e=[...h];for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function wt(){if(!L)try{d=new(window.AudioContext||window.webkitAudioContext),P=d.createGain(),P.gain.value=m.masterVolume,P.connect(d.destination),L=!0,console.log("[SoundManager] Initialized")}catch(h){console.warn("[SoundManager] Web Audio API not supported:",h),m.enabled=!1}}function q(){d&&d.state==="suspended"&&d.resume()}function bt(h){m.enabled=!!h}function Je(h){m.masterVolume=Math.max(0,Math.min(1,h)),P&&(P.gain.value=m.masterVolume),rt()}function Ze(h){m.musicVolume=Math.max(0,Math.min(1,h)),rt()}function et(h){m.sfxVolume=Math.max(0,Math.min(1,h))}function Pt(h){for(const[e,t]of Object.entries(h))Object.prototype.hasOwnProperty.call(m.volumes,e)&&(m.volumes[e]=Math.max(0,Math.min(1,t)))}function _e(){return{enabled:m.enabled,masterVolume:m.masterVolume,sfxVolume:m.sfxVolume,musicVolume:m.musicVolume,volumes:{...m.volumes}}}function Et(){if(!L||!m.enabled||m.volumes.playerLaser<=0)return;q();const h=performance.now();if(w.playerLasers.length>0){const p=w.playerLasers[w.playerLasers.length-1];if(h-p<w.minCooldownMs)return}w.playerLasers=w.playerLasers.filter(p=>h-p<w.windowMs);const e=w.playerLasers.length;w.playerLasers.push(h);let t=1;if(e>=w.maxConcurrent){const p=e-w.maxConcurrent+1;t=Math.pow(w.attenuationFactor,p)}else e>1&&(t=1-(e-1)*.15);const n=m.volumes.playerLaser,s=Math.random()*w.maxDelayMs/1e3,i=d.currentTime+s,a=.15,o=d.createOscillator(),r=d.createOscillator(),l=d.createGain(),c=d.createBiquadFilter();o.type="sawtooth",r.type="square";const u=.95+Math.random()*.1;o.frequency.setValueAtTime(1800*u,i),o.frequency.exponentialRampToValueAtTime(400*u,i+a*.7),r.frequency.setValueAtTime(1400*u,i),r.frequency.exponentialRampToValueAtTime(300*u,i+a*.7),c.type="lowpass",c.frequency.setValueAtTime(4e3,i),c.frequency.exponentialRampToValueAtTime(800,i+a),c.Q.value=2;const f=.35*m.sfxVolume*n*t;l.gain.setValueAtTime(0,i),l.gain.linearRampToValueAtTime(f,i+.01),l.gain.exponentialRampToValueAtTime(.01,i+a),o.connect(c),r.connect(c),c.connect(l),l.connect(P),o.start(i),r.start(i),o.stop(i+a),r.stop(i+a)}function At(h,e=800){if(!L||!m.enabled||m.volumes.enemyLaser<=0)return;q();const t=m.volumes.enemyLaser,n=Math.max(0,1-h/e);if(n<.05)return;const s=performance.now();if(w.enemyLasers.length>0){const y=w.enemyLasers[w.enemyLasers.length-1];if(s-y<w.minCooldownMs)return}w.enemyLasers=w.enemyLasers.filter(y=>s-y<w.windowMs);const i=w.enemyLasers.length;w.enemyLasers.push(s);let a=1;if(i>=w.maxConcurrent){const y=i-w.maxConcurrent+1;a=Math.pow(w.attenuationFactor,y)}else i>1&&(a=1-(i-1)*.15);const o=Math.random()*w.maxDelayMs/1e3,r=d.currentTime+o,l=.12,c=d.createOscillator(),u=d.createOscillator(),f=d.createGain(),p=d.createBiquadFilter();c.type="sawtooth",u.type="triangle";const g=.95+Math.random()*.1;c.frequency.setValueAtTime(900*g,r),c.frequency.exponentialRampToValueAtTime(250*g,r+l*.8),u.frequency.setValueAtTime(700*g,r),u.frequency.exponentialRampToValueAtTime(180*g,r+l*.8),p.type="lowpass",p.frequency.setValueAtTime(2500,r),p.frequency.exponentialRampToValueAtTime(500,r+l),p.Q.value=3;const T=.25*m.sfxVolume*t*n*a;f.gain.setValueAtTime(0,r),f.gain.linearRampToValueAtTime(T,r+.008),f.gain.exponentialRampToValueAtTime(.01,r+l),c.connect(p),u.connect(p),p.connect(f),f.connect(P),c.start(r),u.start(r),c.stop(r+l),u.stop(r+l)}function It(h=!0){if(!L||!m.enabled||m.volumes.capture<=0)return;q();const e=m.volumes.capture,t=d.currentTime,n=(h?1:.3)*e,s=d.sampleRate*.4,i=d.createBuffer(1,s,d.sampleRate),a=i.getChannelData(0);for(let c=0;c<s;c++)a[c]=Math.random()*2-1;const o=d.createBufferSource();o.buffer=i;const r=d.createGain(),l=d.createBiquadFilter();if(l.type="bandpass",l.frequency.setValueAtTime(300,t),l.frequency.exponentialRampToValueAtTime(2e3,t+.15),l.frequency.exponentialRampToValueAtTime(500,t+.4),l.Q.value=1,r.gain.setValueAtTime(0,t),r.gain.linearRampToValueAtTime(.15*m.sfxVolume*n,t+.05),r.gain.exponentialRampToValueAtTime(.01,t+.4),o.connect(l),l.connect(r),r.connect(P),o.start(t),o.stop(t+.4),h){const c=[523.25,659.25,783.99],u=.35;c.forEach((f,p)=>{const g=d.createOscillator(),T=d.createGain();g.type="sine",g.frequency.value=f;const y=t+p*.03;T.gain.setValueAtTime(0,y),T.gain.linearRampToValueAtTime(.12*m.sfxVolume*n,y+.02),T.gain.exponentialRampToValueAtTime(.01,y+u),g.connect(T),T.connect(P),g.start(y),g.stop(y+u)})}}function Rt(){if(!L||!m.enabled||m.volumes.levelUp<=0)return;q();const h=m.volumes.levelUp,e=d.currentTime;[{freq:523.25,time:0},{freq:659.25,time:.08},{freq:783.99,time:.16},{freq:1046.5,time:.24}].forEach(i=>{const a=d.createOscillator(),o=d.createOscillator(),r=d.createGain();a.type="sine",o.type="triangle",a.frequency.value=i.freq,o.frequency.value=i.freq*2;const l=e+i.time,c=.5-i.time*.5;r.gain.setValueAtTime(0,l),r.gain.linearRampToValueAtTime(.2*m.sfxVolume*h,l+.02),r.gain.setValueAtTime(.18*m.sfxVolume*h,l+c*.3),r.gain.exponentialRampToValueAtTime(.01,l+c),a.connect(r),o.connect(r),r.connect(P),a.start(l),o.start(l),a.stop(l+c),o.stop(l+c)});for(let i=0;i<8;i++){const a=d.createOscillator(),o=d.createGain();a.type="sine",a.frequency.value=2e3+Math.random()*2e3;const r=e+.1+Math.random()*.4,l=.1+Math.random()*.15;o.gain.setValueAtTime(0,r),o.gain.linearRampToValueAtTime(.06*m.sfxVolume*h,r+.01),o.gain.exponentialRampToValueAtTime(.01,r+l),a.connect(o),o.connect(P),a.start(r),a.stop(r+l)}const n=d.createOscillator(),s=d.createGain();n.type="sine",n.frequency.setValueAtTime(150,e),n.frequency.exponentialRampToValueAtTime(50,e+.5),s.gain.setValueAtTime(0,e),s.gain.linearRampToValueAtTime(.25*m.sfxVolume*h,e+.02),s.gain.exponentialRampToValueAtTime(.01,e+.5),n.connect(s),s.connect(P),n.start(e),n.stop(e+.5)}function Be(h=!1,e=0,t=400){if(!L||!m.enabled||m.volumes.death<=0)return;q();const n=m.volumes.death,s=d.currentTime;let i;if(h)i=1*n;else{const E=Math.max(0,1-e/t);if(E<.1)return;i=.5*n*E}const a=d.createOscillator(),o=d.createOscillator(),r=d.createGain(),l=d.createBiquadFilter();a.type="sine",o.type="triangle",a.frequency.setValueAtTime(600,s),a.frequency.exponentialRampToValueAtTime(80,s+.8),o.frequency.setValueAtTime(603,s),o.frequency.exponentialRampToValueAtTime(82,s+.8),l.type="lowpass",l.frequency.setValueAtTime(2e3,s),l.frequency.exponentialRampToValueAtTime(200,s+.7),r.gain.setValueAtTime(.25*m.sfxVolume*i,s),r.gain.linearRampToValueAtTime(.2*m.sfxVolume*i,s+.1),r.gain.exponentialRampToValueAtTime(.01,s+.9),a.connect(l),o.connect(l),l.connect(r),r.connect(P),a.start(s),o.start(s),a.stop(s+.9),o.stop(s+.9);const c=.15,u=d.sampleRate*c,f=d.createBuffer(1,u,d.sampleRate),p=f.getChannelData(0);for(let E=0;E<u;E++){const _=E/d.sampleRate,A=Math.random()>.7?Math.random()*2-1:0,C=Math.exp(-_*15);p[E]=A*C}const g=d.createBufferSource();g.buffer=f;const T=d.createGain(),y=d.createBiquadFilter();y.type="highpass",y.frequency.value=2e3,y.Q.value=1,T.gain.setValueAtTime(.18*m.sfxVolume*i,s),T.gain.exponentialRampToValueAtTime(.01,s+c),g.connect(y),y.connect(T),T.connect(P),g.start(s),g.stop(s+c);const S=d.createOscillator(),v=d.createGain();S.type="sine",S.frequency.setValueAtTime(60,s),S.frequency.exponentialRampToValueAtTime(25,s+.3),v.gain.setValueAtTime(0,s),v.gain.linearRampToValueAtTime(.3*m.sfxVolume*i,s+.015),v.gain.exponentialRampToValueAtTime(.01,s+.35),S.connect(v),v.connect(P),S.start(s),S.stop(s+.35),h&&[180,190,270].forEach(_=>{const A=d.createOscillator(),C=d.createGain();A.type="sine",A.frequency.setValueAtTime(_,s),A.frequency.exponentialRampToValueAtTime(_*.5,s+.6),C.gain.setValueAtTime(0,s+.02),C.gain.linearRampToValueAtTime(.08*m.sfxVolume*n,s+.05),C.gain.exponentialRampToValueAtTime(.01,s+.7),A.connect(C),C.connect(P),A.start(s),A.stop(s+.7)})}function Ct(){if(!L||!m.enabled||m.volumes.coinPickup<=0)return;q();const h=m.volumes.coinPickup,e=d.currentTime,t=d.createOscillator(),n=d.createOscillator(),s=d.createGain();t.type="sine",n.type="triangle",t.frequency.setValueAtTime(800,e),t.frequency.exponentialRampToValueAtTime(1400,e+.08),n.frequency.setValueAtTime(1200,e),n.frequency.exponentialRampToValueAtTime(2100,e+.08),s.gain.setValueAtTime(0,e),s.gain.linearRampToValueAtTime(.2*m.sfxVolume*h,e+.015),s.gain.exponentialRampToValueAtTime(.01,e+.2),t.connect(s),n.connect(s),s.connect(P),t.start(e),n.start(e),t.stop(e+.2),n.stop(e+.2);const i=d.createOscillator(),a=d.createGain();i.type="sine",i.frequency.setValueAtTime(2400,e+.02),i.frequency.exponentialRampToValueAtTime(3200,e+.1),a.gain.setValueAtTime(0,e+.02),a.gain.linearRampToValueAtTime(.08*m.sfxVolume*h,e+.04),a.gain.exponentialRampToValueAtTime(.01,e+.15),i.connect(a),a.connect(P),i.start(e+.02),i.stop(e+.15)}function kt(){if(!L||!m.enabled||z)return;q();const e=d.sampleRate*1.5,t=d.createBuffer(1,e,d.sampleRate),n=t.getChannelData(0);for(let p=0;p<e;p++){const g=p/d.sampleRate,T=(Math.random()*2-1)*.5,y=Math.random()>.7?(Math.random()*2-1)*.6:0,S=Math.random()>.97?(Math.random()*2-1)*1:0,v=Math.sin(g*150+Math.random()*2)*.2*(Math.random()>.5?1:0);n[p]=T+y+S+v}const s=d.createBufferSource();s.buffer=t,s.loop=!0;const i=d.createBiquadFilter();i.type="highpass",i.frequency.value=1500,i.Q.value=.7;const a=d.createBiquadFilter();a.type="peaking",a.frequency.value=5e3,a.Q.value=1,a.gain.value=6;const o=d.createOscillator();o.type="sawtooth",o.frequency.value=80;const r=d.createGain();r.gain.value=.08;const l=d.createBiquadFilter();l.type="bandpass",l.frequency.value=200,l.Q.value=3,F=d.createGain();const c=m.volumes.playerFuse??1;F.gain.value=.15*m.sfxVolume*c;const u=d.createOscillator();u.type="sine",u.frequency.value=12;const f=d.createGain();f.gain.value=.02,s.connect(i),i.connect(a),a.connect(F),o.connect(l),l.connect(r),r.connect(F),u.connect(f),f.connect(F.gain),F.connect(P),s.start(),o.start(),u.start(),z={noise:s,burnOsc:o,lfo:u},fe=a}function Lt(){if(z)try{if(F){const h=d.currentTime;F.gain.linearRampToValueAtTime(0,h+.1)}setTimeout(()=>{try{z&&(z.noise.stop(),z.burnOsc.stop(),z.lfo.stop())}catch{}z=null,F=null,fe=null},150)}catch{z=null,F=null,fe=null}}function Dt(h){if(!F||!L||!m.enabled||m.volumes.playerFuse<=0)return;const e=m.volumes.playerFuse,t=.15,s=(t+(.45-t)*h)*m.sfxVolume*e,i=d.currentTime;if(F.gain.linearRampToValueAtTime(s,i+.05),fe){const r=4+6*h;fe.gain.linearRampToValueAtTime(r,i+.05)}}function Nt(){if(!L||!m.enabled||B)return;q();const e=d.sampleRate*1.5,t=d.createBuffer(1,e,d.sampleRate),n=t.getChannelData(0);for(let p=0;p<e;p++){const g=p/d.sampleRate,T=(Math.random()*2-1)*.4,y=Math.random()>.75?(Math.random()*2-1)*.5:0,S=Math.random()>.96?(Math.random()*2-1)*.8:0,v=Math.sin(g*100+Math.random()*2)*.15*(Math.random()>.6?1:0);n[p]=T+y+S+v}const s=d.createBufferSource();s.buffer=t,s.loop=!0;const i=d.createBiquadFilter();i.type="highpass",i.frequency.value=800,i.Q.value=.5;const a=d.createBiquadFilter();a.type="peaking",a.frequency.value=2500,a.Q.value=1.5,a.gain.value=5;const o=d.createOscillator();o.type="sawtooth",o.frequency.value=50;const r=d.createGain();r.gain.value=.1;const l=d.createBiquadFilter();l.type="bandpass",l.frequency.value=150,l.Q.value=2,D=d.createGain();const c=m.volumes.enemyFuse??.7;D.gain.value=.06*m.sfxVolume*c;const u=d.createOscillator();u.type="sine",u.frequency.value=8;const f=d.createGain();f.gain.value=.015,s.connect(i),i.connect(a),a.connect(D),o.connect(l),l.connect(r),r.connect(D),u.connect(f),f.connect(D.gain),D.connect(P),s.start(),o.start(),u.start(),B={noise:s,burnOsc:o,lfo:u},pe=a}function Ft(){if(B)try{if(D){const h=d.currentTime;D.gain.linearRampToValueAtTime(0,h+.1)}setTimeout(()=>{try{B&&(B.noise.stop(),B.burnOsc.stop(),B.lfo.stop())}catch{}B=null,D=null,pe=null},150)}catch{B=null,D=null,pe=null}}function Vt(h,e=300){if(!D||!L||!m.enabled||m.volumes.enemyFuse<=0)return;const t=m.volumes.enemyFuse,n=Math.max(0,1-h/e),s=d.currentTime;if(n<.1){D.gain.linearRampToValueAtTime(0,s+.05);return}const i=.08,o=(i+(.3-i)*n)*m.sfxVolume*t;if(D.gain.linearRampToValueAtTime(o,s+.05),pe){const c=3+4*n;pe.gain.linearRampToValueAtTime(c,s+.05)}}function xe(){return B!==null}function Ut(){if(!L||!m.enabled||O)return;q();const e=d.sampleRate*2,t=d.createBuffer(1,e,d.sampleRate),n=t.getChannelData(0);for(let c=0;c<e;c++){const u=c/d.sampleRate,f=(Math.random()*2-1)*.5,p=Math.sin(u*12)*.2*(Math.random()*2-1),g=Math.sin(u*6)*.08;n[c]=f+p+g}U=d.createBufferSource(),U.buffer=t,U.loop=!0,U.playbackRate.value=1;const s=d.createBiquadFilter();s.type="bandpass",s.frequency.value=600,s.Q.value=1.2;const i=d.createBiquadFilter();i.type="highpass",i.frequency.value=300,i.Q.value=.7,x=d.createOscillator(),x.type="sawtooth",x.frequency.value=100;const a=d.createGain();a.gain.value=.02;const o=d.createBiquadFilter();o.type="lowpass",o.frequency.value=200,V=d.createGain(),V.gain.value=0,U.connect(s),s.connect(i),i.connect(V),x.connect(o),o.connect(a),a.connect(V),V.connect(P),U.start(),x.start(),O={noiseSource:U,oscillator:x,bandpass:s};const r=d.currentTime,l=m.volumes.speedRush??.5;V.gain.linearRampToValueAtTime(.12*m.sfxVolume*l,r+.3)}function Ie(){if(O)try{if(V){const h=d.currentTime;V.gain.linearRampToValueAtTime(0,h+.2)}setTimeout(()=>{try{O&&(O.noiseSource.stop(),O.oscillator.stop())}catch{}O=null,V=null,U=null,x=null},250)}catch{O=null,V=null,U=null,x=null}}function Ot(h){if(!O||!V||!L||!m.enabled||m.volumes.speedRush<=0)return;const e=m.volumes.speedRush??.5,t=d.currentTime,n=Math.min(1,Math.max(0,(h-1.1)/.1)),s=1+(1.5-1)*n;U&&U.playbackRate.linearRampToValueAtTime(s,t+.1);const i=(.1+(.25-.1)*n)*m.sfxVolume*e;if(V.gain.linearRampToValueAtTime(i,t+.1),x){const a=100+80*n;x.frequency.linearRampToValueAtTime(a,t+.1)}if(O.bandpass){const a=500+700*n;O.bandpass.frequency.linearRampToValueAtTime(a,t+.1)}}async function _t(){try{return ee=(await(await fetch("/api/playlist")).json()).tracks||[],console.log("[SoundManager] Playlist loaded:",ee.length,"tracks"),ee.length>0}catch(h){return console.warn("[SoundManager] Could not fetch playlist:",h),!1}}function De(){st()}function tt(){if(!j||ne.length===0)return;const h=ne[ie],e=`/music/playlist/${encodeURIComponent(h)}`;console.log("[SoundManager] Playing track:",h,`(${ie+1}/${ne.length})`),N&&(N.pause(),N.removeEventListener("ended",De)),N=new Audio(e),N.volume=m.musicVolume*m.masterVolume,N.addEventListener("ended",De),N.play().catch(t=>{console.warn("[SoundManager] Could not play track:",t),st()})}function st(){j&&(ie++,ie>=ne.length&&(console.log("[SoundManager] All tracks played, reshuffling playlist"),ne=je(ee),ie=0),tt())}async function nt(){if(!(!m.enabled||j)){if(j=!0,ee.length===0&&!await _t()){console.warn("[SoundManager] No tracks in playlist"),j=!1;return}ne=je(ee),ie=0,tt(),console.log("[SoundManager] Background music started with",ee.length,"tracks")}}function it(){if(j){if(j=!1,N){N.removeEventListener("ended",De);const h=N,e=setInterval(()=>{h.volume>.05?h.volume=Math.max(0,h.volume-.05):(clearInterval(e),h.pause())},30)}console.log("[SoundManager] Background music stopped")}}function at(){!m.enabled||ce||(j&&it(),ce=!0,G&&G.pause(),G=new Audio(Mt),G.volume=m.musicVolume*m.masterVolume,G.loop=!0,G.play().catch(h=>{console.warn("[SoundManager] Could not play menu music:",h),ce=!1}),console.log("[SoundManager] Menu music started"))}function ot(){if(ce){if(ce=!1,G){const h=G,e=setInterval(()=>{h.volume>.05?h.volume=Math.max(0,h.volume-.05):(clearInterval(e),h.pause())},30)}console.log("[SoundManager] Menu music stopped")}}function rt(){const h=m.musicVolume*m.masterVolume;N&&(N.volume=h),G&&(G.volume=h)}const X=45,Y=5,te=M.CELL_WIDTH/2,Bt=M.DRONE_RADIUS,xt=400,Ge=65;class Te{constructor(e){this.num=e.num,this.name=e.name||"Player",this.x=e.x,this.y=e.y,this.angle=e.angle||0,this.serverX=e.x,this.serverY=e.y,this.serverAngle=e.angle||0,this.correctionX=0,this.correctionY=0,this.hp=e.hp||100,this.maxHp=e.maxHp||100,this.level=e.level||1,this.xp=e.xp||0,this.sizeScale=e.sizeScale||1,this.dead=e.dead||!1,this.isSnipped=e.isSnipped||!1,this.territory=e.territory||[],this.trail=e.trail||[],this.droneCount=e.droneCount!==void 0?e.droneCount:this.level,this.droneOrbitPhase=0,this.drones=[],e.base?this.base=new H(e.base.hue,e.base.sat,e.base.lum):this.base=new H(Math.random(),.8,.5)}update(e,t=!1){if(t&&e.x!==void 0&&e.y!==void 0){const n=e.x-this.x,s=e.y-this.y;this.correctionX+=n,this.correctionY+=s,Math.sqrt(n*n+s*s)>100&&(this.x=e.x,this.y=e.y,this.correctionX=0,this.correctionY=0)}e.x!==void 0&&(this.serverX=e.x),e.y!==void 0&&(this.serverY=e.y),e.angle!==void 0&&(this.serverAngle=e.angle),e.hp!==void 0&&(this.hp=e.hp),e.maxHp!==void 0&&(this.maxHp=e.maxHp),e.level!==void 0&&(this.level=e.level),e.xp!==void 0&&(this.xp=e.xp),e.sizeScale!==void 0&&(this.sizeScale=e.sizeScale),e.droneCount!==void 0?this.droneCount=e.droneCount:e.level!==void 0&&(this.droneCount=e.level),e.dead!==void 0&&(this.dead=e.dead),e.isSnipped!==void 0&&(this.isSnipped=e.isSnipped),e.territory!==void 0&&(this.territory=e.territory||[]),e.trail!==void 0&&(this.trail=e.trail||[])}updateDrones(e){const t=M.DRONE_ORBIT_RADIUS,n=M.DRONE_ORBIT_SPEED;for(this.droneOrbitPhase+=n*(e/1e3),this.droneOrbitPhase>Math.PI*2&&(this.droneOrbitPhase-=Math.PI*2);this.drones.length<this.droneCount;)this.drones.push({id:this.drones.length,x:this.x,y:this.y,targetId:null});for(;this.drones.length>this.droneCount;)this.drones.pop();for(let s=0;s<this.drones.length;s++){const i=this.drones[s],a=s/this.droneCount*Math.PI*2,o=this.droneOrbitPhase+a;i.x=this.x+Math.cos(o)*t,i.y=this.y+Math.sin(o)*t}}predict(e,t,n,s){this.x+=this.correctionX*.08,this.y+=this.correctionY*.08,this.correctionX*=1-.08,this.correctionY*=1-.08;let a=this.serverAngle-this.angle;for(;a>Math.PI;)a-=Math.PI*2;for(;a<-Math.PI;)a+=Math.PI*2;this.angle+=a*.03;const o=9*(e/1e3);let r=s-this.angle;for(;r>Math.PI;)r-=Math.PI*2;for(;r<-Math.PI;)r+=Math.PI*2;for(Math.abs(r)>o&&(r=Math.sign(r)*o),this.angle+=r;this.angle>Math.PI;)this.angle-=Math.PI*2;for(;this.angle<-Math.PI;)this.angle+=Math.PI*2;const l=t*(e/1e3)*60;this.x+=Math.cos(this.angle)*l,this.y+=Math.sin(this.angle)*l;const c=15;this.x=Math.max(c,Math.min(n-c,this.x)),this.y=Math.max(c,Math.min(n-c,this.y)),this.updateDrones(e)}interpolateOther(e,t){let n=this.serverAngle-this.angle;for(;n>Math.PI;)n-=Math.PI*2;for(;n<-Math.PI;)n+=Math.PI*2;const s=Math.min(1,.2*(e/16.67));for(this.angle+=n*s;this.angle>Math.PI;)this.angle-=Math.PI*2;for(;this.angle<-Math.PI;)this.angle+=Math.PI*2;const i=t*(e/1e3)*60;this.x+=Math.cos(this.angle)*i,this.y+=Math.sin(this.angle)*i;const a=this.serverX-this.x,o=this.serverY-this.y,r=Math.sqrt(a*a+o*o);if(r>200)this.x=this.serverX,this.y=this.serverY;else{const l=Math.min(.25,.05+r*.002);this.x+=a*l,this.y+=o*l}this.updateDrones(e)}}class Re{constructor(e){this.id=e.id,this.x=e.x,this.y=e.y,this.value=e.value||5}}class Z{constructor(e,t,n,s="burst"){if(this.x=e,this.y=t,this.color=n,this.type=s,s==="burst"){const i=Math.random()*Math.PI*2,a=3+Math.random()*8;this.vx=Math.cos(i)*a,this.vy=Math.sin(i)*a,this.size=4+Math.random()*8,this.life=1,this.decay=.015+Math.random()*.02,this.rotation=Math.random()*Math.PI*2,this.rotationSpeed=(Math.random()-.5)*.3,this.gravity=.15}else if(s==="spark"){const i=Math.random()*Math.PI*2,a=8+Math.random()*12;this.vx=Math.cos(i)*a,this.vy=Math.sin(i)*a,this.size=2+Math.random()*3,this.life=1,this.decay=.04+Math.random()*.03,this.trail=[]}else if(s==="ring")this.radius=5,this.maxRadius=80+Math.random()*40,this.expandSpeed=4+Math.random()*2,this.life=1,this.decay=.025,this.lineWidth=8;else if(s==="shard"){const i=Math.random()*Math.PI*2,a=2+Math.random()*5;this.vx=Math.cos(i)*a,this.vy=Math.sin(i)*a,this.points=this.generateShardShape(),this.life=1,this.decay=.012+Math.random()*.01,this.rotation=Math.random()*Math.PI*2,this.rotationSpeed=(Math.random()-.5)*.15,this.gravity=.08}}generateShardShape(){const e=[],t=3+Math.floor(Math.random()*3),n=10+Math.random()*20;for(let s=0;s<t;s++){const i=s/t*Math.PI*2,a=n*(.5+Math.random()*.5);e.push({x:Math.cos(i)*a,y:Math.sin(i)*a})}return e}update(){return this.type==="burst"?(this.x+=this.vx,this.y+=this.vy,this.vy+=this.gravity,this.vx*=.98,this.rotation+=this.rotationSpeed,this.life-=this.decay):this.type==="spark"?(this.trail.push({x:this.x,y:this.y,life:this.life}),this.trail.length>8&&this.trail.shift(),this.x+=this.vx,this.y+=this.vy,this.vx*=.92,this.vy*=.92,this.life-=this.decay):this.type==="ring"?(this.radius+=this.expandSpeed,this.lineWidth*=.96,this.life-=this.decay):this.type==="shard"&&(this.x+=this.vx,this.y+=this.vy,this.vy+=this.gravity,this.rotation+=this.rotationSpeed,this.life-=this.decay),this.life>0}render(e){const t=Math.max(0,this.life);if(this.type==="burst")e.save(),e.translate(this.x,this.y),e.rotate(this.rotation),e.globalAlpha=t,e.fillStyle=this.color,e.fillRect(-this.size/2,-this.size/2,this.size,this.size),e.shadowColor=this.color,e.shadowBlur=10*t,e.fillRect(-this.size/2,-this.size/2,this.size,this.size),e.shadowBlur=0,e.restore();else if(this.type==="spark"){e.save(),e.beginPath(),e.moveTo(this.x,this.y);for(let n=this.trail.length-1;n>=0;n--){const s=this.trail[n];e.lineTo(s.x,s.y)}e.strokeStyle=this.color,e.lineWidth=this.size*t,e.globalAlpha=t*.6,e.stroke(),e.globalAlpha=t,e.fillStyle="#fff",e.beginPath(),e.arc(this.x,this.y,this.size*.8,0,Math.PI*2),e.fill(),e.restore()}else if(this.type==="ring")e.save(),e.beginPath(),e.arc(this.x,this.y,this.radius,0,Math.PI*2),e.strokeStyle=this.color,e.lineWidth=Math.max(1,this.lineWidth*t),e.globalAlpha=t*.7,e.stroke(),e.restore();else if(this.type==="shard"){e.save(),e.translate(this.x,this.y),e.rotate(this.rotation),e.globalAlpha=t*.8,e.beginPath(),e.moveTo(this.points[0].x,this.points[0].y);for(let n=1;n<this.points.length;n++)e.lineTo(this.points[n].x,this.points[n].y);e.closePath(),e.fillStyle=this.color,e.fill(),e.restore()}e.globalAlpha=1}}class Gt{constructor(e,t,n,s,i){this.fromX=e,this.fromY=t,this.toX=n,this.toY=s,this.color=i,this.startTime=performance.now(),this.duration=100}isExpired(){return performance.now()-this.startTime>this.duration}getAlpha(){const e=performance.now()-this.startTime;return Math.max(0,1-e/this.duration)}}const qt=1,qe=40,Ce=10,Xt=120,Yt=.8;class zt{constructor(e,t,n,s,i){this.x=e,this.y=t,this.xpGained=n,this.player=s,this.isLocalPlayer=i,this.spawnTime=performance.now(),this.color=s?s.base:null,this.pulseRadius=Ce,this.pulseLife=1,this.particles=[];const a=i?qe:Math.floor(qe*.6);for(let o=0;o<a;o++){const r=Math.random()*Math.PI*2,l=2+Math.random()*6;this.particles.push({x:e,y:t,vx:Math.cos(r)*l,vy:Math.sin(r)*l,size:3+Math.random()*5,life:1,decay:.015+Math.random()*.02})}this.textY=t-20,this.textAlpha=1}easeOutQuad(e){return e*(2-e)}update(){const e=(performance.now()-this.spawnTime)/1e3,t=Math.min(1,e/qt),n=Math.min(1,e/Yt);this.pulseRadius=Ce+(Xt-Ce)*this.easeOutQuad(n),this.pulseLife=1-n;for(const s of this.particles)s.x+=s.vx,s.y+=s.vy,s.vx*=.96,s.vy*=.96,s.vy+=.1,s.life-=s.decay;return this.textY-=.8,this.textAlpha=Math.max(0,1-t),t<1}render(e){const t=this.color?this.color.rgbString():"#FFD700",n=this.color?this.color.lighter(.3).rgbString():"#FFEC8B";this.pulseLife>0&&(e.save(),e.strokeStyle=this.color?this.color.deriveAlpha(this.pulseLife*.8).rgbString():`rgba(255, 215, 0, ${this.pulseLife*.8})`,e.lineWidth=4*this.pulseLife,e.beginPath(),e.arc(this.x,this.y,this.pulseRadius,0,Math.PI*2),e.stroke(),e.strokeStyle=this.color?this.color.deriveAlpha(this.pulseLife*.4).rgbString():`rgba(255, 255, 200, ${this.pulseLife*.4})`,e.lineWidth=8*this.pulseLife,e.beginPath(),e.arc(this.x,this.y,this.pulseRadius*.8,0,Math.PI*2),e.stroke(),e.restore());for(const s of this.particles)s.life<=0||(e.save(),e.globalAlpha=Math.max(0,s.life),e.fillStyle=n,e.shadowColor=t,e.shadowBlur=8*s.life,e.beginPath(),e.arc(s.x,s.y,s.size*s.life,0,Math.PI*2),e.fill(),e.restore());if(this.textAlpha>0&&this.xpGained>0){e.save(),e.globalAlpha=this.textAlpha,e.fillStyle="#9370DB",e.strokeStyle="rgba(0, 0, 0, 0.6)",e.lineWidth=3,e.font="bold 18px Changa",e.textAlign="center",e.textBaseline="middle";const s=`+${this.xpGained} XP`;e.strokeText(s,this.x,this.textY),e.fillText(s,this.x,this.textY),e.restore()}e.globalAlpha=1}}class Ht{constructor(e,t,n,s,i){this.x=e,this.y=t,this.newLevel=n,this.player=s,this.isLocalPlayer=i,this.spawnTime=performance.now(),this.color=s&&s.base?s.base:null,this.textY=t-40,this.textAlpha=1,this.scale=.5}update(){const e=(performance.now()-this.spawnTime)/1e3,n=Math.min(1,e/1.5);return this.textY=this.y-40-n*60,this.textAlpha=Math.max(0,1-n),n<.3?this.scale=.5+n/.3*1:this.scale=1.5-(n-.3)*.5,n<1}render(e){if(this.textAlpha<=0)return;e.save(),e.globalAlpha=this.textAlpha,e.translate(this.x,this.textY),e.scale(this.scale,this.scale),e.shadowColor="#FFD700",e.shadowBlur=20*this.textAlpha,e.fillStyle="#FFD700",e.strokeStyle="rgba(0, 0, 0, 0.8)",e.lineWidth=4,e.font="bold 24px Changa",e.textAlign="center",e.textBaseline="middle";const t=`â¬†ï¸ LEVEL ${this.newLevel}! â¬†ï¸`;e.strokeText(t,0,0),e.fillText(t,0,0),e.font="bold 14px Changa",e.fillStyle="#88CCFF",e.strokeText("+1 Drone, +5% Size",0,28),e.fillText("+1 Drone, +5% Size",0,28),e.restore()}}class Wt{constructor(e,t,n,s,i,a=null){this.originX=e,this.originY=t,this.targetX=n,this.targetY=s,this.value=i,this.coinId=a,this.x=e,this.y=t,this.spawnTime=performance.now(),this.duration=600+Math.random()*200,this.delay=Math.random()*150,this.arcHeight=40+Math.random()*60,this.rotation=0,this.rotationSpeed=(Math.random()-.5)*.4,this.scale=0,this.targetScale=.8+Math.random()*.4,this.glowIntensity=1,this.sparkles=[];for(let o=0;o<3;o++)this.sparkles.push({angle:Math.random()*Math.PI*2,dist:8+Math.random()*8,size:2+Math.random()*2,speed:.05+Math.random()*.05});this.landed=!1,this.landTime=0,this.bouncePhase=0}update(){const e=performance.now(),t=e-this.spawnTime-this.delay;if(t<0)return!0;const n=Math.min(1,t/this.duration);if(this.landed){const s=e-this.landTime,i=Math.min(1,s/400);if(this.bouncePhase=Math.sin(i*Math.PI*3)*(1-i)*8,this.y=this.targetY-Math.abs(this.bouncePhase),this.rotation*=.95,this.glowIntensity=Math.max(.3,1-i*.7),i>=1)return!1}else{const s=1-Math.pow(1-n,3);this.x=this.originX+(this.targetX-this.originX)*s;const i=this.originY+(this.targetY-this.originY)*s,a=Math.sin(s*Math.PI)*this.arcHeight;this.y=i-a,this.scale=this.targetScale*Math.min(1,s*2),this.rotation+=this.rotationSpeed;for(const o of this.sparkles)o.angle+=o.speed;n>=1&&(this.landed=!0,this.landTime=e,this.x=this.targetX,this.y=this.targetY)}return!0}render(e){if(performance.now()-this.spawnTime-this.delay<0||this.scale<=0)return;e.save(),e.translate(this.x,this.y),e.rotate(this.rotation),e.scale(this.scale,this.scale);const s=M.COIN_RADIUS*1.2,i=s*(2+this.glowIntensity),a=e.createRadialGradient(0,0,s*.5,0,0,i);a.addColorStop(0,`rgba(255, 215, 0, ${.6*this.glowIntensity})`),a.addColorStop(.5,`rgba(255, 180, 0, ${.3*this.glowIntensity})`),a.addColorStop(1,"rgba(255, 150, 0, 0)"),e.fillStyle=a,e.beginPath(),e.arc(0,0,i,0,Math.PI*2),e.fill();const o=e.createRadialGradient(-s*.3,-s*.3,0,0,0,s);if(o.addColorStop(0,"#FFF8DC"),o.addColorStop(.3,"#FFD700"),o.addColorStop(.7,"#DAA520"),o.addColorStop(1,"#B8860B"),e.fillStyle=o,e.beginPath(),e.arc(0,0,s,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(139, 90, 43, 0.5)",e.lineWidth=1.5,e.beginPath(),e.arc(0,0,s*.7,0,Math.PI*2),e.stroke(),e.fillStyle="rgba(255, 255, 255, 0.6)",e.beginPath(),e.ellipse(-s*.25,-s*.25,s*.35,s*.2,-Math.PI/4,0,Math.PI*2),e.fill(),e.restore(),!this.landed)for(const r of this.sparkles){const l=this.x+Math.cos(r.angle)*r.dist*this.scale,c=this.y+Math.sin(r.angle)*r.dist*this.scale;e.fillStyle=`rgba(255, 255, 200, ${.8*this.glowIntensity})`,e.beginPath(),e.arc(l,c,r.size*this.scale,0,Math.PI*2),e.fill()}}}class lt{constructor(e,t={}){this.canvas=e,this.ctx=e.getContext("2d"),this.net=new Tt({url:t.wsUrl||"ws://localhost:8787/room/default",onStateChange:n=>this.handleStateChange(n),onInit:n=>this.handleInit(n),onFrame:n=>this.handleFrame(n),onEvent:n=>this.handleEvent(n),onError:n=>this.handleError(n)}),this.mapSize=0,this.playerId=null,this.players=new Map,this.coins=new Map,this.effects=[],this.cameraX=0,this.cameraY=0,this.cameraTargetX=0,this.cameraTargetY=0,this.cameraScale=1,this.mouseX=0,this.mouseY=0,this.targetAngle=0,this.mouseSet=!1,this.wasdKeys={w:!1,a:!1,s:!1,d:!1},this.useWasd=!1,this.wasdCurrentAngle=0,this.lastFrameTime=performance.now(),this.networkTickMs=100,this.interpolationDelay=this.networkTickMs,this.onDeath=t.onDeath||(()=>{}),this.onKill=t.onKill||(()=>{}),this.onLevelUp=t.onLevelUp||(()=>{}),this.debugMode=!1,this.lastNetworkUpdate=0,this.networkGaps=[],this.snipFuses=new Map,this._localSnippedPrev=!1,this.speedBuffState=new Map,this.speedSpikeState={active:!1,playerX:0,playerY:0,playerAngle:0,speedRatio:0,baseColor:null,pulsePhase:0},this.deathParticles=[],this.dyingPlayers=[],this.screenShake={x:0,y:0,intensity:0,decay:.92},this.captureEffects=[],this.levelUpEffects=[],this.lootCoins=[],this.animatingCoinIds=new Set,this.playerPortions=new Map,this.lastKillerName=null,this.lastKillerNum=null,this.recentDeaths=[],this.localOutlineThicken={active:!1,startTime:0,duration:500},this.lastCleanupTime=0,this.cleanupIntervalMs=2e3,this.handleMouseMove=this.handleMouseMove.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),this.gameLoop=this.gameLoop.bind(this),this.setupInput()}startSnipFuse(e,t){const n=this.players.get(e);if(!n)return;const s=n.trail||[],i=t===65535,a=e===this.playerId;let o,r=0;if(s.length>=2){let l={x:n.x,y:n.y};if(!i){const u=this.players.get(t);u&&(l={x:u.x,y:u.y})}const c=this._furthestHitOnTrailByPos(l,s,i?3:0);o=c.point||{x:s[0].x,y:s[0].y},r=c.index>=0?c.index:0}else s.length===1?(o={x:s[0].x,y:s[0].y},r=0):(o={x:n.x,y:n.y},r=0);this.snipFuses.set(e,{playerNum:e,snipperNum:t,startPoint:o,segmentIndex:r,elapsed:0,progressDist:0,fusePos:{x:o.x,y:o.y},ratio:0,remainingPoints:null,isLocalVictim:a,sawSnipped:!1})}_closestPointOnTrail(e,t){let n={dist2:1/0,point:null,index:0};for(let s=0;s<t.length-1;s++){const i=t[s],a=t[s+1],o=this._closestPointOnSegment(e,i,a),r=e.x-o.x,l=e.y-o.y,c=r*r+l*l;c<n.dist2&&(n={dist2:c,point:o,index:s})}return n}_furthestHitOnTrailByPos(e,t,n=0){const s=M.CELL_WIDTH/2;let i={dist2:1/0,point:null,index:-1};const a=Math.max(0,t.length-1-n);for(let o=0;o<a;o++){const r=t[o],l=t[o+1],c=this._closestPointOnSegment(e,r,l),u=e.x-c.x,f=e.y-c.y,p=u*u+f*f;p<s*s&&o>i.index&&(i={dist2:p,point:c,index:o})}return i.point===null?this._closestPointOnTrail(e,t):i}_closestPointOnSegment(e,t,n){const s=n.x-t.x,i=n.y-t.y,a=e.x-t.x,o=e.y-t.y,r=s*s+i*i;if(r===0)return{x:t.x,y:t.y};let l=(a*s+o*i)/r;return l=Math.max(0,Math.min(1,l)),{x:t.x+s*l,y:t.y+i*l}}_pointAtDistance(e,t){if(e.length===0)return null;if(e.length===1)return{x:e[0].x,y:e[0].y};let n=t;for(let s=0;s<e.length-1;s++){const i=e[s],a=e[s+1],o=Math.hypot(a.x-i.x,a.y-i.y);if(!(o<=1e-4)){if(n<=o){const r=n/o;return{x:i.x+(a.x-i.x)*r,y:i.y+(a.y-i.y)*r}}n-=o}}return{x:e[e.length-1].x,y:e[e.length-1].y}}_pointAtDistanceWithIndex(e,t){if(e.length===0)return{point:null,index:0};if(e.length===1)return{point:{x:e[0].x,y:e[0].y},index:0};let n=t;for(let s=0;s<e.length-1;s++){const i=e[s],a=e[s+1],o=Math.hypot(a.x-i.x,a.y-i.y);if(!(o<=1e-4)){if(n<=o){const r=n/o;return{point:{x:i.x+(a.x-i.x)*r,y:i.y+(a.y-i.y)*r},index:s}}n-=o}}return{point:{x:e[e.length-1].x,y:e[e.length-1].y},index:e.length-2}}_sumLength(e){let t=0;for(let n=0;n<e.length-1;n++)t+=Math.hypot(e[n+1].x-e[n].x,e[n+1].y-e[n].y);return t}updateSnipFuses(e){const t=e/1e3;for(const[i,a]of Array.from(this.snipFuses.entries())){const o=this.players.get(i);if(!o){this.snipFuses.delete(i);continue}if(o.isSnipped&&(a.sawSnipped=!0),a.sawSnipped&&!o.isSnipped){this.snipFuses.delete(i);continue}if(a.elapsed>10){this.snipFuses.delete(i);continue}if(!o.trail||o.trail.length<2){a.elapsed+=t;continue}a.elapsed+=t;const r=M.SPEED,l=M.SNIP_FUSE_SPEED_MULT,c=M.SNIP_EXP_ACCEL_PER_SEC,u=M.SNIP_GRACE_PERIOD,f=Math.max(0,a.elapsed-u),p=r*l*60,g=Math.exp(c*f);let T=p*g;const y=M.SNIP_FUSE_MAX_SPEED_MULT;T=Math.min(T,r*y*60),a.elapsed>u&&(a.progressDist+=T*t);const S=Math.max(0,Math.min(o.trail.length-2,a.segmentIndex)),v=[a.startPoint,...o.trail.slice(S+1),{x:o.x,y:o.y}],E=this._sumLength(v),_=Math.max(1,E);a.ratio=Math.max(0,Math.min(1,a.progressDist/_));const A=this._pointAtDistanceWithIndex(v,Math.min(a.progressDist,_));a.fusePos=A.point;const C=v.slice(A.index+1);a.remainingPoints=[a.fusePos,...C]}const n=this.players.get(this.playerId),s=!!(n&&n.isSnipped);if(s&&!this._localSnippedPrev&&kt(),!s&&this._localSnippedPrev&&Lt(),this._localSnippedPrev=s,s){const i=this.snipFuses.get(this.playerId);i&&Dt(i.ratio)}if(n){let i=null,a=1/0;for(const[r,l]of this.snipFuses){if(r===this.playerId)continue;const c=this.players.get(r);if(!c||!(c.isSnipped||!l.sawSnipped))continue;const f=l.fusePos.x-n.x,p=l.fusePos.y-n.y,g=Math.sqrt(f*f+p*p);g<a&&(a=g,i=l)}const o=i!==null&&a<800;o&&!xe()?Nt():!o&&xe()&&Ft(),o&&Vt(a,800)}}setupInput(){this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),this.canvas.addEventListener("touchstart",this.handleTouchMove,{passive:!1}),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp)}cleanupInput(){this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("touchmove",this.handleTouchMove),this.canvas.removeEventListener("touchstart",this.handleTouchMove),window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp)}handleKeyDown(e){const t=document.activeElement,n=t&&t.tagName?t.tagName.toLowerCase():"";if(n==="input"||n==="textarea"||n==="select"||e.repeat)return;const s=(e.key||"").toLowerCase();if(e.key==="F3"){this.debugMode=!this.debugMode,console.log("Debug mode:",this.debugMode?"ON":"OFF");return}if(s==="r"){console.log("%cðŸ”„ RESETTING ROOM...","color: orange; font-weight: bold;"),this.net.sendReset();return}(s==="w"||s==="a"||s==="s"||s==="d")&&this.setKeyState(s,!0)}handleKeyUp(e){const t=(e.key||"").toLowerCase();(t==="w"||t==="a"||t==="s"||t==="d")&&this.setKeyState(t,!1)}setKeyState(e,t){const n=(e||"").toLowerCase();n in this.wasdKeys&&(this.wasdKeys[n]=!!t,this.useWasd=!!(this.wasdKeys.w||this.wasdKeys.a||this.wasdKeys.s||this.wasdKeys.d))}handleMouseMove(e){const t=this.canvas.getBoundingClientRect();this.mouseX=e.clientX-t.left,this.mouseY=e.clientY-t.top,this.mouseSet=!0,this.updateTargetAngle()}handleTouchMove(e){if(e.preventDefault(),e.touches.length>0){const t=this.canvas.getBoundingClientRect();this.mouseX=e.touches[0].clientX-t.left,this.mouseY=e.touches[0].clientY-t.top,this.mouseSet=!0,this.updateTargetAngle()}}updateTargetAngle(){const e=this.players.get(this.playerId);if(!e)return;const t=this.cameraX+(this.mouseX-this.canvas.width/2)/this.cameraScale,n=this.cameraY+(this.mouseY-this.canvas.height/2)/this.cameraScale;this.targetAngle=Math.atan2(n-e.y,t-e.x),this.useWasd||(this.wasdCurrentAngle=this.targetAngle)}connect(e){this.playerName=e,this.net.connect(e)}connectSpectate(){this.spectateMode=!0,this.net.connectSpectate()}disconnect(){this.net.disconnect(),this.stopGameLoop(),this.cleanupInput()}handleStateChange(e){console.log("Connection state:",e)}handleInit(e){this.playerId=e.playerId,this.mapSize=e.mapSize,this.players.clear(),this.coins.clear(),this.effects=[];for(const t of e.players)this.players.set(t.num,new Te(t));for(const t of e.coins)this.coins.set(t.id,new Re(t));if(this.spectateMode){this.cameraX=this.mapSize/2,this.cameraY=this.mapSize/2,this.cameraTargetX=this.mapSize/2,this.cameraTargetY=this.mapSize/2;const t=50;this.cameraScale=Math.min(this.canvas.width/(this.mapSize+t*2),this.canvas.height/(this.mapSize+t*2))}else{const t=this.players.get(this.playerId);t&&(this.cameraX=t.x,this.cameraY=t.y,this.cameraTargetX=t.x,this.cameraTargetY=t.y)}this.startGameLoop()}handleFrame(e){const t=performance.now();if(this.lastNetworkUpdate){const n=t-this.lastNetworkUpdate;this.networkGaps.push(n),this.networkGaps.length>20&&this.networkGaps.shift(),n>150&&this.debugMode&&console.warn(`[NET] Long gap between updates: ${n.toFixed(0)}ms`)}if(this.lastNetworkUpdate=t,e.selfPlayer){let n=this.players.get(e.selfPlayer.num);n?n.update(e.selfPlayer,!0):(n=new Te(e.selfPlayer),this.players.set(e.selfPlayer.num,n))}for(const n of e.newPlayers)this.players.has(n.num)||this.players.set(n.num,new Te(n));for(const n of e.updatedPlayers){const s=this.players.get(n.num);s&&s.update(n,!1)}this.coins.clear();for(const n of e.coins)this.coins.set(n.id,new Re(n));for(const n of e.events)this.handleEvent(n);for(const n of e.removedPlayerIds)this.players.delete(n),this.snipFuses.delete(n),this.speedBuffState.delete(n)}handleEvent(e){switch(e.type){case I.HITSCAN:this.addHitscanEffect(e);break;case I.PLAYER_KILL:{const t=this.players.get(e.victimNum),n=this.players.get(e.killerNum),s=e.victimNum===this.playerId;s&&n&&(this.lastKillerName=n.name||"Unknown",this.lastKillerNum=e.killerNum),t&&this.spawnDeathEffect(t,s),s?this.onDeath(e):e.killerNum===this.playerId&&this.onKill(e);break}case I.LEVEL_UP:{const t=this.players.get(e.playerNum),n=e.playerNum===this.playerId;t&&this.spawnLevelUpEffect(t.x,t.y,e.newLevel,t,n),n&&this.onLevelUp(e);break}case I.PLAYER_JOIN:e.player&&!this.players.has(e.player.num)&&this.players.set(e.player.num,new Te(e.player));break;case I.PLAYER_LEAVE:this.players.delete(e.num);break;case I.COIN_SPAWN:{this.coins.set(e.id,new Re(e));const t=performance.now();for(const n of this.recentDeaths)if(Math.hypot(e.x-n.x,e.y-n.y)<150&&t-n.time<500){const i=new Wt(n.x,n.y,e.x,e.y,e.value||5,e.id);this.lootCoins.push(i),this.animatingCoinIds.add(e.id);break}break}case I.COIN_PICKUP:this.coins.delete(e.id),this.animatingCoinIds.delete(e.id),e.playerNum===this.playerId&&Ct();break;case I.SNIP_START:this.startSnipFuse(e.playerNum,e.snipperNum);break;case I.CAPTURE:{const t=this.players.get(e.playerNum),n=e.playerNum===this.playerId;console.log("[CAPTURE] Event received:",e,"isLocal:",n,"player:",t),t&&this.spawnCaptureEffect(e.x,e.y,e.xpGained,t,n);break}case"dead":{const t=this.players.get(this.playerId);t&&this.spawnDeathEffect(t,!0),this.onDeath(e);break}}}addHitscanEffect(e){const t=this.players.get(e.ownerNum),n=this.players.get(e.targetNum);if(!t||!n)return;const s=t.base;let i=t.x,a=t.y;if(t.drones.length>0){const r=t.drones[Math.floor(Math.random()*t.drones.length)];i=r.x,a=r.y}this.effects.push(new Gt(i,a,n.x,n.y,s));const o=this.players.get(this.playerId);if(o)if(e.ownerNum===this.playerId)Et();else{const r=Math.hypot(i-o.x,a-o.y);At(r)}}handleError(e){console.error("Network error:",e)}startGameLoop(){this.running=!0,this.lastFrameTime=performance.now(),requestAnimationFrame(this.gameLoop)}stopGameLoop(){this.running=!1}gameLoop(e){if(!this.running)return;const t=e-this.lastFrameTime;this.lastFrameTime=e,this.update(t),this.render(),this.net.flushInput(),requestAnimationFrame(this.gameLoop)}update(e){const t=this.players.get(this.playerId);if(!this.spectateMode&&t&&!t.dead){const s=this.computeInputAngle(t,e);typeof s=="number"&&Number.isFinite(s)&&(this.targetAngle=s,this.net.sendInput(this.targetAngle))}for(const[s,i]of this.players)!this.spectateMode&&s===this.playerId&&t&&!t.dead?i.predict(e,M.SPEED,this.mapSize,this.targetAngle):i.interpolateOther(e,M.SPEED);if(this.spectateMode){this.cameraX=this.mapSize/2,this.cameraY=this.mapSize/2;const s=50;this.cameraScale=Math.min(this.canvas.width/(this.mapSize+s*2),this.canvas.height/(this.mapSize+s*2))}else if(t){this.cameraTargetX=t.x,this.cameraTargetY=t.y;const s=.15;this.cameraX+=(this.cameraTargetX-this.cameraX)*s,this.cameraY+=(this.cameraTargetY-this.cameraY)*s}this.updateSnipFuses(e),this.updateSpeedBuffEffects(e),this.updateDeathEffects(),this.updateCaptureEffects(),this.updateLevelUpEffects(),this.updateLootCoins(),this.updateTerritoryPortions(),this.effects=this.effects.filter(s=>!s.isExpired());const n=performance.now();n-this.lastCleanupTime>this.cleanupIntervalMs&&(this.lastCleanupTime=n,this.cleanupOrphanedState())}cleanupOrphanedState(){for(const[t,n]of Array.from(this.snipFuses.entries())){if(!this.players.get(t)){this.snipFuses.delete(t);continue}n.elapsed>5&&!n.sawSnipped&&this.snipFuses.delete(t)}for(const[t]of Array.from(this.speedBuffState.entries()))this.players.has(t)||this.speedBuffState.delete(t);for(const[,t]of this.players){if(t.dead){t.trail=[],t.territory=[];continue}if(t.trail&&t.trail.length>0&&!t.isSnipped){const n=t.trail[0],s=n.x-t.x,i=n.y-t.y;Math.sqrt(s*s+i*i)>500&&(t.trail=[])}if(t.territory&&t.territory.length>3){let n=0,s=0;for(const r of t.territory)n+=r.x,s+=r.y;n/=t.territory.length,s/=t.territory.length;const i=t.x-n,a=t.y-s;Math.sqrt(i*i+a*a)>1e3&&(t.territory=[])}}const e=performance.now()-5e3;this.dyingPlayers=this.dyingPlayers.filter(t=>t.deathTime>e)}calculateSpeedBuff(e){const t=M.TRAIL_SPEED_BUFF_MAX,n=M.TRAIL_SPEED_BUFF_RAMP_TIME,s=M.TRAIL_SPEED_BUFF_EASE,i=Math.min(1,e/n),a=Math.pow(i,s);return 1+(t-1)*a}pointInPolygon(e,t,n){if(!n||n.length<3)return!1;let s=!1;for(let i=0,a=n.length-1;i<n.length;a=i++){const o=n[i].x,r=n[i].y,l=n[a].x,c=n[a].y;r>t!=c>t&&e<(l-o)*(t-r)/(c-r)+o&&(s=!s)}return s}updateSpeedBuffEffects(e){const n=performance.now();for(const[i,a]of this.players){if(a.dead)continue;let o=this.speedBuffState.get(i);o||(o={trailStartTime:null,lastSpeedBuff:1,speedRushActive:!1},this.speedBuffState.set(i,o));const r=a.trail&&a.trail.length>0;if(a.isSnipped){o.trailStartTime=null,o.lastSpeedBuff=1,i===this.playerId&&o.speedRushActive&&(Ie(),o.speedRushActive=!1);continue}if(r){o.trailStartTime===null&&(o.trailStartTime=n);const c=(n-o.trailStartTime)/1e3,u=this.calculateSpeedBuff(c);o.lastSpeedBuff=u;const f=M.TRAIL_SPEED_BUFF_MAX;a._speedRatio=Math.min(1,Math.max(0,(u-1.1)/(f-1.1))),a._hasSpeedBuff=u>=1.1,i===this.playerId&&(u>=1.1?(o.speedRushActive||(Ut(),o.speedRushActive=!0),Ot(u)):o.speedRushActive&&(Ie(),o.speedRushActive=!1))}else o.trailStartTime=null,o.lastSpeedBuff=1,a._speedRatio=0,a._hasSpeedBuff=!1,i===this.playerId&&o.speedRushActive&&(Ie(),o.speedRushActive=!1)}const s=this.players.get(this.playerId);if(s&&s._hasSpeedBuff){const i=6+(s._speedRatio||0)*8;this.speedSpikeState.pulsePhase+=i*(e/1e3),this.speedSpikeState.active=!0}else this.speedSpikeState.active=!1}spawnDeathEffect(e,t=!1){const n=e.x,s=e.y,i=e.base?e.base.rgbString():"#ff4444",a=e.base?e.base.lighter(.3).rgbString():"#ff8888";this.recentDeaths.push({x:n,y:s,time:performance.now()});const o=performance.now();this.recentDeaths=this.recentDeaths.filter(c=>o-c.time<2e3);const r=t?40:25;for(let c=0;c<r;c++)this.deathParticles.push(new Z(n,s,i,"burst"));const l=t?20:12;for(let c=0;c<l;c++)this.deathParticles.push(new Z(n,s,a,"spark"));if(this.deathParticles.push(new Z(n,s,i,"ring")),t&&setTimeout(()=>{this.deathParticles.push(new Z(n,s,a,"ring"))},100),e.territory&&e.territory.length>3){const c=t?15:8;for(let u=0;u<c;u++){const f=Math.floor(Math.random()*e.territory.length),p=e.territory[f];this.deathParticles.push(new Z(p.x,p.y,i,"shard"))}}if(t&&(this.screenShake.intensity=25),this.dyingPlayers.push({num:e.num,x:e.x,y:e.y,angle:e.angle,color:e.base,sizeScale:e.sizeScale||1,territory:e.territory?[...e.territory]:[],trail:e.trail?[...e.trail]:[],deathTime:performance.now(),dissolveProgress:0}),t)Be(!0);else{const c=this.players.get(this.playerId);if(c){const u=e.x-c.x,f=e.y-c.y,p=Math.sqrt(u*u+f*f);Be(!1,p)}}}updateDeathEffects(){for(let t=this.deathParticles.length-1;t>=0;t--)this.deathParticles[t].update()||this.deathParticles.splice(t,1);this.screenShake.intensity>.5?(this.screenShake.x=(Math.random()-.5)*this.screenShake.intensity*2,this.screenShake.y=(Math.random()-.5)*this.screenShake.intensity*2,this.screenShake.intensity*=this.screenShake.decay):(this.screenShake.x=0,this.screenShake.y=0,this.screenShake.intensity=0);const e=performance.now();for(let t=this.dyingPlayers.length-1;t>=0;t--){const n=this.dyingPlayers[t];n.dissolveProgress=Math.min(1,(e-n.deathTime)/1500),n.dissolveProgress>=1&&this.dyingPlayers.splice(t,1)}}renderDeathParticles(e){for(const t of this.deathParticles)t.render(e)}spawnCaptureEffect(e,t,n,s,i){this.captureEffects.push(new zt(e,t,n,s,i)),i&&(this.localOutlineThicken.active=!0,this.localOutlineThicken.startTime=performance.now()),i&&It()}updateCaptureEffects(){for(let e=this.captureEffects.length-1;e>=0;e--)this.captureEffects[e].update()||this.captureEffects.splice(e,1);this.localOutlineThicken.active&&performance.now()-this.localOutlineThicken.startTime>=this.localOutlineThicken.duration&&(this.localOutlineThicken.active=!1)}renderCaptureEffects(e){for(const t of this.captureEffects)t.render(e)}spawnLevelUpEffect(e,t,n,s,i){const a=i?30:8;for(let o=0;o<a;o++)this.deathParticles.push(new Z(e,t,"#FFD700","burst"));this.deathParticles.push(new Z(e,t,"#FFD700","ring")),i&&(this.screenShake.intensity=10,this.levelUpEffects.push(new Ht(e,t,n,s,i)),Rt())}updateLevelUpEffects(){for(let e=this.levelUpEffects.length-1;e>=0;e--)this.levelUpEffects[e].update()||this.levelUpEffects.splice(e,1)}renderLevelUpEffects(e){for(const t of this.levelUpEffects)t.render(e)}updateLootCoins(){for(let e=this.lootCoins.length-1;e>=0;e--){const t=this.lootCoins[e];t.update()||(t.coinId!==null&&this.animatingCoinIds.delete(t.coinId),this.lootCoins.splice(e,1))}}renderLootCoins(e){for(const t of this.lootCoins)t.render(e)}updateTerritoryPortions(){const e=this.mapSize*this.mapSize;for(const[t,n]of this.players)if(n.territory&&n.territory.length>=3){const s=this.polygonArea(n.territory);this.playerPortions.set(t,s/e)}else this.playerPortions.set(t,0)}polygonArea(e){if(!e||e.length<3)return 0;let t=0;for(let n=0,s=e.length-1;n<e.length;s=n++)t+=(e[s].x+e[n].x)*(e[s].y-e[n].y);return Math.abs(t/2)}getTerritoryPercent(e){return(this.playerPortions.get(e)||0)*100}getLeaderboard(){const e=[];for(const[t,n]of this.players)e.push({player:n,portion:this.playerPortions.get(t)||0});return e.sort((t,n)=>n.portion-t.portion),e}getOutlineThickness(e){if(e===this.playerId&&this.localOutlineThicken.active){const t=performance.now()-this.localOutlineThicken.startTime;return 1+2*(1-Math.min(1,t/this.localOutlineThicken.duration))}return 1}getDissolveProgress(e){const t=this.dyingPlayers.find(n=>n.num===e);return t?t.dissolveProgress:0}renderDyingPlayers(e){for(const t of this.dyingPlayers){if(t.dissolveProgress>=1)continue;const n=Math.max(0,1-t.dissolveProgress),s=t.color;if(!s)continue;if(e.save(),e.globalAlpha=n,t.territory&&t.territory.length>=3){e.fillStyle=s.deriveAlpha(.4*n).rgbString(),e.beginPath(),e.moveTo(t.territory[0].x,t.territory[0].y);for(let r=1;r<t.territory.length;r++)e.lineTo(t.territory[r].x,t.territory[r].y);e.closePath(),e.fill(),e.strokeStyle=s.deriveAlpha(.9*n).rgbString(),e.lineWidth=2.5,e.stroke()}if(t.trail&&t.trail.length>=2){const r=s.lighter(.2);e.strokeStyle=r.deriveAlpha(n).rgbString(),e.lineWidth=te,e.lineCap="round",e.lineJoin="round",e.beginPath(),e.moveTo(t.trail[0].x,t.trail[0].y);for(let l=1;l<t.trail.length;l++)e.lineTo(t.trail[l].x,t.trail[l].y);e.lineTo(t.x,t.y),e.stroke()}const i=te*t.sizeScale;e.fillStyle=s.darker(.3).deriveAlpha(n).rgbString(),e.beginPath(),e.arc(t.x+2,t.y+4,i,0,Math.PI*2),e.fill(),e.fillStyle=s.deriveAlpha(n).rgbString(),e.beginPath(),e.arc(t.x,t.y,i,0,Math.PI*2),e.fill();const a=t.x+Math.cos(t.angle)*i*.6,o=t.y+Math.sin(t.angle)*i*.6;e.fillStyle=s.lighter(.1).deriveAlpha(n).rgbString(),e.beginPath(),e.arc(a,o,i*.3,0,Math.PI*2),e.fill(),e.restore()}}computeInputAngle(e,t){if(this.useWasd){let r=0,l=0;if(this.wasdKeys.w&&(l-=1),this.wasdKeys.s&&(l+=1),this.wasdKeys.a&&(r-=1),this.wasdKeys.d&&(r+=1),r===0&&l===0)return null;const c=Math.atan2(l,r);let u=c-this.wasdCurrentAngle;for(;u>Math.PI;)u-=Math.PI*2;for(;u<-Math.PI;)u+=Math.PI*2;const f=.15*(t/16.67);for(Math.abs(u)<=f?this.wasdCurrentAngle=c:this.wasdCurrentAngle+=Math.sign(u)*f;this.wasdCurrentAngle>Math.PI;)this.wasdCurrentAngle-=Math.PI*2;for(;this.wasdCurrentAngle<-Math.PI;)this.wasdCurrentAngle+=Math.PI*2;return this.wasdCurrentAngle}if(!this.mouseSet)return null;const n=this.cameraX+(this.mouseX-this.canvas.width/2)/this.cameraScale,s=this.cameraY+(this.mouseY-this.canvas.height/2)/this.cameraScale,i=n-e.x,a=s-e.y;if(i*i+a*a<100)return null;const o=Math.atan2(a,i);return this.wasdCurrentAngle=o,o}render(){const e=this.ctx,t=this.canvas.width,n=this.canvas.height,s=n-X;e.fillStyle="#e2ebf3",e.fillRect(0,0,t,n),e.save(),e.translate(0,X),e.beginPath(),e.rect(0,0,t,s),e.clip(),e.translate(t/2+this.screenShake.x,s/2+this.screenShake.y),e.scale(this.cameraScale,this.cameraScale),e.translate(-this.cameraX,-this.cameraY),this.drawGrid(e);const i=Array.from(this.players.values()).sort((a,o)=>a.num-o.num);for(const a of i)this.drawTerritory(e,a);for(const a of this.coins.values())this.animatingCoinIds.has(a.id)||this.drawCoin(e,a);for(const a of i)this.drawTrail(e,a);for(const a of i)!a.dead&&a._hasSpeedBuff&&this.drawSpeedSpikes(e,a);for(const a of i)a.dead||this.drawPlayer(e,a);this.renderDyingPlayers(e);for(const a of this.effects)this.drawHitscan(e,a);this.renderCaptureEffects(e),this.renderLevelUpEffects(e),this.renderLootCoins(e),this.renderDeathParticles(e),e.restore(),this.drawTopBar(e),this.drawLeaderboard(e),this.drawXPBar(e),this.debugMode&&this.drawDebugHUD(e)}drawDebugHUD(e){let n=150;const s=16;e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(5,n-15,250,180),e.fillStyle="#00ff00",e.font="12px monospace",e.textAlign="left",e.fillText("=== DEBUG MODE (press D to toggle) ===",10,n),n+=s;let i=0,a=0,o=0;for(const[p,g]of this.players){if(p===this.playerId||g.dead)continue;const T=g.serverX-g.x,y=g.serverY-g.y,S=Math.sqrt(T*T+y*y);i+=S,a=Math.max(a,S),o++}const r=o>0?i/o:0;e.fillText(`Players: ${this.players.size} (${o} others)`,10,n),n+=s,e.fillText(`Avg position error: ${r.toFixed(1)}px`,10,n),n+=s,e.fillText(`Max position error: ${a.toFixed(1)}px`,10,n),n+=s;const l=this.networkGaps.length>0?this.networkGaps.reduce((p,g)=>p+g,0)/this.networkGaps.length:0,c=this.networkGaps.length>0?Math.max(...this.networkGaps):0,u=performance.now()-this.lastNetworkUpdate;e.fillText(`Net update gap: avg ${l.toFixed(0)}ms, max ${c.toFixed(0)}ms`,10,n),n+=s,e.fillStyle=u>150?"#ff0000":"#00ff00",e.fillText(`Time since last update: ${u.toFixed(0)}ms`,10,n),e.fillStyle="#00ff00",n+=s;const f=this.players.get(this.playerId);if(f){n+=s,e.fillStyle="#ffff00",e.fillText("--- Local Player ---",10,n),n+=s,e.fillStyle="#00ff00",e.fillText(`Pos: (${f.x.toFixed(1)}, ${f.y.toFixed(1)})`,10,n),n+=s,e.fillText(`Server: (${f.serverX.toFixed(1)}, ${f.serverY.toFixed(1)})`,10,n),n+=s;const p=Math.sqrt(Math.pow(f.serverX-f.x,2)+Math.pow(f.serverY-f.y,2));e.fillText(`Correction offset: ${p.toFixed(1)}px`,10,n)}}drawGrid(e){const t=this.mapSize,n=M.BORDER_WIDTH;e.fillStyle="rgb(211, 225, 237)",e.fillRect(0,0,t,t),e.strokeStyle="rgba(180, 200, 220, 0.5)",e.lineWidth=1;const s=M.CELL_WIDTH*2;e.beginPath();for(let i=0;i<=t;i+=s)e.moveTo(i,0),e.lineTo(i,t);for(let i=0;i<=t;i+=s)e.moveTo(0,i),e.lineTo(t,i);e.stroke(),e.fillStyle="lightgray",e.fillRect(-n,0,n,t),e.fillRect(-n,-n,t+n*2,n),e.fillRect(t,0,n,t),e.fillRect(-n,t,t+n*2,n)}drawTerritory(e,t){if(!t.territory||t.territory.length<3)return;const n=t.base,s=t.isSnipped;let i=1;if(s){const o=Date.now()/100;i=.3+.5*(.5+.5*Math.sin(o*4))}e.fillStyle=n.deriveAlpha(.4*i).rgbString(),e.beginPath(),e.moveTo(t.territory[0].x,t.territory[0].y);for(let o=1;o<t.territory.length;o++)e.lineTo(t.territory[o].x,t.territory[o].y);e.closePath(),e.fill();const a=this.getOutlineThickness(t.num);e.strokeStyle=n.deriveAlpha(.9*i).rgbString(),e.lineWidth=2.5*a,e.lineJoin="round",e.lineCap="round",e.stroke()}drawTrail(e,t){if(!t.trail||t.trail.length<1)return;const s=t.base.lighter(.2);e.strokeStyle=s.rgbString(),e.lineWidth=te,e.lineCap="round",e.lineJoin="round";const i=t.x,a=t.y,o=this.snipFuses.get(t.num);if(o&&(t.isSnipped||!o.sawSnipped)){if(o.remainingPoints&&o.remainingPoints.length>=2&&o.fusePos){e.beginPath(),e.moveTo(o.remainingPoints[0].x,o.remainingPoints[0].y);for(let l=1;l<o.remainingPoints.length;l++)e.lineTo(o.remainingPoints[l].x,o.remainingPoints[l].y);e.stroke(),this._drawFuseSpark(e,o.fusePos,o.remainingPoints,t.num);return}if(t.trail&&t.trail.length>=1){const l=M.SPEED,c=M.SNIP_FUSE_SPEED_MULT,f=l*c*60*o.elapsed,p=[...t.trail,{x:t.x,y:t.y}],g=this._sumLength(p),T=Math.min(f,g),y=this._pointAtDistanceWithIndex(p,T);if(y.point){const S=p.slice(y.index+1),v=[y.point,...S];if(v.length>=2){e.beginPath(),e.moveTo(v[0].x,v[0].y);for(let E=1;E<v.length;E++)e.lineTo(v[E].x,v[E].y);e.stroke(),this._drawFuseSpark(e,y.point,v,t.num);return}}}if(t.trail&&t.trail.length>=1){const l={x:t.trail[0].x,y:t.trail[0].y};e.beginPath(),e.moveTo(t.trail[0].x,t.trail[0].y);for(let c=1;c<t.trail.length;c++)e.lineTo(t.trail[c].x,t.trail[c].y);e.lineTo(i,a),e.stroke(),this._drawFuseSpark(e,l,t.trail,t.num);return}}e.beginPath(),e.moveTo(t.trail[0].x,t.trail[0].y);for(let l=1;l<t.trail.length-1;l++)e.lineTo(t.trail[l].x,t.trail[l].y);if(t.trail.length>1){const l=t.trail[t.trail.length-1];if(Math.hypot(l.x-i,l.y-a)>te*2){const u=l.x+(i-l.x)*.5,f=l.y+(a-l.y)*.5;e.lineTo(u,f)}}e.lineTo(i,a),e.stroke()}_sparkDirection(e){if(!e||e.length<2)return 0;const t=e[0],n=e[1];return Math.atan2(n.y-t.y,n.x-t.x)}_drawFuseSpark(e,t,n,s){const i=performance.now(),a=.75+.25*Math.sin(i*.02+s),o=te*.6*a;e.save(),e.globalCompositeOperation="lighter";const r=e.createRadialGradient(t.x,t.y,0,t.x,t.y,o*2);r.addColorStop(0,"rgba(255,255,200,0.95)"),r.addColorStop(.35,"rgba(255,180,60,0.65)"),r.addColorStop(1,"rgba(255,40,0,0)"),e.fillStyle=r,e.beginPath(),e.arc(t.x,t.y,o*2,0,Math.PI*2),e.fill();const l=this._sparkDirection(n);for(let c=0;c<6;c++){const u=(c*.9+i*.03+s)%(Math.PI*2),f=l+Math.sin(u)*.7,p=o*2.2*(.4+.6*((Math.sin(u*1.7)+1)*.5)),g=t.x+Math.cos(f)*p,T=t.y+Math.sin(f)*p;e.strokeStyle="rgba(255,200,80,0.9)",e.lineWidth=2,e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(g,T),e.stroke()}e.restore()}drawSpeedSpikes(e,t){const n=t._speedRatio||0;if(n<=0)return;const s=t.x,i=t.y,a=t.angle,o=t.base,r=this.speedSpikeState.pulsePhase,l=3+Math.floor(n*2),c=.8+n*.6,u=18+n*25,f=8+n*6,p=12,g=o.lighter(.3).rgbString(),T=o.rgbString();e.save();for(let y=0;y<l;y++){const S=l>1?y/(l-1)-.5:0,v=a+Math.PI+S*c,E=y/l*Math.PI*2,A=.4+(Math.sin(r+E)*.5+.5)*.6,C=u*A,W=f*A;if(C<3)continue;const oe=s+Math.cos(v)*p,re=i+Math.sin(v)*p,Pe=oe+Math.cos(v)*C,Ee=re+Math.sin(v)*C,ge=v+Math.PI/2,ye=W/2,Ve=(.6+n*.3)*(.6+A*.4);e.globalAlpha=Ve;const Se=e.createLinearGradient(oe,re,Pe,Ee);Se.addColorStop(0,g),Se.addColorStop(.4,T),Se.addColorStop(1,"rgba(0, 0, 0, 0)"),e.fillStyle=Se,e.beginPath(),e.moveTo(oe+Math.cos(ge)*ye,re+Math.sin(ge)*ye),e.lineTo(oe-Math.cos(ge)*ye,re-Math.sin(ge)*ye),e.lineTo(Pe,Ee),e.closePath(),e.fill(),e.globalAlpha=Ve*.7,e.strokeStyle=g,e.lineWidth=Math.max(1,W*.25),e.lineCap="round",e.beginPath(),e.moveTo(oe,re),e.lineTo(Pe,Ee),e.stroke()}e.restore()}drawCoin(e,t){const n=M.COIN_RADIUS;e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.arc(t.x+2,t.y+2,n,0,Math.PI*2),e.fill(),e.fillStyle="#FFD700",e.shadowBlur=5,e.shadowColor="rgba(0, 0, 0, 0.3)",e.beginPath(),e.arc(t.x,t.y,n,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="rgba(255, 255, 255, 0.6)",e.beginPath(),e.arc(t.x-n*.3,t.y-n*.3,n*.3,0,Math.PI*2),e.fill()}drawPlayer(e,t){const n=te*(t.sizeScale||1),s=t.base,i=s.darker(.3),a=s.lighter(.1),o=t.isSnipped;let r=1;if(o){const u=Date.now()/100;r=.3+.5*(.5+.5*Math.sin(u*4))}t.num===this.playerId&&t.drones&&t.drones.length>0&&this.drawDroneRangeIndicator(e,t);for(const u of t.drones)this.drawDrone(e,u,s,t);if(e.fillStyle=i.deriveAlpha(r).rgbString(),e.beginPath(),e.arc(t.x+2,t.y+4,n,0,Math.PI*2),e.fill(),o){const u=.5+.5*Math.sin(Date.now()/100*4);e.fillStyle=`rgba(255, ${Math.floor(100*u)}, ${Math.floor(100*u)}, ${r})`}else e.fillStyle=s.rgbString();if(e.beginPath(),e.arc(t.x,t.y,n,0,Math.PI*2),e.fill(),o){const u=.5+.5*Math.sin(Date.now()/100*6);e.strokeStyle=`rgba(255, 50, 50, ${.5+.5*u})`,e.lineWidth=3+2*u,e.beginPath(),e.arc(t.x,t.y,n+4+2*u,0,Math.PI*2),e.stroke()}const l=t.x+Math.cos(t.angle)*n*.6,c=t.y+Math.sin(t.angle)*n*.6;if(e.fillStyle=a.deriveAlpha(r).rgbString(),e.beginPath(),e.arc(l,c,n*.3,0,Math.PI*2),e.fill(),t.hp<t.maxHp){const u=n*2.5,f=6*(t.sizeScale||1),p=t.x-u/2,g=t.y+n+8;e.fillStyle="rgba(20, 20, 20, 0.8)",e.fillRect(p,g,u,f);const T=Math.max(0,t.hp/t.maxHp);T>.5?e.fillStyle="#44ff44":T>.25?e.fillStyle="#ffcc00":e.fillStyle="#ff4444",e.fillRect(p,g,u*T,f),e.strokeStyle="rgba(0, 0, 0, 0.8)",e.lineWidth=Math.max(1,1.5*(t.sizeScale||1));for(let y=1;y<=3;y++){const S=p+u*y/4;e.beginPath(),e.moveTo(S,g),e.lineTo(S,g+f),e.stroke()}e.strokeStyle="#000000",e.lineWidth=Math.max(1,2*(t.sizeScale||1)),e.strokeRect(p,g,u,f)}if(e.fillStyle=i.rgbString(),e.textAlign="center",e.font="bold 14px Arial",o&&(e.fillStyle="rgba(255, 50, 50, 1)",e.fillText("SNIPPED!",t.x,t.y-n-22),e.fillStyle=i.deriveAlpha(r).rgbString()),e.fillText(t.name,t.x,t.y-n-8),this.debugMode&&t.num!==this.playerId){e.strokeStyle="rgba(0, 255, 0, 0.8)",e.lineWidth=2,e.beginPath(),e.arc(t.serverX,t.serverY,n+5,0,Math.PI*2),e.stroke();const u=t.serverX-t.x,f=t.serverY-t.y,p=Math.sqrt(u*u+f*f);p>1&&(e.strokeStyle="rgba(255, 0, 0, 0.8)",e.lineWidth=2,e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(t.serverX,t.serverY),e.stroke()),e.strokeStyle="rgba(0, 100, 255, 0.8)",e.lineWidth=2,e.beginPath(),e.moveTo(t.serverX,t.serverY),e.lineTo(t.serverX+Math.cos(t.serverAngle)*40,t.serverY+Math.sin(t.serverAngle)*40),e.stroke(),e.fillStyle="rgba(255, 255, 0, 1)",e.font="10px monospace",e.fillText(`err: ${p.toFixed(1)}px`,t.x,t.y+n+25)}}drawDroneRangeIndicator(e,t){const n=M.DRONE_RANGE;e.save();const s=Date.now()/1e3;e.strokeStyle="rgba(0, 0, 0, 0.2)",e.lineWidth=3,e.setLineDash([10,10]),e.lineDashOffset=-s*30,e.beginPath(),e.arc(t.x,t.y,n,0,Math.PI*2),e.stroke(),e.restore()}drawDrone(e,t,n,s){const i=Bt,a=s&&s.isSnipped,o=s&&s.num===this.playerId;if(e.save(),e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.arc(t.x+2,t.y+2,i,0,Math.PI*2),e.fill(),t.targetId!==null&&!a){const r=Date.now()/150,l=.4+.3*Math.sin(r*4);e.shadowBlur=12*l,e.shadowColor=o?"#FFD700":n?n.rgbString():"#FF6600"}if(a?e.fillStyle="rgba(100, 100, 100, 0.5)":n?e.fillStyle=n.deriveAlpha(o?.95:.8).rgbString():e.fillStyle=o?"rgba(100, 200, 100, 0.95)":"rgba(200, 100, 100, 0.8)",e.beginPath(),e.arc(t.x,t.y,i,0,Math.PI*2),e.fill(),a?e.strokeStyle="rgba(60, 60, 60, 0.6)":e.strokeStyle=n?n.darker(.2).rgbString():"#444",e.lineWidth=2,e.stroke(),e.shadowBlur=0,a?e.fillStyle="rgba(80, 80, 80, 0.4)":e.fillStyle=n?n.lighter(.3).deriveAlpha(.7).rgbString():"rgba(255, 255, 255, 0.5)",e.beginPath(),e.arc(t.x-i*.25,t.y-i*.25,i*.35,0,Math.PI*2),e.fill(),t.targetId!==null&&!a){const r=Date.now()/100,l=.5+.5*Math.sin(r*5);e.fillStyle=`rgba(255, 100, 100, ${.6+.4*l})`,e.beginPath(),e.arc(t.x,t.y,i*.3,0,Math.PI*2),e.fill()}if(a){e.strokeStyle="rgba(255, 80, 80, 0.8)",e.lineWidth=2,e.lineCap="round";const r=i*.5;e.beginPath(),e.moveTo(t.x-r,t.y-r),e.lineTo(t.x+r,t.y+r),e.moveTo(t.x+r,t.y-r),e.lineTo(t.x-r,t.y+r),e.stroke()}e.restore()}drawHitscan(e,t){const n=t.getAlpha(),s=t.color;e.save(),e.lineCap="round",e.lineWidth=12*n,e.strokeStyle=s.deriveAlpha(.5*n).rgbString(),e.beginPath(),e.moveTo(t.fromX,t.fromY),e.lineTo(t.toX,t.toY),e.stroke(),e.lineWidth=5*n,e.strokeStyle=s.lighter(.4).deriveAlpha(.95*n).rgbString(),e.beginPath(),e.moveTo(t.fromX,t.fromY),e.lineTo(t.toX,t.toY),e.stroke(),e.lineWidth=2*n,e.strokeStyle=`rgba(255, 255, 255, ${n})`,e.beginPath(),e.moveTo(t.fromX,t.fromY),e.lineTo(t.toX,t.toY),e.stroke();const i=20*n,a=e.createRadialGradient(t.toX,t.toY,0,t.toX,t.toY,i);a.addColorStop(0,s.lighter(.6).deriveAlpha(n).rgbString()),a.addColorStop(.4,s.deriveAlpha(.6*n).rgbString()),a.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=a,e.beginPath(),e.arc(t.toX,t.toY,i,0,Math.PI*2),e.fill(),e.restore()}drawTopBar(e){const t=this.players.get(this.playerId);if(!t)return;e.fillStyle="#3a3a3a",e.fillRect(0,0,this.canvas.width,X),e.textAlign="left",e.textBaseline="alphabetic";const n=t.level||1;t.drones&&t.drones.length;let s=15;const i=X/2+6;e.fillStyle="#88CCFF",e.font="bold 16px Arial",e.fillText("RTT:",s,i),s+=e.measureText("RTT:").width+5,e.fillStyle="white",e.fillText(`${Math.round(this.net.getRTT())}ms`,s,i),s+=e.measureText(`${Math.round(this.net.getRTT())}ms`).width+20,e.fillStyle="#FFD700",e.font="bold 16px Arial",e.fillText("Level:",s,i),s+=e.measureText("Level:").width+5,e.fillStyle="white",e.fillText(n,s,i),s+=e.measureText(String(n)).width+20,e.fillStyle="#FF6B6B",e.font="bold 16px Arial",e.fillText("HP:",s,i),s+=e.measureText("HP:").width+5,e.fillStyle="white",e.fillText(`${Math.round(t.hp)}/${t.maxHp}`,s,i),s+=e.measureText(`${Math.round(t.hp)}/${t.maxHp}`).width+20,e.fillStyle="#9370DB",e.font="bold 16px Arial",e.fillText("XP:",s,i),s+=e.measureText("XP:").width+5,e.fillStyle="white",e.fillText(t.xp,s,i),s+=e.measureText(String(t.xp)).width+20;const a=this.getTerritoryPercent(this.playerId);e.fillStyle="#98FB98",e.font="bold 16px Arial",e.fillText("Territory:",s,i),s+=e.measureText("Territory:").width+5,e.fillStyle="white",e.fillText(`${a.toFixed(2)}%`,s,i)}drawLeaderboard(e){const t=this.getLeaderboard().filter(i=>!i.player.dead),n=Math.min(M.LEADERBOARD_NUM,t.length),s=t.length>0?t[0].portion:0;e.font="18px Arial",e.textAlign="left";for(let i=0;i<n;i++){const{player:a,portion:o}=t[i],r=a.name||"Unnamed",l=a.base,c=l.darker(.3),u=s>0?o/s:0,f=Math.ceil((xt-Ge)*u+Ge),p=this.canvas.width-f,g=X*(i+1),T=i===0?10:0;e.fillStyle="rgba(10, 10, 10, 0.3)",e.fillRect(p-10,g+10-T,f+10,X+T),e.fillStyle=l.rgbString(),e.fillRect(p,g,f,X-Y),e.fillStyle=c.rgbString(),e.fillRect(p,g+X-Y,f,Y);const y=e.measureText(r).width;e.fillStyle="black",e.fillText(r,p-y-15,g+27);const S=a.num===this.playerId,v=`${(o*100).toFixed(1)}%`;e.fillStyle=S?"#FFD700":"white",e.fillText(v,p+5,g+X-15)}}drawXPBar(e){const t=this.players.get(this.playerId);if(!t)return;const n=t.level||1,s=t.xp||0,i=M.XP_BASE_PER_LEVEL+(n-1)*M.XP_INCREMENT_PER_LEVEL,a=250,o=28,r=(this.canvas.width-a)/2,l=this.canvas.height-45,c=Math.min(1,s/i),u=t.base,f=u.darker(.3);if(e.fillStyle="rgba(10, 10, 10, 0.5)",e.fillRect(r-60,l-2,a+70,o+4),e.font="bold 18px Arial",e.fillStyle="#FFD700",e.textAlign="left",e.fillText(`Lv.${n}`,r-55,l+o-8),e.fillStyle="rgba(60, 60, 60, 0.8)",e.fillRect(r,l,a,o-Y),e.fillStyle="rgba(40, 40, 40, 0.8)",e.fillRect(r,l+o-Y,a,Y),c>0){const p=a*c;e.fillStyle=u.rgbString(),e.fillRect(r,l,p,o-Y),e.fillStyle=f.rgbString(),e.fillRect(r,l+o-Y,p,Y)}e.font="16px Arial",e.fillStyle="white",e.textAlign="center",e.fillText(`${Math.floor(s)}/${i} XP`,r+a/2,l+o-9)}getSelfPlayer(){return this.players.get(this.playerId)}resize(e,t){this.canvas.width=e,this.canvas.height=t}}let K,ae,Q,J,ue,ve,he,Ne,b,ht,ct,ut,Fe,dt,Me,Xe,se,Ye,ze,He,be=0,me=1;const ft="swarmblitz.audio.v1";function $t(){try{const h=localStorage.getItem(ft);if(!h)return null;const e=JSON.parse(h);return e&&typeof e=="object"?e:null}catch{return null}}function ke(){try{const h=_e?_e():null;if(!h)return;localStorage.setItem(ft,JSON.stringify(h))}catch{}}function Kt(){const h=document.getElementById("vol-master"),e=document.getElementById("vol-music"),t=document.getElementById("vol-sfx"),n=document.getElementById("vol-master-val"),s=document.getElementById("vol-music-val"),i=document.getElementById("vol-sfx-val");h&&n&&(n.textContent=`${h.value}%`),e&&s&&(s.textContent=`${e.value}%`),t&&i&&(i.textContent=`${t.value}%`)}function Qt(){const h=$t();if(!h)return;typeof h.masterVolume=="number"&&Je(h.masterVolume),typeof h.musicVolume=="number"&&Ze(h.musicVolume),typeof h.sfxVolume=="number"&&et(h.sfxVolume),h.volumes&&typeof h.volumes=="object"&&Pt(h.volumes),typeof h.enabled=="boolean"&&bt(h.enabled);const e=document.getElementById("vol-master"),t=document.getElementById("vol-music"),n=document.getElementById("vol-sfx");e&&typeof h.masterVolume=="number"&&(e.value=String(Math.round(h.masterVolume*100))),t&&typeof h.musicVolume=="number"&&(t.value=String(Math.round(h.musicVolume*100))),n&&typeof h.sfxVolume=="number"&&(n.value=String(Math.round(h.sfxVolume*100))),Kt()}function de(){wt(),q(),ae&&ae.style.display!=="none"&&at()}function We(){K=document.getElementById("main-ui"),ae=document.getElementById("begin"),Q=document.getElementById("wasted"),J=document.getElementById("settings"),ue=document.getElementById("name"),ve=document.querySelector(".start.start-btn.primary"),he=document.querySelector(".spectate.start-btn.secondary"),Ne=document.getElementById("error"),ht=document.getElementById("death-score"),ct=document.getElementById("death-kills"),ut=document.getElementById("death-level"),Fe=document.getElementById("death-killer-info"),dt=document.getElementById("death-killer-name"),Me=Q.querySelector(".start.orange"),Xe=Q.querySelector(".menu.yellow"),se=Q.querySelector(".spectate.green"),Ye=document.querySelector(".toggle.yellow"),ze=document.getElementById("settings-close"),He=document.getElementById("settings-menu-btn"),$e(),window.addEventListener("resize",$e),ve.addEventListener("click",Le),ue.addEventListener("keypress",t=>{t.key==="Enter"&&!ve.disabled&&Le()}),console.log("[INIT] spectateButton:",he),console.log("[INIT] spectateDeathButton:",se),he?he.addEventListener("click",()=>{console.log("[CLICK] Spectate button clicked!"),Qe()}):console.error("[INIT] spectateButton not found!"),se?se.addEventListener("click",()=>{console.log("[CLICK] Spectate death button clicked!"),Qe()}):console.error("[INIT] spectateDeathButton not found!"),Me.addEventListener("click",Le),Xe.addEventListener("click",Ke),Ye.addEventListener("click",Zt),ze.addEventListener("click",()=>{J.style.display="none"}),He.addEventListener("click",()=>{J.style.display="none",Ke()});const h=document.getElementById("how-to-play-toggle"),e=document.getElementById("how-to-play-content");h&&e&&h.addEventListener("click",()=>{const t=e.style.display!=="none";e.style.display=t?"none":"block",h.classList.toggle("expanded",!t)}),jt(),Qt(),document.addEventListener("pointerdown",de,{once:!0}),document.addEventListener("touchstart",de,{once:!0,passive:!0}),document.addEventListener("keydown",de,{once:!0}),Jt(),ue.focus()}function jt(){const h=document.getElementById("vol-master"),e=document.getElementById("vol-music"),t=document.getElementById("vol-sfx"),n=document.getElementById("vol-master-val"),s=document.getElementById("vol-music-val"),i=document.getElementById("vol-sfx-val");h&&n&&h.addEventListener("input",()=>{n.textContent=`${h.value}%`,Je(parseInt(h.value,10)/100),ke()}),e&&s&&e.addEventListener("input",()=>{s.textContent=`${e.value}%`,Ze(parseInt(e.value,10)/100),ke()}),t&&i&&t.addEventListener("input",()=>{i.textContent=`${t.value}%`,et(parseInt(t.value,10)/100),ke()})}function Jt(){ve.disabled=!1,he.disabled=!1,Me.disabled=!1,se.disabled=!1,Ne.textContent="Ready to play!",Ne.style.color="#4caf50"}function $e(){K&&(K.width=window.innerWidth,K.height=window.innerHeight,b&&b.resize(K.width,K.height))}function Zt(){const h=J.style.display!=="none";J.style.display=h?"none":"block"}function Ke(){b&&(b.disconnect(),b=null),Q.style.display="none",J.style.display="none",ae.style.display="flex",ue.focus(),be=0,me=1,it(),at()}function Le(){const h=ue.value.trim()||"Player";de(),ae.style.display="none",Q.style.display="none",J.style.display="none",be=0,me=1,ot(),nt();const e=window.location.search.includes("prod");let t;e?(t="wss://swarmblitz.dev-1dd.workers.dev/room/default",console.log("%câ˜ï¸ CONNECTING TO PRODUCTION SERVER","background: #4caf50; color: white; font-size: 16px; padding: 4px 8px;")):(t="ws://localhost:8787/room/default",console.log("%cðŸ”§ CONNECTING TO LOCAL SERVER","background: #ff9800; color: black; font-size: 16px; padding: 4px 8px;")),console.log("WebSocket URL:",t),b=new lt(K,{wsUrl:t,onDeath:pt,onKill:mt,onLevelUp:gt}),b.connect(h)}function Qe(){console.log("[SPECTATE] startSpectate() called"),de(),console.log("[SPECTATE] Hiding screens..."),ae.style.display="none",Q.style.display="none",J.style.display="none",ot(),nt();const h=window.location.search.includes("prod");let e;h?(e="wss://swarmblitz.dev-1dd.workers.dev/room/default",console.log("%cðŸ‘ SPECTATING PRODUCTION SERVER","background: #9c27b0; color: white; font-size: 16px; padding: 4px 8px;")):(e="ws://localhost:8787/room/default",console.log("%cðŸ‘ SPECTATING LOCAL SERVER","background: #9c27b0; color: white; font-size: 16px; padding: 4px 8px;")),console.log("[SPECTATE] wsUrl:",e),console.log("[SPECTATE] Creating GameClient..."),b=new lt(K,{wsUrl:e,spectateMode:!0,onDeath:pt,onKill:mt,onLevelUp:gt}),console.log("[SPECTATE] GameClient created:",b),console.log("[SPECTATE] Calling connectSpectate()..."),b.connectSpectate(),console.log("[SPECTATE] connectSpectate() called")}function pt(h){console.log("You died!",h);const e=b?b.getSelfPlayer():null,t=e?e.level:me;let n="0.00%";b&&(n=`${b.getTerritoryPercent(b.playerId).toFixed(2)}%`),ht.textContent=n,ct.textContent=be.toString(),ut.textContent=t.toString();let s=null;if(b&&b.lastKillerName)s=b.lastKillerName;else if(h.killerNum!==void 0&&h.killerNum!==65535){const i=b?b.players.get(h.killerNum):null;i&&(s=i.name)}s?(dt.textContent=s,Fe.style.display="block"):Fe.style.display="none",setTimeout(()=>{b&&(b.disconnect(),b=null),Me.disabled=!1,se.disabled=!1,Q.style.display="flex"},1500)}function mt(h){console.log("You killed someone!",h),be++}function gt(h){console.log("Level up!",h),h.newLevel>me&&(me=h.newLevel)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",We):We();window.getGameClient=()=>b;
