(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();const le={INPUT:2,PING:3,FRAME:18,DEAD:19,PONG:20},$={POSITION:1,ANGLE:2,HP:4,XP:8,LEVEL:16,DRONES:32,TERRITORY:64,TRAIL:128},I={PLAYER_JOIN:1,PLAYER_LEAVE:2,PLAYER_KILL:3,COIN_SPAWN:4,COIN_PICKUP:5,HITSCAN:6,CAPTURE:7,LEVEL_UP:8,SNIP_START:9},Me={POS_MAX:65535,ANGLE_MAX:255,ANGLE_SCALE:65535,HP_MAX:255};function R(h,e){return h/Me.POS_MAX*e}function Ue(h){return h/Me.ANGLE_MAX*Math.PI*2}function Oe(h,e){return h/Me.HP_MAX*e}function yt(h){const e=h>>8&255,t=h>>4&15,s=h&15;return{hue:e/255,sat:t/15,lum:s/15}}class St{constructor(e){this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.view=new DataView(this.buffer),this.offset=0}readU8(){return this.view.getUint8(this.offset++)}readU16(){const e=this.view.getUint16(this.offset,!0);return this.offset+=2,e}readU32(){const e=this.view.getUint32(this.offset,!0);return this.offset+=4,e}readI8(){return this.view.getInt8(this.offset++)}readI16(){const e=this.view.getInt16(this.offset,!0);return this.offset+=2,e}readF32(){const e=this.view.getFloat32(this.offset,!0);return this.offset+=4,e}readString(){const e=this.readU8(),t=new Uint8Array(this.buffer,this.offset,e);return this.offset+=e,new TextDecoder().decode(t)}readBytes(e){const t=new Uint8Array(this.buffer,this.offset,e);return this.offset+=e,t}hasMore(){return this.offset<this.buffer.byteLength}}const k={DISCONNECTED:0,CONNECTING:1,CONNECTED:2,RECONNECTING:3};class Tt{constructor(e={}){this.url=e.url||"ws://localhost:8787/room/default",this.reconnectDelay=e.reconnectDelay||1e3,this.maxReconnectDelay=e.maxReconnectDelay||3e4,this.inputThrottleMs=e.inputThrottleMs||50,this.ws=null,this.state=k.DISCONNECTED,this.reconnectAttempts=0,this.playerId=null,this.mapSize=0,this.rtt=0,this.lastPingTime=0,this.pingInterval=null,this.lastInputTime=0,this.pendingAngle=null,this.onStateChange=e.onStateChange||(()=>{}),this.onInit=e.onInit||(()=>{}),this.onFrame=e.onFrame||(()=>{}),this.onEvent=e.onEvent||(()=>{}),this.onError=e.onError||(()=>{}),this.onReset=e.onReset||(()=>{})}connect(e){if(this.state===k.DISCONNECTED){this.playerName=e,this.isSpectator=!1,this.setState(k.CONNECTING);try{this.ws=new WebSocket(this.url),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>this.handleOpen(),this.ws.onmessage=t=>this.handleMessage(t),this.ws.onclose=t=>this.handleClose(t),this.ws.onerror=t=>this.handleError(t)}catch(t){this.onError(t),this.scheduleReconnect()}}}connectSpectate(){if(this.state===k.DISCONNECTED){this.playerName=null,this.isSpectator=!0,this.setState(k.CONNECTING);try{this.ws=new WebSocket(this.url),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>this.handleOpenSpectate(),this.ws.onmessage=e=>this.handleMessage(e),this.ws.onclose=e=>this.handleClose(e),this.ws.onerror=e=>this.handleError(e)}catch(e){this.onError(e),this.scheduleReconnect()}}}disconnect(){this.reconnectAttempts=0,this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.ws&&(this.ws.onclose=null,this.ws.close(),this.ws=null),this.setState(k.DISCONNECTED)}sendInput(e){if(this.state!==k.CONNECTED)return;const t=Date.now();if(t-this.lastInputTime<this.inputThrottleMs){this.pendingAngle=e;return}this.lastInputTime=t,this.pendingAngle=null;const s=new ArrayBuffer(3),i=new DataView(s);i.setUint8(0,le.INPUT);const n=(e+Math.PI)/(Math.PI*2),a=Math.round(n*Me.ANGLE_SCALE)&65535;i.setUint16(1,a,!0),this.ws.send(s)}flushInput(){if(this.pendingAngle!==null){const e=this.pendingAngle;this.pendingAngle=null,this.lastInputTime=0,this.sendInput(e)}}sendPing(){if(this.state!==k.CONNECTED)return;this.lastPingTime=performance.now();const e=new ArrayBuffer(9),t=new DataView(e);t.setUint8(0,le.PING),t.setFloat64(1,this.lastPingTime,!0),this.ws.send(e)}sendReset(){!this.ws||this.ws.readyState!==WebSocket.OPEN||this.ws.send(JSON.stringify({type:"reset"}))}handleOpen(){this.reconnectAttempts=0,this.ws.send(JSON.stringify({type:"hello",name:this.playerName})),this.pingInterval=setInterval(()=>this.sendPing(),2e3)}handleOpenSpectate(){this.reconnectAttempts=0,this.ws.send(JSON.stringify({type:"hello",spectate:!0})),this.pingInterval=setInterval(()=>this.sendPing(),2e3)}handleMessage(e){try{e.data instanceof ArrayBuffer?this.handleBinaryMessage(e.data):this.handleTextMessage(JSON.parse(e.data))}catch(t){console.error("Message parse error:",t)}}handleBinaryMessage(e){const t=new DataView(e);switch(t.getUint8(0)){case le.FRAME:this.handleFrame(e);break;case le.PONG:this.handlePong(t);break;case le.DEAD:this.handleDead(t);break}}handleTextMessage(e){switch(e.type){case"init":this.handleInit(e);break;case"error":this.onError(new Error(e.error));break;case"pong":this.rtt=Date.now()-e.t;break;case"reset":console.log("%cðŸ”„ Room reset, reconnecting...","color: orange; font-weight: bold;"),this.onReset();break;default:this.onEvent(e)}}handleInit(e){this.playerId=e.playerId,this.mapSize=e.mapSize,this.setState(k.CONNECTED),this.onInit({playerId:e.playerId,mapSize:e.mapSize,player:e.player,players:e.players,coins:e.coins})}handleFrame(e){const t=new St(e),s=this.mapSize;t.readU8();const i=t.readU32(),n=t.readU8();let a=null;n&&(a=this.readPlayerFull(t,s));const o=t.readU8(),r=[];for(let S=0;S<o;S++)r.push(this.readPlayerFull(t,s));const l=t.readU8(),c=[];for(let S=0;S<l;S++)c.push(this.readPlayerDelta(t,s));const u=t.readU8(),f=[];for(let S=0;S<u;S++)f.push(t.readU16());const p=t.readU8(),g=[];for(let S=0;S<p;S++)g.push({id:t.readU16(),x:t.readU16(),y:t.readU16()});const T=t.readU8(),y=[];for(let S=0;S<T;S++)y.push(this.readEvent(t,s));this.onFrame({frame:i,selfPlayer:a,newPlayers:r,updatedPlayers:c,removedPlayerIds:f,coins:g,events:y})}readPlayerFull(e,t){const s=e.readU16(),i=e.readString(),n=R(e.readU16(),t),a=R(e.readU16(),t),o=Ue(e.readU16()),r=Oe(e.readU8(),100),l=e.readU8(),c=e.readU16(),u=e.readU8()/100,f=e.readU8(),p=(f&1)!==0,g=(f&2)!==0,T=yt(e.readU8()),y=e.readU8()/255,S=e.readU8()/255,v=e.readU8(),E=[];for(let H=0;H<v;H++)E.push({x:R(e.readU16(),t),y:R(e.readU16(),t)});const _=e.readU16(),A=[];for(let H=0;H<_;H++)A.push({x:R(e.readU16(),t),y:R(e.readU16(),t)});const C=e.readU8();return{num:s,name:i,x:n,y:a,angle:o,hp:r,maxHp:100,level:l,xp:c,sizeScale:u,dead:p,isSnipped:g,base:{hue:T,sat:y,lum:S},territory:E,trail:A,droneCount:C}}readPlayerDelta(e,t){const s=e.readU16(),i=e.readU8(),n={num:s};if(i&$.POSITION&&(n.x=R(e.readU16(),t),n.y=R(e.readU16(),t)),i&$.ANGLE&&(n.angle=Ue(e.readU16())),i&$.HP&&(n.hp=Oe(e.readU8(),100)),i&$.XP&&(n.xp=e.readU16()),i&$.LEVEL&&(n.level=e.readU8()),i&$.DRONES&&(n.droneCount=e.readU8()),i&$.TERRITORY){const a=e.readU8();n.territory=[];for(let o=0;o<a;o++)n.territory.push({x:R(e.readU16(),t),y:R(e.readU16(),t)})}if(i&$.TRAIL){const a=e.readU16();n.trail=[];for(let o=0;o<a;o++)n.trail.push({x:R(e.readU16(),t),y:R(e.readU16(),t)})}return n}readEvent(e,t){const s=e.readU8(),i={type:s};switch(s){case I.PLAYER_JOIN:i.player=this.readPlayerFull(e,t);break;case I.PLAYER_LEAVE:i.num=e.readU16(),i.silent=e.readU8()===1;break;case I.PLAYER_KILL:i.killerNum=e.readU16(),i.victimNum=e.readU16(),i.killType=e.readU8();break;case I.COIN_SPAWN:i.id=e.readU16(),i.x=R(e.readU16(),t),i.y=R(e.readU16(),t),i.value=e.readU8();break;case I.COIN_PICKUP:i.id=e.readU16(),i.playerNum=e.readU16();break;case I.HITSCAN:i.ownerNum=e.readU16(),i.targetNum=e.readU16(),i.damage=e.readU8();break;case I.CAPTURE:i.playerNum=e.readU16(),i.x=R(e.readU16(),t),i.y=R(e.readU16(),t),i.xpGained=e.readU8();break;case I.LEVEL_UP:i.playerNum=e.readU16(),i.newLevel=e.readU8();break;case I.SNIP_START:i.playerNum=e.readU16(),i.snipperNum=e.readU16();break}return i}handlePong(e){const t=e.getFloat64(1,!0);this.rtt=performance.now()-t}handleDead(e){const t=e.getUint16(1,!0),s=e.getUint8(3);this.onEvent({type:"dead",killerNum:t,killType:s})}handleClose(e){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.ws=null,this.state!==k.DISCONNECTED&&this.scheduleReconnect()}handleError(e){console.error("WebSocket error:",e),this.onError(new Error("WebSocket error"))}scheduleReconnect(){this.setState(k.RECONNECTING);const e=Math.min(this.reconnectDelay*Math.pow(2,this.reconnectAttempts),this.maxReconnectDelay);this.reconnectAttempts++,setTimeout(()=>{this.state===k.RECONNECTING&&(this.setState(k.DISCONNECTED),this.connect(this.playerName))},e)}setState(e){this.state!==e&&(this.state=e,this.onStateChange(e))}getRTT(){return this.rtt}isConnected(){return this.state===k.CONNECTED}}function Ae(){for(let h=0;h<arguments.length;h++)if(arguments[h]<0||arguments[h]>1)throw new RangeError("H, S, L, and A parameters must be between [0, 1]")}function vt(h,e,t){let s,i,n;if(e===0)s=i=n=t;else{const a=(l,c,u)=>(u<0&&(u+=1),u>1&&(u-=1),u<.16666666666666666?l+(c-l)*6*u:u<.5?c:u<.6666666666666666?l+(c-l)*(.6666666666666666-u)*6:l),o=t<.5?t*(1+e):t+e-t*e,r=2*t-o;s=a(r,o,h+1/3),i=a(r,o,h),n=a(r,o,h-1/3)}return[Math.round(s*255),Math.round(i*255),Math.round(n*255)]}class W{constructor(e,t,s,i=1){Ae(e,t,s),i!==1&&Ae(i),Object.defineProperties(this,{hue:{value:e,enumerable:!0},sat:{value:t,enumerable:!0},lum:{value:s,enumerable:!0},alpha:{value:i,enumerable:!0}})}deriveLumination(e){let t=Math.min(Math.max(this.lum+e,0),1);return new W(this.hue,this.sat,t,this.alpha)}deriveHue(e){const t=this.hue-e;return new W(t-Math.floor(t),this.sat,this.lum,this.alpha)}deriveSaturation(e){let t=Math.min(Math.max(this.sat+e,0),1);return new W(this.hue,t,this.lum,this.alpha)}deriveAlpha(e){return Ae(e),new W(this.hue,this.sat,this.lum,e)}lighter(e){return this.deriveLumination(e)}darker(e){return this.deriveLumination(-e)}rgbString(){const e=vt(this.hue,this.sat,this.lum);return`rgba(${e[0]}, ${e[1]}, ${e[2]}, ${this.alpha})`}static fromData(e){return new W(e.hue,e.sat,e.lum,e.alpha??1)}static possColors(){const e=[192,150,100].map(i=>i/240),t=[0,10,20,25,30,35,40,45,50,60,70,100,110,120,125,130,135,140,145,150,160,170,180,190,200,210,220].map(i=>i/240),s=[];for(const i of e)for(const n of t)s.push(new W(n,i,.5,1));for(let i=s.length-1;i>0;i--){const n=Math.floor(Math.random()*(i+1));[s[i],s[n]]=[s[n],s[i]]}return s}}const w={CELL_WIDTH:40,SPEED:4,BORDER_WIDTH:20,LEADERBOARD_NUM:5,SNIP_FUSE_SPEED_MULT:1.5,SNIP_EXP_ACCEL_PER_SEC:.6375,SNIP_FUSE_MAX_SPEED_MULT:6,SNIP_GRACE_PERIOD:.25,COIN_RADIUS:8,TRAIL_SPEED_BUFF_MAX:1.6,TRAIL_SPEED_BUFF_RAMP_TIME:8,TRAIL_SPEED_BUFF_EASE:2,XP_BASE_PER_LEVEL:10,XP_INCREMENT_PER_LEVEL:15,DRONE_ORBIT_RADIUS:55,DRONE_ORBIT_SPEED:2,DRONE_RADIUS:10,DRONE_RANGE:158};let d=null,P=null,L=!1;const m={masterVolume:.6,sfxVolume:.8,musicVolume:.3,enabled:!0,volumes:{playerLaser:.3,enemyLaser:.2,playerFuse:1,enemyFuse:.7,capture:1,levelUp:.8,death:2,kill:2,coinPickup:1,hit:1.5,trailing:.4,speedRush:.5}};let z=null,F=null,fe=null,x=null,D=null,pe=null,O=null,V=null,U=null;const M={playerLasers:[],enemyLasers:[],maxConcurrent:4,windowMs:100,minCooldownMs:20,attenuationFactor:.6,maxDelayMs:35};let B=null,N=null,j=!1,ee=[],ie=[],ne=0,G=null,ce=!1;const wt="/music/playlist/menu/SwarmBlitz - Main Menu Theme.mp3";function je(h){const e=[...h];for(let t=e.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}return e}function Mt(){if(!L)try{d=new(window.AudioContext||window.webkitAudioContext),P=d.createGain(),P.gain.value=m.masterVolume,P.connect(d.destination),L=!0,console.log("[SoundManager] Initialized")}catch(h){console.warn("[SoundManager] Web Audio API not supported:",h),m.enabled=!1}}function q(){d&&d.state==="suspended"&&d.resume()}function bt(h){m.enabled=!!h}function Je(h){m.masterVolume=Math.max(0,Math.min(1,h)),P&&(P.gain.value=m.masterVolume),rt()}function Ze(h){m.musicVolume=Math.max(0,Math.min(1,h)),rt()}function et(h){m.sfxVolume=Math.max(0,Math.min(1,h))}function Pt(h){for(const[e,t]of Object.entries(h))Object.prototype.hasOwnProperty.call(m.volumes,e)&&(m.volumes[e]=Math.max(0,Math.min(1,t)))}function _e(){return{enabled:m.enabled,masterVolume:m.masterVolume,sfxVolume:m.sfxVolume,musicVolume:m.musicVolume,volumes:{...m.volumes}}}function Et(){if(!L||!m.enabled||m.volumes.playerLaser<=0)return;q();const h=performance.now();if(M.playerLasers.length>0){const p=M.playerLasers[M.playerLasers.length-1];if(h-p<M.minCooldownMs)return}M.playerLasers=M.playerLasers.filter(p=>h-p<M.windowMs);const e=M.playerLasers.length;M.playerLasers.push(h);let t=1;if(e>=M.maxConcurrent){const p=e-M.maxConcurrent+1;t=Math.pow(M.attenuationFactor,p)}else e>1&&(t=1-(e-1)*.15);const s=m.volumes.playerLaser,i=Math.random()*M.maxDelayMs/1e3,n=d.currentTime+i,a=.15,o=d.createOscillator(),r=d.createOscillator(),l=d.createGain(),c=d.createBiquadFilter();o.type="sawtooth",r.type="square";const u=.95+Math.random()*.1;o.frequency.setValueAtTime(1800*u,n),o.frequency.exponentialRampToValueAtTime(400*u,n+a*.7),r.frequency.setValueAtTime(1400*u,n),r.frequency.exponentialRampToValueAtTime(300*u,n+a*.7),c.type="lowpass",c.frequency.setValueAtTime(4e3,n),c.frequency.exponentialRampToValueAtTime(800,n+a),c.Q.value=2;const f=.35*m.sfxVolume*s*t;l.gain.setValueAtTime(0,n),l.gain.linearRampToValueAtTime(f,n+.01),l.gain.exponentialRampToValueAtTime(.01,n+a),o.connect(c),r.connect(c),c.connect(l),l.connect(P),o.start(n),r.start(n),o.stop(n+a),r.stop(n+a)}function At(h,e=800){if(!L||!m.enabled||m.volumes.enemyLaser<=0)return;q();const t=m.volumes.enemyLaser,s=Math.max(0,1-h/e);if(s<.05)return;const i=performance.now();if(M.enemyLasers.length>0){const y=M.enemyLasers[M.enemyLasers.length-1];if(i-y<M.minCooldownMs)return}M.enemyLasers=M.enemyLasers.filter(y=>i-y<M.windowMs);const n=M.enemyLasers.length;M.enemyLasers.push(i);let a=1;if(n>=M.maxConcurrent){const y=n-M.maxConcurrent+1;a=Math.pow(M.attenuationFactor,y)}else n>1&&(a=1-(n-1)*.15);const o=Math.random()*M.maxDelayMs/1e3,r=d.currentTime+o,l=.12,c=d.createOscillator(),u=d.createOscillator(),f=d.createGain(),p=d.createBiquadFilter();c.type="sawtooth",u.type="triangle";const g=.95+Math.random()*.1;c.frequency.setValueAtTime(900*g,r),c.frequency.exponentialRampToValueAtTime(250*g,r+l*.8),u.frequency.setValueAtTime(700*g,r),u.frequency.exponentialRampToValueAtTime(180*g,r+l*.8),p.type="lowpass",p.frequency.setValueAtTime(2500,r),p.frequency.exponentialRampToValueAtTime(500,r+l),p.Q.value=3;const T=.25*m.sfxVolume*t*s*a;f.gain.setValueAtTime(0,r),f.gain.linearRampToValueAtTime(T,r+.008),f.gain.exponentialRampToValueAtTime(.01,r+l),c.connect(p),u.connect(p),p.connect(f),f.connect(P),c.start(r),u.start(r),c.stop(r+l),u.stop(r+l)}function It(h=!0){if(!L||!m.enabled||m.volumes.capture<=0)return;q();const e=m.volumes.capture,t=d.currentTime,s=(h?1:.3)*e,i=d.sampleRate*.4,n=d.createBuffer(1,i,d.sampleRate),a=n.getChannelData(0);for(let c=0;c<i;c++)a[c]=Math.random()*2-1;const o=d.createBufferSource();o.buffer=n;const r=d.createGain(),l=d.createBiquadFilter();if(l.type="bandpass",l.frequency.setValueAtTime(300,t),l.frequency.exponentialRampToValueAtTime(2e3,t+.15),l.frequency.exponentialRampToValueAtTime(500,t+.4),l.Q.value=1,r.gain.setValueAtTime(0,t),r.gain.linearRampToValueAtTime(.15*m.sfxVolume*s,t+.05),r.gain.exponentialRampToValueAtTime(.01,t+.4),o.connect(l),l.connect(r),r.connect(P),o.start(t),o.stop(t+.4),h){const c=[523.25,659.25,783.99],u=.35;c.forEach((f,p)=>{const g=d.createOscillator(),T=d.createGain();g.type="sine",g.frequency.value=f;const y=t+p*.03;T.gain.setValueAtTime(0,y),T.gain.linearRampToValueAtTime(.12*m.sfxVolume*s,y+.02),T.gain.exponentialRampToValueAtTime(.01,y+u),g.connect(T),T.connect(P),g.start(y),g.stop(y+u)})}}function Rt(){if(!L||!m.enabled||m.volumes.levelUp<=0)return;q();const h=m.volumes.levelUp,e=d.currentTime;[{freq:523.25,time:0},{freq:659.25,time:.08},{freq:783.99,time:.16},{freq:1046.5,time:.24}].forEach(n=>{const a=d.createOscillator(),o=d.createOscillator(),r=d.createGain();a.type="sine",o.type="triangle",a.frequency.value=n.freq,o.frequency.value=n.freq*2;const l=e+n.time,c=.5-n.time*.5;r.gain.setValueAtTime(0,l),r.gain.linearRampToValueAtTime(.2*m.sfxVolume*h,l+.02),r.gain.setValueAtTime(.18*m.sfxVolume*h,l+c*.3),r.gain.exponentialRampToValueAtTime(.01,l+c),a.connect(r),o.connect(r),r.connect(P),a.start(l),o.start(l),a.stop(l+c),o.stop(l+c)});for(let n=0;n<8;n++){const a=d.createOscillator(),o=d.createGain();a.type="sine",a.frequency.value=2e3+Math.random()*2e3;const r=e+.1+Math.random()*.4,l=.1+Math.random()*.15;o.gain.setValueAtTime(0,r),o.gain.linearRampToValueAtTime(.06*m.sfxVolume*h,r+.01),o.gain.exponentialRampToValueAtTime(.01,r+l),a.connect(o),o.connect(P),a.start(r),a.stop(r+l)}const s=d.createOscillator(),i=d.createGain();s.type="sine",s.frequency.setValueAtTime(150,e),s.frequency.exponentialRampToValueAtTime(50,e+.5),i.gain.setValueAtTime(0,e),i.gain.linearRampToValueAtTime(.25*m.sfxVolume*h,e+.02),i.gain.exponentialRampToValueAtTime(.01,e+.5),s.connect(i),i.connect(P),s.start(e),s.stop(e+.5)}function xe(h=!1,e=0,t=400){if(!L||!m.enabled||m.volumes.death<=0)return;q();const s=m.volumes.death,i=d.currentTime;let n;if(h)n=1*s;else{const E=Math.max(0,1-e/t);if(E<.1)return;n=.5*s*E}const a=d.createOscillator(),o=d.createOscillator(),r=d.createGain(),l=d.createBiquadFilter();a.type="sine",o.type="triangle",a.frequency.setValueAtTime(600,i),a.frequency.exponentialRampToValueAtTime(80,i+.8),o.frequency.setValueAtTime(603,i),o.frequency.exponentialRampToValueAtTime(82,i+.8),l.type="lowpass",l.frequency.setValueAtTime(2e3,i),l.frequency.exponentialRampToValueAtTime(200,i+.7),r.gain.setValueAtTime(.25*m.sfxVolume*n,i),r.gain.linearRampToValueAtTime(.2*m.sfxVolume*n,i+.1),r.gain.exponentialRampToValueAtTime(.01,i+.9),a.connect(l),o.connect(l),l.connect(r),r.connect(P),a.start(i),o.start(i),a.stop(i+.9),o.stop(i+.9);const c=.15,u=d.sampleRate*c,f=d.createBuffer(1,u,d.sampleRate),p=f.getChannelData(0);for(let E=0;E<u;E++){const _=E/d.sampleRate,A=Math.random()>.7?Math.random()*2-1:0,C=Math.exp(-_*15);p[E]=A*C}const g=d.createBufferSource();g.buffer=f;const T=d.createGain(),y=d.createBiquadFilter();y.type="highpass",y.frequency.value=2e3,y.Q.value=1,T.gain.setValueAtTime(.18*m.sfxVolume*n,i),T.gain.exponentialRampToValueAtTime(.01,i+c),g.connect(y),y.connect(T),T.connect(P),g.start(i),g.stop(i+c);const S=d.createOscillator(),v=d.createGain();S.type="sine",S.frequency.setValueAtTime(60,i),S.frequency.exponentialRampToValueAtTime(25,i+.3),v.gain.setValueAtTime(0,i),v.gain.linearRampToValueAtTime(.3*m.sfxVolume*n,i+.015),v.gain.exponentialRampToValueAtTime(.01,i+.35),S.connect(v),v.connect(P),S.start(i),S.stop(i+.35),h&&[180,190,270].forEach(_=>{const A=d.createOscillator(),C=d.createGain();A.type="sine",A.frequency.setValueAtTime(_,i),A.frequency.exponentialRampToValueAtTime(_*.5,i+.6),C.gain.setValueAtTime(0,i+.02),C.gain.linearRampToValueAtTime(.08*m.sfxVolume*s,i+.05),C.gain.exponentialRampToValueAtTime(.01,i+.7),A.connect(C),C.connect(P),A.start(i),A.stop(i+.7)})}function Ct(){if(!L||!m.enabled||m.volumes.coinPickup<=0)return;q();const h=m.volumes.coinPickup,e=d.currentTime,t=d.createOscillator(),s=d.createOscillator(),i=d.createGain();t.type="sine",s.type="triangle",t.frequency.setValueAtTime(800,e),t.frequency.exponentialRampToValueAtTime(1400,e+.08),s.frequency.setValueAtTime(1200,e),s.frequency.exponentialRampToValueAtTime(2100,e+.08),i.gain.setValueAtTime(0,e),i.gain.linearRampToValueAtTime(.2*m.sfxVolume*h,e+.015),i.gain.exponentialRampToValueAtTime(.01,e+.2),t.connect(i),s.connect(i),i.connect(P),t.start(e),s.start(e),t.stop(e+.2),s.stop(e+.2);const n=d.createOscillator(),a=d.createGain();n.type="sine",n.frequency.setValueAtTime(2400,e+.02),n.frequency.exponentialRampToValueAtTime(3200,e+.1),a.gain.setValueAtTime(0,e+.02),a.gain.linearRampToValueAtTime(.08*m.sfxVolume*h,e+.04),a.gain.exponentialRampToValueAtTime(.01,e+.15),n.connect(a),a.connect(P),n.start(e+.02),n.stop(e+.15)}function kt(){if(!L||!m.enabled||z)return;q();const e=d.sampleRate*1.5,t=d.createBuffer(1,e,d.sampleRate),s=t.getChannelData(0);for(let p=0;p<e;p++){const g=p/d.sampleRate,T=(Math.random()*2-1)*.5,y=Math.random()>.7?(Math.random()*2-1)*.6:0,S=Math.random()>.97?(Math.random()*2-1)*1:0,v=Math.sin(g*150+Math.random()*2)*.2*(Math.random()>.5?1:0);s[p]=T+y+S+v}const i=d.createBufferSource();i.buffer=t,i.loop=!0;const n=d.createBiquadFilter();n.type="highpass",n.frequency.value=1500,n.Q.value=.7;const a=d.createBiquadFilter();a.type="peaking",a.frequency.value=5e3,a.Q.value=1,a.gain.value=6;const o=d.createOscillator();o.type="sawtooth",o.frequency.value=80;const r=d.createGain();r.gain.value=.08;const l=d.createBiquadFilter();l.type="bandpass",l.frequency.value=200,l.Q.value=3,F=d.createGain();const c=m.volumes.playerFuse??1;F.gain.value=.15*m.sfxVolume*c;const u=d.createOscillator();u.type="sine",u.frequency.value=12;const f=d.createGain();f.gain.value=.02,i.connect(n),n.connect(a),a.connect(F),o.connect(l),l.connect(r),r.connect(F),u.connect(f),f.connect(F.gain),F.connect(P),i.start(),o.start(),u.start(),z={noise:i,burnOsc:o,lfo:u},fe=a}function Lt(){if(z)try{if(F){const h=d.currentTime;F.gain.linearRampToValueAtTime(0,h+.1)}setTimeout(()=>{try{z&&(z.noise.stop(),z.burnOsc.stop(),z.lfo.stop())}catch{}z=null,F=null,fe=null},150)}catch{z=null,F=null,fe=null}}function Dt(h){if(!F||!L||!m.enabled||m.volumes.playerFuse<=0)return;const e=m.volumes.playerFuse,t=.15,i=(t+(.45-t)*h)*m.sfxVolume*e,n=d.currentTime;if(F.gain.linearRampToValueAtTime(i,n+.05),fe){const r=4+6*h;fe.gain.linearRampToValueAtTime(r,n+.05)}}function Nt(){if(!L||!m.enabled||x)return;q();const e=d.sampleRate*1.5,t=d.createBuffer(1,e,d.sampleRate),s=t.getChannelData(0);for(let p=0;p<e;p++){const g=p/d.sampleRate,T=(Math.random()*2-1)*.4,y=Math.random()>.75?(Math.random()*2-1)*.5:0,S=Math.random()>.96?(Math.random()*2-1)*.8:0,v=Math.sin(g*100+Math.random()*2)*.15*(Math.random()>.6?1:0);s[p]=T+y+S+v}const i=d.createBufferSource();i.buffer=t,i.loop=!0;const n=d.createBiquadFilter();n.type="highpass",n.frequency.value=800,n.Q.value=.5;const a=d.createBiquadFilter();a.type="peaking",a.frequency.value=2500,a.Q.value=1.5,a.gain.value=5;const o=d.createOscillator();o.type="sawtooth",o.frequency.value=50;const r=d.createGain();r.gain.value=.1;const l=d.createBiquadFilter();l.type="bandpass",l.frequency.value=150,l.Q.value=2,D=d.createGain();const c=m.volumes.enemyFuse??.7;D.gain.value=.06*m.sfxVolume*c;const u=d.createOscillator();u.type="sine",u.frequency.value=8;const f=d.createGain();f.gain.value=.015,i.connect(n),n.connect(a),a.connect(D),o.connect(l),l.connect(r),r.connect(D),u.connect(f),f.connect(D.gain),D.connect(P),i.start(),o.start(),u.start(),x={noise:i,burnOsc:o,lfo:u},pe=a}function Ft(){if(x)try{if(D){const h=d.currentTime;D.gain.linearRampToValueAtTime(0,h+.1)}setTimeout(()=>{try{x&&(x.noise.stop(),x.burnOsc.stop(),x.lfo.stop())}catch{}x=null,D=null,pe=null},150)}catch{x=null,D=null,pe=null}}function Vt(h,e=300){if(!D||!L||!m.enabled||m.volumes.enemyFuse<=0)return;const t=m.volumes.enemyFuse,s=Math.max(0,1-h/e),i=d.currentTime;if(s<.1){D.gain.linearRampToValueAtTime(0,i+.05);return}const n=.08,o=(n+(.3-n)*s)*m.sfxVolume*t;if(D.gain.linearRampToValueAtTime(o,i+.05),pe){const c=3+4*s;pe.gain.linearRampToValueAtTime(c,i+.05)}}function Be(){return x!==null}function Ut(){if(!L||!m.enabled||O)return;q();const e=d.sampleRate*2,t=d.createBuffer(1,e,d.sampleRate),s=t.getChannelData(0);for(let c=0;c<e;c++){const u=c/d.sampleRate,f=(Math.random()*2-1)*.5,p=Math.sin(u*12)*.2*(Math.random()*2-1),g=Math.sin(u*6)*.08;s[c]=f+p+g}U=d.createBufferSource(),U.buffer=t,U.loop=!0,U.playbackRate.value=1;const i=d.createBiquadFilter();i.type="bandpass",i.frequency.value=600,i.Q.value=1.2;const n=d.createBiquadFilter();n.type="highpass",n.frequency.value=300,n.Q.value=.7,B=d.createOscillator(),B.type="sawtooth",B.frequency.value=100;const a=d.createGain();a.gain.value=.02;const o=d.createBiquadFilter();o.type="lowpass",o.frequency.value=200,V=d.createGain(),V.gain.value=0,U.connect(i),i.connect(n),n.connect(V),B.connect(o),o.connect(a),a.connect(V),V.connect(P),U.start(),B.start(),O={noiseSource:U,oscillator:B,bandpass:i};const r=d.currentTime,l=m.volumes.speedRush??.5;V.gain.linearRampToValueAtTime(.12*m.sfxVolume*l,r+.3)}function Ie(){if(O)try{if(V){const h=d.currentTime;V.gain.linearRampToValueAtTime(0,h+.2)}setTimeout(()=>{try{O&&(O.noiseSource.stop(),O.oscillator.stop())}catch{}O=null,V=null,U=null,B=null},250)}catch{O=null,V=null,U=null,B=null}}function Ot(h){if(!O||!V||!L||!m.enabled||m.volumes.speedRush<=0)return;const e=m.volumes.speedRush??.5,t=d.currentTime,s=Math.min(1,Math.max(0,(h-1.1)/.1)),i=1+(1.5-1)*s;U&&U.playbackRate.linearRampToValueAtTime(i,t+.1);const n=(.1+(.25-.1)*s)*m.sfxVolume*e;if(V.gain.linearRampToValueAtTime(n,t+.1),B){const a=100+80*s;B.frequency.linearRampToValueAtTime(a,t+.1)}if(O.bandpass){const a=500+700*s;O.bandpass.frequency.linearRampToValueAtTime(a,t+.1)}}async function _t(){try{return ee=(await(await fetch("/api/playlist")).json()).tracks||[],console.log("[SoundManager] Playlist loaded:",ee.length,"tracks"),ee.length>0}catch(h){return console.warn("[SoundManager] Could not fetch playlist:",h),!1}}function De(){st()}function tt(){if(!j||ie.length===0)return;const h=ie[ne],e=`/music/playlist/${encodeURIComponent(h)}`;console.log("[SoundManager] Playing track:",h,`(${ne+1}/${ie.length})`),N&&(N.pause(),N.removeEventListener("ended",De)),N=new Audio(e),N.volume=m.musicVolume*m.masterVolume,N.addEventListener("ended",De),N.play().catch(t=>{console.warn("[SoundManager] Could not play track:",t),st()})}function st(){j&&(ne++,ne>=ie.length&&(console.log("[SoundManager] All tracks played, reshuffling playlist"),ie=je(ee),ne=0),tt())}async function it(){if(!(!m.enabled||j)){if(j=!0,ee.length===0&&!await _t()){console.warn("[SoundManager] No tracks in playlist"),j=!1;return}ie=je(ee),ne=0,tt(),console.log("[SoundManager] Background music started with",ee.length,"tracks")}}function nt(){if(j){if(j=!1,N){N.removeEventListener("ended",De);const h=N,e=setInterval(()=>{h.volume>.05?h.volume=Math.max(0,h.volume-.05):(clearInterval(e),h.pause())},30)}console.log("[SoundManager] Background music stopped")}}function at(){!m.enabled||ce||(j&&nt(),ce=!0,G&&G.pause(),G=new Audio(wt),G.volume=m.musicVolume*m.masterVolume,G.loop=!0,G.play().catch(h=>{console.warn("[SoundManager] Could not play menu music:",h),ce=!1}),console.log("[SoundManager] Menu music started"))}function ot(){if(ce){if(ce=!1,G){const h=G,e=setInterval(()=>{h.volume>.05?h.volume=Math.max(0,h.volume-.05):(clearInterval(e),h.pause())},30)}console.log("[SoundManager] Menu music stopped")}}function rt(){const h=m.musicVolume*m.masterVolume;N&&(N.volume=h),G&&(G.volume=h)}const X=45,Y=5,te=w.CELL_WIDTH/2,xt=w.DRONE_RADIUS,Bt=400,Ge=65;class Te{constructor(e){this.num=e.num,this.name=e.name||"Player",this.x=e.x,this.y=e.y,this.angle=e.angle||0,this.serverX=e.x,this.serverY=e.y,this.serverAngle=e.angle||0,this.correctionX=0,this.correctionY=0,this.hp=e.hp||100,this.maxHp=e.maxHp||100,this.level=e.level||1,this.xp=e.xp||0,this.sizeScale=e.sizeScale||1,this.dead=e.dead||!1,this.isSnipped=e.isSnipped||!1,this.territory=e.territory||[],this.trail=e.trail||[],this.droneCount=e.droneCount!==void 0?e.droneCount:this.level,this.droneOrbitPhase=0,this.drones=[],e.base?this.base=new W(e.base.hue,e.base.sat,e.base.lum):this.base=new W(Math.random(),.8,.5)}update(e,t=!1){if(t&&e.x!==void 0&&e.y!==void 0){const s=e.x-this.x,i=e.y-this.y;this.correctionX+=s,this.correctionY+=i,Math.sqrt(s*s+i*i)>100&&(this.x=e.x,this.y=e.y,this.correctionX=0,this.correctionY=0)}e.x!==void 0&&(this.serverX=e.x),e.y!==void 0&&(this.serverY=e.y),e.angle!==void 0&&(this.serverAngle=e.angle),e.hp!==void 0&&(this.hp=e.hp),e.maxHp!==void 0&&(this.maxHp=e.maxHp),e.level!==void 0&&(this.level=e.level),e.xp!==void 0&&(this.xp=e.xp),e.sizeScale!==void 0&&(this.sizeScale=e.sizeScale),e.droneCount!==void 0?this.droneCount=e.droneCount:e.level!==void 0&&(this.droneCount=e.level),e.dead!==void 0&&(this.dead=e.dead),e.isSnipped!==void 0&&(this.isSnipped=e.isSnipped),e.territory!==void 0&&(this.territory=e.territory||[]),e.trail!==void 0&&(this.trail=e.trail||[])}updateDrones(e){const t=w.DRONE_ORBIT_RADIUS,s=w.DRONE_ORBIT_SPEED;for(this.droneOrbitPhase+=s*(e/1e3),this.droneOrbitPhase>Math.PI*2&&(this.droneOrbitPhase-=Math.PI*2);this.drones.length<this.droneCount;)this.drones.push({id:this.drones.length,x:this.x,y:this.y,targetId:null});for(;this.drones.length>this.droneCount;)this.drones.pop();for(let i=0;i<this.drones.length;i++){const n=this.drones[i],a=i/this.droneCount*Math.PI*2,o=this.droneOrbitPhase+a;n.x=this.x+Math.cos(o)*t,n.y=this.y+Math.sin(o)*t}}predict(e,t,s,i){this.x+=this.correctionX*.08,this.y+=this.correctionY*.08,this.correctionX*=1-.08,this.correctionY*=1-.08;let a=this.serverAngle-this.angle;for(;a>Math.PI;)a-=Math.PI*2;for(;a<-Math.PI;)a+=Math.PI*2;this.angle+=a*.03;const o=9*(e/1e3);let r=i-this.angle;for(;r>Math.PI;)r-=Math.PI*2;for(;r<-Math.PI;)r+=Math.PI*2;for(Math.abs(r)>o&&(r=Math.sign(r)*o),this.angle+=r;this.angle>Math.PI;)this.angle-=Math.PI*2;for(;this.angle<-Math.PI;)this.angle+=Math.PI*2;const l=t*(e/1e3)*60;this.x+=Math.cos(this.angle)*l,this.y+=Math.sin(this.angle)*l;const c=15;this.x=Math.max(c,Math.min(s-c,this.x)),this.y=Math.max(c,Math.min(s-c,this.y)),this.updateDrones(e)}interpolateOther(e,t){let s=this.serverAngle-this.angle;for(;s>Math.PI;)s-=Math.PI*2;for(;s<-Math.PI;)s+=Math.PI*2;const i=Math.min(1,.2*(e/16.67));for(this.angle+=s*i;this.angle>Math.PI;)this.angle-=Math.PI*2;for(;this.angle<-Math.PI;)this.angle+=Math.PI*2;const n=t*(e/1e3)*60;this.x+=Math.cos(this.angle)*n,this.y+=Math.sin(this.angle)*n;const a=this.serverX-this.x,o=this.serverY-this.y,r=Math.sqrt(a*a+o*o);if(r>200)this.x=this.serverX,this.y=this.serverY;else{const l=Math.min(.25,.05+r*.002);this.x+=a*l,this.y+=o*l}this.updateDrones(e)}}class Re{constructor(e){this.id=e.id,this.x=e.x,this.y=e.y,this.value=e.value||5}}class Z{constructor(e,t,s,i="burst"){if(this.x=e,this.y=t,this.color=s,this.type=i,i==="burst"){const n=Math.random()*Math.PI*2,a=3+Math.random()*8;this.vx=Math.cos(n)*a,this.vy=Math.sin(n)*a,this.size=4+Math.random()*8,this.life=1,this.decay=.015+Math.random()*.02,this.rotation=Math.random()*Math.PI*2,this.rotationSpeed=(Math.random()-.5)*.3,this.gravity=.15}else if(i==="spark"){const n=Math.random()*Math.PI*2,a=8+Math.random()*12;this.vx=Math.cos(n)*a,this.vy=Math.sin(n)*a,this.size=2+Math.random()*3,this.life=1,this.decay=.04+Math.random()*.03,this.trail=[]}else if(i==="ring")this.radius=5,this.maxRadius=80+Math.random()*40,this.expandSpeed=4+Math.random()*2,this.life=1,this.decay=.025,this.lineWidth=8;else if(i==="shard"){const n=Math.random()*Math.PI*2,a=2+Math.random()*5;this.vx=Math.cos(n)*a,this.vy=Math.sin(n)*a,this.points=this.generateShardShape(),this.life=1,this.decay=.012+Math.random()*.01,this.rotation=Math.random()*Math.PI*2,this.rotationSpeed=(Math.random()-.5)*.15,this.gravity=.08}}generateShardShape(){const e=[],t=3+Math.floor(Math.random()*3),s=10+Math.random()*20;for(let i=0;i<t;i++){const n=i/t*Math.PI*2,a=s*(.5+Math.random()*.5);e.push({x:Math.cos(n)*a,y:Math.sin(n)*a})}return e}update(){return this.type==="burst"?(this.x+=this.vx,this.y+=this.vy,this.vy+=this.gravity,this.vx*=.98,this.rotation+=this.rotationSpeed,this.life-=this.decay):this.type==="spark"?(this.trail.push({x:this.x,y:this.y,life:this.life}),this.trail.length>8&&this.trail.shift(),this.x+=this.vx,this.y+=this.vy,this.vx*=.92,this.vy*=.92,this.life-=this.decay):this.type==="ring"?(this.radius+=this.expandSpeed,this.lineWidth*=.96,this.life-=this.decay):this.type==="shard"&&(this.x+=this.vx,this.y+=this.vy,this.vy+=this.gravity,this.rotation+=this.rotationSpeed,this.life-=this.decay),this.life>0}render(e){const t=Math.max(0,this.life);if(this.type==="burst")e.save(),e.translate(this.x,this.y),e.rotate(this.rotation),e.globalAlpha=t,e.fillStyle=this.color,e.fillRect(-this.size/2,-this.size/2,this.size,this.size),e.shadowColor=this.color,e.shadowBlur=10*t,e.fillRect(-this.size/2,-this.size/2,this.size,this.size),e.shadowBlur=0,e.restore();else if(this.type==="spark"){e.save(),e.beginPath(),e.moveTo(this.x,this.y);for(let s=this.trail.length-1;s>=0;s--){const i=this.trail[s];e.lineTo(i.x,i.y)}e.strokeStyle=this.color,e.lineWidth=this.size*t,e.globalAlpha=t*.6,e.stroke(),e.globalAlpha=t,e.fillStyle="#fff",e.beginPath(),e.arc(this.x,this.y,this.size*.8,0,Math.PI*2),e.fill(),e.restore()}else if(this.type==="ring")e.save(),e.beginPath(),e.arc(this.x,this.y,this.radius,0,Math.PI*2),e.strokeStyle=this.color,e.lineWidth=Math.max(1,this.lineWidth*t),e.globalAlpha=t*.7,e.stroke(),e.restore();else if(this.type==="shard"){e.save(),e.translate(this.x,this.y),e.rotate(this.rotation),e.globalAlpha=t*.8,e.beginPath(),e.moveTo(this.points[0].x,this.points[0].y);for(let s=1;s<this.points.length;s++)e.lineTo(this.points[s].x,this.points[s].y);e.closePath(),e.fillStyle=this.color,e.fill(),e.restore()}e.globalAlpha=1}}class Gt{constructor(e,t,s,i,n){this.fromX=e,this.fromY=t,this.toX=s,this.toY=i,this.color=n,this.startTime=performance.now(),this.duration=100}isExpired(){return performance.now()-this.startTime>this.duration}getAlpha(){const e=performance.now()-this.startTime;return Math.max(0,1-e/this.duration)}}const qt=1,qe=40,Ce=10,Xt=120,Yt=.8;class zt{constructor(e,t,s,i,n){this.x=e,this.y=t,this.xpGained=s,this.player=i,this.isLocalPlayer=n,this.spawnTime=performance.now(),this.color=i?i.base:null,this.pulseRadius=Ce,this.pulseLife=1,this.particles=[];const a=n?qe:Math.floor(qe*.6);for(let o=0;o<a;o++){const r=Math.random()*Math.PI*2,l=2+Math.random()*6;this.particles.push({x:e,y:t,vx:Math.cos(r)*l,vy:Math.sin(r)*l,size:3+Math.random()*5,life:1,decay:.015+Math.random()*.02})}this.textY=t-20,this.textAlpha=1}easeOutQuad(e){return e*(2-e)}update(){const e=(performance.now()-this.spawnTime)/1e3,t=Math.min(1,e/qt),s=Math.min(1,e/Yt);this.pulseRadius=Ce+(Xt-Ce)*this.easeOutQuad(s),this.pulseLife=1-s;for(const i of this.particles)i.x+=i.vx,i.y+=i.vy,i.vx*=.96,i.vy*=.96,i.vy+=.1,i.life-=i.decay;return this.textY-=.8,this.textAlpha=Math.max(0,1-t),t<1}render(e){const t=this.color?this.color.rgbString():"#FFD700",s=this.color?this.color.lighter(.3).rgbString():"#FFEC8B";this.pulseLife>0&&(e.save(),e.strokeStyle=this.color?this.color.deriveAlpha(this.pulseLife*.8).rgbString():`rgba(255, 215, 0, ${this.pulseLife*.8})`,e.lineWidth=4*this.pulseLife,e.beginPath(),e.arc(this.x,this.y,this.pulseRadius,0,Math.PI*2),e.stroke(),e.strokeStyle=this.color?this.color.deriveAlpha(this.pulseLife*.4).rgbString():`rgba(255, 255, 200, ${this.pulseLife*.4})`,e.lineWidth=8*this.pulseLife,e.beginPath(),e.arc(this.x,this.y,this.pulseRadius*.8,0,Math.PI*2),e.stroke(),e.restore());for(const i of this.particles)i.life<=0||(e.save(),e.globalAlpha=Math.max(0,i.life),e.fillStyle=s,e.shadowColor=t,e.shadowBlur=8*i.life,e.beginPath(),e.arc(i.x,i.y,i.size*i.life,0,Math.PI*2),e.fill(),e.restore());if(this.textAlpha>0&&this.xpGained>0){e.save(),e.globalAlpha=this.textAlpha,e.fillStyle="#9370DB",e.strokeStyle="rgba(0, 0, 0, 0.6)",e.lineWidth=3,e.font="bold 18px Changa",e.textAlign="center",e.textBaseline="middle";const i=`+${this.xpGained} XP`;e.strokeText(i,this.x,this.textY),e.fillText(i,this.x,this.textY),e.restore()}e.globalAlpha=1}}class Wt{constructor(e,t,s,i,n){this.x=e,this.y=t,this.newLevel=s,this.player=i,this.isLocalPlayer=n,this.spawnTime=performance.now(),this.color=i&&i.base?i.base:null,this.textY=t-40,this.textAlpha=1,this.scale=.5}update(){const e=(performance.now()-this.spawnTime)/1e3,s=Math.min(1,e/1.5);return this.textY=this.y-40-s*60,this.textAlpha=Math.max(0,1-s),s<.3?this.scale=.5+s/.3*1:this.scale=1.5-(s-.3)*.5,s<1}render(e){if(this.textAlpha<=0)return;e.save(),e.globalAlpha=this.textAlpha,e.translate(this.x,this.textY),e.scale(this.scale,this.scale),e.shadowColor="#FFD700",e.shadowBlur=20*this.textAlpha,e.fillStyle="#FFD700",e.strokeStyle="rgba(0, 0, 0, 0.8)",e.lineWidth=4,e.font="bold 24px Changa",e.textAlign="center",e.textBaseline="middle";const t=`â¬†ï¸ LEVEL ${this.newLevel}! â¬†ï¸`;e.strokeText(t,0,0),e.fillText(t,0,0),e.font="bold 14px Changa",e.fillStyle="#88CCFF",e.strokeText("+1 Drone, +5% Size",0,28),e.fillText("+1 Drone, +5% Size",0,28),e.restore()}}class Ht{constructor(e,t,s,i,n,a=null){this.originX=e,this.originY=t,this.targetX=s,this.targetY=i,this.value=n,this.coinId=a,this.x=e,this.y=t,this.spawnTime=performance.now(),this.duration=600+Math.random()*200,this.delay=Math.random()*150,this.arcHeight=40+Math.random()*60,this.rotation=0,this.rotationSpeed=(Math.random()-.5)*.4,this.scale=0,this.targetScale=.8+Math.random()*.4,this.glowIntensity=1,this.sparkles=[];for(let o=0;o<3;o++)this.sparkles.push({angle:Math.random()*Math.PI*2,dist:8+Math.random()*8,size:2+Math.random()*2,speed:.05+Math.random()*.05});this.landed=!1,this.landTime=0,this.bouncePhase=0}update(){const e=performance.now(),t=e-this.spawnTime-this.delay;if(t<0)return!0;const s=Math.min(1,t/this.duration);if(this.landed){const i=e-this.landTime,n=Math.min(1,i/400);if(this.bouncePhase=Math.sin(n*Math.PI*3)*(1-n)*8,this.y=this.targetY-Math.abs(this.bouncePhase),this.rotation*=.95,this.glowIntensity=Math.max(.3,1-n*.7),n>=1)return!1}else{const i=1-Math.pow(1-s,3);this.x=this.originX+(this.targetX-this.originX)*i;const n=this.originY+(this.targetY-this.originY)*i,a=Math.sin(i*Math.PI)*this.arcHeight;this.y=n-a,this.scale=this.targetScale*Math.min(1,i*2),this.rotation+=this.rotationSpeed;for(const o of this.sparkles)o.angle+=o.speed;s>=1&&(this.landed=!0,this.landTime=e,this.x=this.targetX,this.y=this.targetY)}return!0}render(e){if(performance.now()-this.spawnTime-this.delay<0||this.scale<=0)return;e.save(),e.translate(this.x,this.y),e.rotate(this.rotation),e.scale(this.scale,this.scale);const i=w.COIN_RADIUS*1.2,n=i*(2+this.glowIntensity),a=e.createRadialGradient(0,0,i*.5,0,0,n);a.addColorStop(0,`rgba(255, 215, 0, ${.6*this.glowIntensity})`),a.addColorStop(.5,`rgba(255, 180, 0, ${.3*this.glowIntensity})`),a.addColorStop(1,"rgba(255, 150, 0, 0)"),e.fillStyle=a,e.beginPath(),e.arc(0,0,n,0,Math.PI*2),e.fill();const o=e.createRadialGradient(-i*.3,-i*.3,0,0,0,i);if(o.addColorStop(0,"#FFF8DC"),o.addColorStop(.3,"#FFD700"),o.addColorStop(.7,"#DAA520"),o.addColorStop(1,"#B8860B"),e.fillStyle=o,e.beginPath(),e.arc(0,0,i,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(139, 90, 43, 0.5)",e.lineWidth=1.5,e.beginPath(),e.arc(0,0,i*.7,0,Math.PI*2),e.stroke(),e.fillStyle="rgba(255, 255, 255, 0.6)",e.beginPath(),e.ellipse(-i*.25,-i*.25,i*.35,i*.2,-Math.PI/4,0,Math.PI*2),e.fill(),e.restore(),!this.landed)for(const r of this.sparkles){const l=this.x+Math.cos(r.angle)*r.dist*this.scale,c=this.y+Math.sin(r.angle)*r.dist*this.scale;e.fillStyle=`rgba(255, 255, 200, ${.8*this.glowIntensity})`,e.beginPath(),e.arc(l,c,r.size*this.scale,0,Math.PI*2),e.fill()}}}class lt{constructor(e,t={}){this.canvas=e,this.ctx=e.getContext("2d"),this.net=new Tt({url:t.wsUrl||"ws://localhost:8787/room/default",onStateChange:s=>this.handleStateChange(s),onInit:s=>this.handleInit(s),onFrame:s=>this.handleFrame(s),onEvent:s=>this.handleEvent(s),onError:s=>this.handleError(s)}),this.mapSize=0,this.playerId=null,this.players=new Map,this.coins=new Map,this.effects=[],this.cameraX=0,this.cameraY=0,this.cameraTargetX=0,this.cameraTargetY=0,this.cameraScale=1,this.mouseX=0,this.mouseY=0,this.targetAngle=0,this.mouseSet=!1,this.wasdKeys={w:!1,a:!1,s:!1,d:!1},this.useWasd=!1,this.wasdCurrentAngle=0,this.lastFrameTime=performance.now(),this.networkTickMs=100,this.interpolationDelay=this.networkTickMs,this.onDeath=t.onDeath||(()=>{}),this.onKill=t.onKill||(()=>{}),this.onLevelUp=t.onLevelUp||(()=>{}),this.debugMode=!1,this.lastNetworkUpdate=0,this.networkGaps=[],this.snipFuses=new Map,this._localSnippedPrev=!1,this.speedBuffState=new Map,this.speedSpikeState={active:!1,playerX:0,playerY:0,playerAngle:0,speedRatio:0,baseColor:null,pulsePhase:0},this.deathParticles=[],this.dyingPlayers=[],this.screenShake={x:0,y:0,intensity:0,decay:.92},this.captureEffects=[],this.levelUpEffects=[],this.lootCoins=[],this.animatingCoinIds=new Set,this.playerPortions=new Map,this.lastKillerName=null,this.lastKillerNum=null,this.recentDeaths=[],this.localOutlineThicken={active:!1,startTime:0,duration:500},this.lastCleanupTime=0,this.spawnFade={active:!1,startTime:0,duration:800},this.cleanupIntervalMs=2e3,this.handleMouseMove=this.handleMouseMove.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),this.gameLoop=this.gameLoop.bind(this),this.setupInput()}startSnipFuse(e,t){const s=this.players.get(e);if(!s)return;const i=s.trail||[],n=t===65535,a=e===this.playerId;let o,r=0;if(i.length>=2){let l={x:s.x,y:s.y};if(!n){const u=this.players.get(t);u&&(l={x:u.x,y:u.y})}const c=this._furthestHitOnTrailByPos(l,i,n?3:0);o=c.point||{x:i[0].x,y:i[0].y},r=c.index>=0?c.index:0}else i.length===1?(o={x:i[0].x,y:i[0].y},r=0):(o={x:s.x,y:s.y},r=0);this.snipFuses.set(e,{playerNum:e,snipperNum:t,startPoint:o,segmentIndex:r,elapsed:0,progressDist:0,fusePos:{x:o.x,y:o.y},ratio:0,remainingPoints:null,isLocalVictim:a,sawSnipped:!1})}_closestPointOnTrail(e,t){let s={dist2:1/0,point:null,index:0};for(let i=0;i<t.length-1;i++){const n=t[i],a=t[i+1],o=this._closestPointOnSegment(e,n,a),r=e.x-o.x,l=e.y-o.y,c=r*r+l*l;c<s.dist2&&(s={dist2:c,point:o,index:i})}return s}_furthestHitOnTrailByPos(e,t,s=0){const i=w.CELL_WIDTH/2;let n={dist2:1/0,point:null,index:-1};const a=Math.max(0,t.length-1-s);for(let o=0;o<a;o++){const r=t[o],l=t[o+1],c=this._closestPointOnSegment(e,r,l),u=e.x-c.x,f=e.y-c.y,p=u*u+f*f;p<i*i&&o>n.index&&(n={dist2:p,point:c,index:o})}return n.point===null?this._closestPointOnTrail(e,t):n}_closestPointOnSegment(e,t,s){const i=s.x-t.x,n=s.y-t.y,a=e.x-t.x,o=e.y-t.y,r=i*i+n*n;if(r===0)return{x:t.x,y:t.y};let l=(a*i+o*n)/r;return l=Math.max(0,Math.min(1,l)),{x:t.x+i*l,y:t.y+n*l}}_pointAtDistance(e,t){if(e.length===0)return null;if(e.length===1)return{x:e[0].x,y:e[0].y};let s=t;for(let i=0;i<e.length-1;i++){const n=e[i],a=e[i+1],o=Math.hypot(a.x-n.x,a.y-n.y);if(!(o<=1e-4)){if(s<=o){const r=s/o;return{x:n.x+(a.x-n.x)*r,y:n.y+(a.y-n.y)*r}}s-=o}}return{x:e[e.length-1].x,y:e[e.length-1].y}}_pointAtDistanceWithIndex(e,t){if(e.length===0)return{point:null,index:0};if(e.length===1)return{point:{x:e[0].x,y:e[0].y},index:0};let s=t;for(let i=0;i<e.length-1;i++){const n=e[i],a=e[i+1],o=Math.hypot(a.x-n.x,a.y-n.y);if(!(o<=1e-4)){if(s<=o){const r=s/o;return{point:{x:n.x+(a.x-n.x)*r,y:n.y+(a.y-n.y)*r},index:i}}s-=o}}return{point:{x:e[e.length-1].x,y:e[e.length-1].y},index:e.length-2}}_sumLength(e){let t=0;for(let s=0;s<e.length-1;s++)t+=Math.hypot(e[s+1].x-e[s].x,e[s+1].y-e[s].y);return t}updateSnipFuses(e){const t=e/1e3;for(const[n,a]of Array.from(this.snipFuses.entries())){const o=this.players.get(n);if(!o){this.snipFuses.delete(n);continue}if(o.isSnipped&&(a.sawSnipped=!0),a.sawSnipped&&!o.isSnipped){this.snipFuses.delete(n);continue}if(a.elapsed>10){this.snipFuses.delete(n);continue}if(!o.trail||o.trail.length<2){a.elapsed+=t;continue}a.elapsed+=t;const r=w.SPEED,l=w.SNIP_FUSE_SPEED_MULT,c=w.SNIP_EXP_ACCEL_PER_SEC,u=w.SNIP_GRACE_PERIOD,f=Math.max(0,a.elapsed-u),p=r*l*60,g=Math.exp(c*f);let T=p*g;const y=w.SNIP_FUSE_MAX_SPEED_MULT;T=Math.min(T,r*y*60),a.elapsed>u&&(a.progressDist+=T*t);const S=Math.max(0,Math.min(o.trail.length-2,a.segmentIndex)),v=[a.startPoint,...o.trail.slice(S+1),{x:o.x,y:o.y}],E=this._sumLength(v),_=Math.max(1,E);a.ratio=Math.max(0,Math.min(1,a.progressDist/_));const A=this._pointAtDistanceWithIndex(v,Math.min(a.progressDist,_));a.fusePos=A.point;const C=v.slice(A.index+1);a.remainingPoints=[a.fusePos,...C]}const s=this.players.get(this.playerId),i=!!(s&&s.isSnipped);if(i&&!this._localSnippedPrev&&kt(),!i&&this._localSnippedPrev&&Lt(),this._localSnippedPrev=i,i){const n=this.snipFuses.get(this.playerId);n&&Dt(n.ratio)}if(s){let n=null,a=1/0;for(const[r,l]of this.snipFuses){if(r===this.playerId)continue;const c=this.players.get(r);if(!c||!(c.isSnipped||!l.sawSnipped))continue;const f=l.fusePos.x-s.x,p=l.fusePos.y-s.y,g=Math.sqrt(f*f+p*p);g<a&&(a=g,n=l)}const o=n!==null&&a<800;o&&!Be()?Nt():!o&&Be()&&Ft(),o&&Vt(a,800)}}setupInput(){this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),this.canvas.addEventListener("touchstart",this.handleTouchMove,{passive:!1}),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp)}cleanupInput(){this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("touchmove",this.handleTouchMove),this.canvas.removeEventListener("touchstart",this.handleTouchMove),window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp)}handleKeyDown(e){const t=document.activeElement,s=t&&t.tagName?t.tagName.toLowerCase():"";if(s==="input"||s==="textarea"||s==="select"||e.repeat)return;const i=(e.key||"").toLowerCase();if(e.key==="F3"){this.debugMode=!this.debugMode,console.log("Debug mode:",this.debugMode?"ON":"OFF");return}if(i==="r"){console.log("%cðŸ”„ RESETTING ROOM...","color: orange; font-weight: bold;"),this.net.sendReset();return}(i==="w"||i==="a"||i==="s"||i==="d")&&this.setKeyState(i,!0)}handleKeyUp(e){const t=(e.key||"").toLowerCase();(t==="w"||t==="a"||t==="s"||t==="d")&&this.setKeyState(t,!1)}setKeyState(e,t){const s=(e||"").toLowerCase();s in this.wasdKeys&&(this.wasdKeys[s]=!!t,this.useWasd=!!(this.wasdKeys.w||this.wasdKeys.a||this.wasdKeys.s||this.wasdKeys.d))}handleMouseMove(e){const t=this.canvas.getBoundingClientRect();this.mouseX=e.clientX-t.left,this.mouseY=e.clientY-t.top,this.mouseSet=!0,this.updateTargetAngle()}handleTouchMove(e){if(e.preventDefault(),e.touches.length>0){const t=this.canvas.getBoundingClientRect();this.mouseX=e.touches[0].clientX-t.left,this.mouseY=e.touches[0].clientY-t.top,this.mouseSet=!0,this.updateTargetAngle()}}updateTargetAngle(){const e=this.players.get(this.playerId);if(!e)return;const t=this.cameraX+(this.mouseX-this.canvas.width/2)/this.cameraScale,s=this.cameraY+(this.mouseY-this.canvas.height/2)/this.cameraScale;this.targetAngle=Math.atan2(s-e.y,t-e.x),this.useWasd||(this.wasdCurrentAngle=this.targetAngle)}connect(e){this.playerName=e,this.net.connect(e)}connectSpectate(){this.spectateMode=!0,this.net.connectSpectate()}disconnect(){this.net.disconnect(),this.stopGameLoop(),this.cleanupInput()}handleStateChange(e){console.log("Connection state:",e)}handleInit(e){this.playerId=e.playerId,this.mapSize=e.mapSize,this.players.clear(),this.coins.clear(),this.effects=[];for(const t of e.players)this.players.set(t.num,new Te(t));for(const t of e.coins)this.coins.set(t.id,new Re(t));if(this.spectateMode){this.cameraX=this.mapSize/2,this.cameraY=this.mapSize/2,this.cameraTargetX=this.mapSize/2,this.cameraTargetY=this.mapSize/2;const t=50;this.cameraScale=Math.min(this.canvas.width/(this.mapSize+t*2),this.canvas.height/(this.mapSize+t*2))}else{const t=this.players.get(this.playerId);t&&(this.cameraX=t.x,this.cameraY=t.y,this.cameraTargetX=t.x,this.cameraTargetY=t.y),this.spawnFade.active=!0,this.spawnFade.startTime=performance.now()}this.startGameLoop()}handleFrame(e){const t=performance.now();if(this.lastNetworkUpdate){const s=t-this.lastNetworkUpdate;this.networkGaps.push(s),this.networkGaps.length>20&&this.networkGaps.shift(),s>150&&this.debugMode&&console.warn(`[NET] Long gap between updates: ${s.toFixed(0)}ms`)}if(this.lastNetworkUpdate=t,e.selfPlayer){let s=this.players.get(e.selfPlayer.num);s?s.update(e.selfPlayer,!0):(s=new Te(e.selfPlayer),this.players.set(e.selfPlayer.num,s))}for(const s of e.newPlayers)this.players.has(s.num)||this.players.set(s.num,new Te(s));for(const s of e.updatedPlayers){const i=this.players.get(s.num);i&&i.update(s,!1)}this.coins.clear();for(const s of e.coins)this.coins.set(s.id,new Re(s));for(const s of e.events)this.handleEvent(s);for(const s of e.removedPlayerIds)this.players.delete(s),this.snipFuses.delete(s),this.speedBuffState.delete(s)}handleEvent(e){switch(e.type){case I.HITSCAN:this.addHitscanEffect(e);break;case I.PLAYER_KILL:{const t=this.players.get(e.victimNum),s=this.players.get(e.killerNum),i=e.victimNum===this.playerId;i&&s&&(this.lastKillerName=s.name||"Unknown",this.lastKillerNum=e.killerNum),t&&this.spawnDeathEffect(t,i),i?this.onDeath(e):e.killerNum===this.playerId&&this.onKill(e);break}case I.LEVEL_UP:{const t=this.players.get(e.playerNum),s=e.playerNum===this.playerId;t&&this.spawnLevelUpEffect(t.x,t.y,e.newLevel,t,s),s&&this.onLevelUp(e);break}case I.PLAYER_JOIN:e.player&&!this.players.has(e.player.num)&&this.players.set(e.player.num,new Te(e.player));break;case I.PLAYER_LEAVE:this.players.delete(e.num);break;case I.COIN_SPAWN:{this.coins.set(e.id,new Re(e));const t=performance.now();for(const s of this.recentDeaths)if(Math.hypot(e.x-s.x,e.y-s.y)<150&&t-s.time<500){const n=new Ht(s.x,s.y,e.x,e.y,e.value||5,e.id);this.lootCoins.push(n),this.animatingCoinIds.add(e.id);break}break}case I.COIN_PICKUP:this.coins.delete(e.id),this.animatingCoinIds.delete(e.id),e.playerNum===this.playerId&&Ct();break;case I.SNIP_START:this.startSnipFuse(e.playerNum,e.snipperNum);break;case I.CAPTURE:{const t=this.players.get(e.playerNum),s=e.playerNum===this.playerId;console.log("[CAPTURE] Event received:",e,"isLocal:",s,"player:",t),t&&this.spawnCaptureEffect(e.x,e.y,e.xpGained,t,s);break}case"dead":{const t=this.players.get(this.playerId);t&&this.spawnDeathEffect(t,!0),this.onDeath(e);break}}}addHitscanEffect(e){const t=this.players.get(e.ownerNum),s=this.players.get(e.targetNum);if(!t||!s)return;const i=t.base;let n=t.x,a=t.y;if(t.drones.length>0){const r=t.drones[Math.floor(Math.random()*t.drones.length)];n=r.x,a=r.y}this.effects.push(new Gt(n,a,s.x,s.y,i));const o=this.players.get(this.playerId);if(o)if(e.ownerNum===this.playerId)Et();else{const r=Math.hypot(n-o.x,a-o.y);At(r)}}handleError(e){console.error("Network error:",e)}startGameLoop(){this.running=!0,this.lastFrameTime=performance.now(),requestAnimationFrame(this.gameLoop)}stopGameLoop(){this.running=!1}gameLoop(e){if(!this.running)return;const t=e-this.lastFrameTime;this.lastFrameTime=e,this.update(t),this.render(),this.net.flushInput(),requestAnimationFrame(this.gameLoop)}update(e){const t=this.players.get(this.playerId),s=this.spawnFade.active;if(!this.spectateMode&&!s&&t&&!t.dead){const n=this.computeInputAngle(t,e);typeof n=="number"&&Number.isFinite(n)&&(this.targetAngle=n,this.net.sendInput(this.targetAngle))}if(!s)for(const[n,a]of this.players)!this.spectateMode&&n===this.playerId&&t&&!t.dead?a.predict(e,w.SPEED,this.mapSize,this.targetAngle):a.interpolateOther(e,w.SPEED);if(this.spectateMode){this.cameraX=this.mapSize/2,this.cameraY=this.mapSize/2;const n=50;this.cameraScale=Math.min(this.canvas.width/(this.mapSize+n*2),this.canvas.height/(this.mapSize+n*2))}else if(t){this.cameraTargetX=t.x,this.cameraTargetY=t.y;const n=.15;this.cameraX+=(this.cameraTargetX-this.cameraX)*n,this.cameraY+=(this.cameraTargetY-this.cameraY)*n}this.updateSnipFuses(e),this.updateSpeedBuffEffects(e),this.updateDeathEffects(),this.updateCaptureEffects(),this.updateLevelUpEffects(),this.updateLootCoins(),this.updateTerritoryPortions(),this.effects=this.effects.filter(n=>!n.isExpired());const i=performance.now();i-this.lastCleanupTime>this.cleanupIntervalMs&&(this.lastCleanupTime=i,this.cleanupOrphanedState())}cleanupOrphanedState(){for(const[t,s]of Array.from(this.snipFuses.entries())){if(!this.players.get(t)){this.snipFuses.delete(t);continue}s.elapsed>5&&!s.sawSnipped&&this.snipFuses.delete(t)}for(const[t]of Array.from(this.speedBuffState.entries()))this.players.has(t)||this.speedBuffState.delete(t);for(const[,t]of this.players){if(t.dead){t.trail=[],t.territory=[];continue}if(t.trail&&t.trail.length>0&&!t.isSnipped){const s=t.trail[0],i=s.x-t.x,n=s.y-t.y;Math.sqrt(i*i+n*n)>500&&(t.trail=[])}if(t.territory&&t.territory.length>3){let s=0,i=0;for(const r of t.territory)s+=r.x,i+=r.y;s/=t.territory.length,i/=t.territory.length;const n=t.x-s,a=t.y-i;Math.sqrt(n*n+a*a)>1e3&&(t.territory=[])}}const e=performance.now()-5e3;this.dyingPlayers=this.dyingPlayers.filter(t=>t.deathTime>e)}calculateSpeedBuff(e){const t=w.TRAIL_SPEED_BUFF_MAX,s=w.TRAIL_SPEED_BUFF_RAMP_TIME,i=w.TRAIL_SPEED_BUFF_EASE,n=Math.min(1,e/s),a=Math.pow(n,i);return 1+(t-1)*a}pointInPolygon(e,t,s){if(!s||s.length<3)return!1;let i=!1;for(let n=0,a=s.length-1;n<s.length;a=n++){const o=s[n].x,r=s[n].y,l=s[a].x,c=s[a].y;r>t!=c>t&&e<(l-o)*(t-r)/(c-r)+o&&(i=!i)}return i}updateSpeedBuffEffects(e){const s=performance.now();for(const[n,a]of this.players){if(a.dead)continue;let o=this.speedBuffState.get(n);o||(o={trailStartTime:null,lastSpeedBuff:1,speedRushActive:!1},this.speedBuffState.set(n,o));const r=a.trail&&a.trail.length>0;if(a.isSnipped){o.trailStartTime=null,o.lastSpeedBuff=1,n===this.playerId&&o.speedRushActive&&(Ie(),o.speedRushActive=!1);continue}if(r){o.trailStartTime===null&&(o.trailStartTime=s);const c=(s-o.trailStartTime)/1e3,u=this.calculateSpeedBuff(c);o.lastSpeedBuff=u;const f=w.TRAIL_SPEED_BUFF_MAX;a._speedRatio=Math.min(1,Math.max(0,(u-1.1)/(f-1.1))),a._hasSpeedBuff=u>=1.1,n===this.playerId&&(u>=1.1?(o.speedRushActive||(Ut(),o.speedRushActive=!0),Ot(u)):o.speedRushActive&&(Ie(),o.speedRushActive=!1))}else o.trailStartTime=null,o.lastSpeedBuff=1,a._speedRatio=0,a._hasSpeedBuff=!1,n===this.playerId&&o.speedRushActive&&(Ie(),o.speedRushActive=!1)}const i=this.players.get(this.playerId);if(i&&i._hasSpeedBuff){const n=6+(i._speedRatio||0)*8;this.speedSpikeState.pulsePhase+=n*(e/1e3),this.speedSpikeState.active=!0}else this.speedSpikeState.active=!1}spawnDeathEffect(e,t=!1){const s=e.x,i=e.y,n=e.base?e.base.rgbString():"#ff4444",a=e.base?e.base.lighter(.3).rgbString():"#ff8888";this.recentDeaths.push({x:s,y:i,time:performance.now()});const o=performance.now();this.recentDeaths=this.recentDeaths.filter(c=>o-c.time<2e3);const r=t?40:25;for(let c=0;c<r;c++)this.deathParticles.push(new Z(s,i,n,"burst"));const l=t?20:12;for(let c=0;c<l;c++)this.deathParticles.push(new Z(s,i,a,"spark"));if(this.deathParticles.push(new Z(s,i,n,"ring")),t&&setTimeout(()=>{this.deathParticles.push(new Z(s,i,a,"ring"))},100),e.territory&&e.territory.length>3){const c=t?15:8;for(let u=0;u<c;u++){const f=Math.floor(Math.random()*e.territory.length),p=e.territory[f];this.deathParticles.push(new Z(p.x,p.y,n,"shard"))}}if(t&&(this.screenShake.intensity=25),this.dyingPlayers.push({num:e.num,x:e.x,y:e.y,angle:e.angle,color:e.base,sizeScale:e.sizeScale||1,territory:e.territory?[...e.territory]:[],trail:e.trail?[...e.trail]:[],deathTime:performance.now(),dissolveProgress:0}),t)xe(!0);else{const c=this.players.get(this.playerId);if(c){const u=e.x-c.x,f=e.y-c.y,p=Math.sqrt(u*u+f*f);xe(!1,p)}}}updateDeathEffects(){for(let t=this.deathParticles.length-1;t>=0;t--)this.deathParticles[t].update()||this.deathParticles.splice(t,1);this.screenShake.intensity>.5?(this.screenShake.x=(Math.random()-.5)*this.screenShake.intensity*2,this.screenShake.y=(Math.random()-.5)*this.screenShake.intensity*2,this.screenShake.intensity*=this.screenShake.decay):(this.screenShake.x=0,this.screenShake.y=0,this.screenShake.intensity=0);const e=performance.now();for(let t=this.dyingPlayers.length-1;t>=0;t--){const s=this.dyingPlayers[t];s.dissolveProgress=Math.min(1,(e-s.deathTime)/1500),s.dissolveProgress>=1&&this.dyingPlayers.splice(t,1)}}renderDeathParticles(e){for(const t of this.deathParticles)t.render(e)}spawnCaptureEffect(e,t,s,i,n){this.captureEffects.push(new zt(e,t,s,i,n)),n&&(this.localOutlineThicken.active=!0,this.localOutlineThicken.startTime=performance.now()),n&&It()}updateCaptureEffects(){for(let e=this.captureEffects.length-1;e>=0;e--)this.captureEffects[e].update()||this.captureEffects.splice(e,1);this.localOutlineThicken.active&&performance.now()-this.localOutlineThicken.startTime>=this.localOutlineThicken.duration&&(this.localOutlineThicken.active=!1)}renderCaptureEffects(e){for(const t of this.captureEffects)t.render(e)}spawnLevelUpEffect(e,t,s,i,n){const a=n?30:8;for(let o=0;o<a;o++)this.deathParticles.push(new Z(e,t,"#FFD700","burst"));this.deathParticles.push(new Z(e,t,"#FFD700","ring")),n&&(this.screenShake.intensity=10,this.levelUpEffects.push(new Wt(e,t,s,i,n)),Rt())}updateLevelUpEffects(){for(let e=this.levelUpEffects.length-1;e>=0;e--)this.levelUpEffects[e].update()||this.levelUpEffects.splice(e,1)}renderLevelUpEffects(e){for(const t of this.levelUpEffects)t.render(e)}updateLootCoins(){for(let e=this.lootCoins.length-1;e>=0;e--){const t=this.lootCoins[e];t.update()||(t.coinId!==null&&this.animatingCoinIds.delete(t.coinId),this.lootCoins.splice(e,1))}}renderLootCoins(e){for(const t of this.lootCoins)t.render(e)}updateTerritoryPortions(){const e=this.mapSize*this.mapSize;for(const[t,s]of this.players)if(s.territory&&s.territory.length>=3){const i=this.polygonArea(s.territory);this.playerPortions.set(t,i/e)}else this.playerPortions.set(t,0)}polygonArea(e){if(!e||e.length<3)return 0;let t=0;for(let s=0,i=e.length-1;s<e.length;i=s++)t+=(e[i].x+e[s].x)*(e[i].y-e[s].y);return Math.abs(t/2)}getTerritoryPercent(e){return(this.playerPortions.get(e)||0)*100}getLeaderboard(){const e=[];for(const[t,s]of this.players)e.push({player:s,portion:this.playerPortions.get(t)||0});return e.sort((t,s)=>s.portion-t.portion),e}getOutlineThickness(e){if(e===this.playerId&&this.localOutlineThicken.active){const t=performance.now()-this.localOutlineThicken.startTime;return 1+2*(1-Math.min(1,t/this.localOutlineThicken.duration))}return 1}getDissolveProgress(e){const t=this.dyingPlayers.find(s=>s.num===e);return t?t.dissolveProgress:0}renderDyingPlayers(e){for(const t of this.dyingPlayers){if(t.dissolveProgress>=1)continue;const s=Math.max(0,1-t.dissolveProgress),i=t.color;if(!i)continue;if(e.save(),e.globalAlpha=s,t.territory&&t.territory.length>=3){e.fillStyle=i.deriveAlpha(.4*s).rgbString(),e.beginPath(),e.moveTo(t.territory[0].x,t.territory[0].y);for(let r=1;r<t.territory.length;r++)e.lineTo(t.territory[r].x,t.territory[r].y);e.closePath(),e.fill(),e.strokeStyle=i.deriveAlpha(.9*s).rgbString(),e.lineWidth=2.5,e.stroke()}if(t.trail&&t.trail.length>=2){const r=i.lighter(.2);e.strokeStyle=r.deriveAlpha(s).rgbString(),e.lineWidth=te,e.lineCap="round",e.lineJoin="round",e.beginPath(),e.moveTo(t.trail[0].x,t.trail[0].y);for(let l=1;l<t.trail.length;l++)e.lineTo(t.trail[l].x,t.trail[l].y);e.lineTo(t.x,t.y),e.stroke()}const n=te*t.sizeScale;e.fillStyle=i.darker(.3).deriveAlpha(s).rgbString(),e.beginPath(),e.arc(t.x+2,t.y+4,n,0,Math.PI*2),e.fill(),e.fillStyle=i.deriveAlpha(s).rgbString(),e.beginPath(),e.arc(t.x,t.y,n,0,Math.PI*2),e.fill();const a=t.x+Math.cos(t.angle)*n*.6,o=t.y+Math.sin(t.angle)*n*.6;e.fillStyle=i.lighter(.1).deriveAlpha(s).rgbString(),e.beginPath(),e.arc(a,o,n*.3,0,Math.PI*2),e.fill(),e.restore()}}computeInputAngle(e,t){if(this.useWasd){let r=0,l=0;if(this.wasdKeys.w&&(l-=1),this.wasdKeys.s&&(l+=1),this.wasdKeys.a&&(r-=1),this.wasdKeys.d&&(r+=1),r===0&&l===0)return null;const c=Math.atan2(l,r);let u=c-this.wasdCurrentAngle;for(;u>Math.PI;)u-=Math.PI*2;for(;u<-Math.PI;)u+=Math.PI*2;const f=.15*(t/16.67);for(Math.abs(u)<=f?this.wasdCurrentAngle=c:this.wasdCurrentAngle+=Math.sign(u)*f;this.wasdCurrentAngle>Math.PI;)this.wasdCurrentAngle-=Math.PI*2;for(;this.wasdCurrentAngle<-Math.PI;)this.wasdCurrentAngle+=Math.PI*2;return this.wasdCurrentAngle}if(!this.mouseSet)return null;const s=this.cameraX+(this.mouseX-this.canvas.width/2)/this.cameraScale,i=this.cameraY+(this.mouseY-this.canvas.height/2)/this.cameraScale,n=s-e.x,a=i-e.y;if(n*n+a*a<100)return null;const o=Math.atan2(a,n);return this.wasdCurrentAngle=o,o}render(){const e=this.ctx,t=this.canvas.width,s=this.canvas.height,i=s-X;e.fillStyle="#e2ebf3",e.fillRect(0,0,t,s),e.save(),e.translate(0,X),e.beginPath(),e.rect(0,0,t,i),e.clip(),e.translate(t/2+this.screenShake.x,i/2+this.screenShake.y),e.scale(this.cameraScale,this.cameraScale),e.translate(-this.cameraX,-this.cameraY),this.drawGrid(e);const n=Array.from(this.players.values()).sort((a,o)=>a.num-o.num);for(const a of n)this.drawTerritory(e,a);for(const a of this.coins.values())this.animatingCoinIds.has(a.id)||this.drawCoin(e,a);for(const a of n)this.drawTrail(e,a);for(const a of n)!a.dead&&a._hasSpeedBuff&&this.drawSpeedSpikes(e,a);for(const a of n)a.dead||this.drawPlayer(e,a);this.renderDyingPlayers(e);for(const a of this.effects)this.drawHitscan(e,a);if(this.renderCaptureEffects(e),this.renderLevelUpEffects(e),this.renderLootCoins(e),this.renderDeathParticles(e),e.restore(),this.drawTopBar(e),this.drawLeaderboard(e),this.drawXPBar(e),this.debugMode&&this.drawDebugHUD(e),this.spawnFade.active){const a=performance.now()-this.spawnFade.startTime,o=Math.min(1,a/this.spawnFade.duration);if(o<1){const r=1-this.easeOutCubic(o);e.fillStyle=`rgba(0, 0, 0, ${r})`,e.fillRect(0,0,t,s),r>.3&&(e.fillStyle=`rgba(255, 255, 255, ${r})`,e.font="bold 24px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText("SPAWNING...",t/2,s/2))}else this.spawnFade.active=!1}}easeOutCubic(e){return 1-Math.pow(1-e,3)}drawDebugHUD(e){let s=150;const i=16;e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(5,s-15,250,180),e.fillStyle="#00ff00",e.font="12px monospace",e.textAlign="left",e.fillText("=== DEBUG MODE (press D to toggle) ===",10,s),s+=i;let n=0,a=0,o=0;for(const[p,g]of this.players){if(p===this.playerId||g.dead)continue;const T=g.serverX-g.x,y=g.serverY-g.y,S=Math.sqrt(T*T+y*y);n+=S,a=Math.max(a,S),o++}const r=o>0?n/o:0;e.fillText(`Players: ${this.players.size} (${o} others)`,10,s),s+=i,e.fillText(`Avg position error: ${r.toFixed(1)}px`,10,s),s+=i,e.fillText(`Max position error: ${a.toFixed(1)}px`,10,s),s+=i;const l=this.networkGaps.length>0?this.networkGaps.reduce((p,g)=>p+g,0)/this.networkGaps.length:0,c=this.networkGaps.length>0?Math.max(...this.networkGaps):0,u=performance.now()-this.lastNetworkUpdate;e.fillText(`Net update gap: avg ${l.toFixed(0)}ms, max ${c.toFixed(0)}ms`,10,s),s+=i,e.fillStyle=u>150?"#ff0000":"#00ff00",e.fillText(`Time since last update: ${u.toFixed(0)}ms`,10,s),e.fillStyle="#00ff00",s+=i;const f=this.players.get(this.playerId);if(f){s+=i,e.fillStyle="#ffff00",e.fillText("--- Local Player ---",10,s),s+=i,e.fillStyle="#00ff00",e.fillText(`Pos: (${f.x.toFixed(1)}, ${f.y.toFixed(1)})`,10,s),s+=i,e.fillText(`Server: (${f.serverX.toFixed(1)}, ${f.serverY.toFixed(1)})`,10,s),s+=i;const p=Math.sqrt(Math.pow(f.serverX-f.x,2)+Math.pow(f.serverY-f.y,2));e.fillText(`Correction offset: ${p.toFixed(1)}px`,10,s)}}drawGrid(e){const t=this.mapSize,s=w.BORDER_WIDTH;e.fillStyle="rgb(211, 225, 237)",e.fillRect(0,0,t,t),e.strokeStyle="rgba(180, 200, 220, 0.5)",e.lineWidth=1;const i=w.CELL_WIDTH*2;e.beginPath();for(let n=0;n<=t;n+=i)e.moveTo(n,0),e.lineTo(n,t);for(let n=0;n<=t;n+=i)e.moveTo(0,n),e.lineTo(t,n);e.stroke(),e.fillStyle="lightgray",e.fillRect(-s,0,s,t),e.fillRect(-s,-s,t+s*2,s),e.fillRect(t,0,s,t),e.fillRect(-s,t,t+s*2,s)}drawTerritory(e,t){if(!t.territory||t.territory.length<3)return;const s=t.base,i=t.isSnipped;let n=1;if(i){const o=Date.now()/100;n=.3+.5*(.5+.5*Math.sin(o*4))}e.fillStyle=s.deriveAlpha(.4*n).rgbString(),e.beginPath(),e.moveTo(t.territory[0].x,t.territory[0].y);for(let o=1;o<t.territory.length;o++)e.lineTo(t.territory[o].x,t.territory[o].y);e.closePath(),e.fill();const a=this.getOutlineThickness(t.num);e.strokeStyle=s.deriveAlpha(.9*n).rgbString(),e.lineWidth=2.5*a,e.lineJoin="round",e.lineCap="round",e.stroke()}drawTrail(e,t){if(!t.trail||t.trail.length<1)return;const i=t.base.lighter(.2);e.strokeStyle=i.rgbString(),e.lineWidth=te,e.lineCap="round",e.lineJoin="round";const n=t.x,a=t.y,o=this.snipFuses.get(t.num);if(o&&(t.isSnipped||!o.sawSnipped)){if(o.remainingPoints&&o.remainingPoints.length>=2&&o.fusePos){e.beginPath(),e.moveTo(o.remainingPoints[0].x,o.remainingPoints[0].y);for(let l=1;l<o.remainingPoints.length;l++)e.lineTo(o.remainingPoints[l].x,o.remainingPoints[l].y);e.stroke(),this._drawFuseSpark(e,o.fusePos,o.remainingPoints,t.num);return}if(t.trail&&t.trail.length>=1){const l=w.SPEED,c=w.SNIP_FUSE_SPEED_MULT,f=l*c*60*o.elapsed,p=[...t.trail,{x:t.x,y:t.y}],g=this._sumLength(p),T=Math.min(f,g),y=this._pointAtDistanceWithIndex(p,T);if(y.point){const S=p.slice(y.index+1),v=[y.point,...S];if(v.length>=2){e.beginPath(),e.moveTo(v[0].x,v[0].y);for(let E=1;E<v.length;E++)e.lineTo(v[E].x,v[E].y);e.stroke(),this._drawFuseSpark(e,y.point,v,t.num);return}}}if(t.trail&&t.trail.length>=1){const l={x:t.trail[0].x,y:t.trail[0].y};e.beginPath(),e.moveTo(t.trail[0].x,t.trail[0].y);for(let c=1;c<t.trail.length;c++)e.lineTo(t.trail[c].x,t.trail[c].y);e.lineTo(n,a),e.stroke(),this._drawFuseSpark(e,l,t.trail,t.num);return}}e.beginPath(),e.moveTo(t.trail[0].x,t.trail[0].y);for(let l=1;l<t.trail.length-1;l++)e.lineTo(t.trail[l].x,t.trail[l].y);if(t.trail.length>1){const l=t.trail[t.trail.length-1];if(Math.hypot(l.x-n,l.y-a)>te*2){const u=l.x+(n-l.x)*.5,f=l.y+(a-l.y)*.5;e.lineTo(u,f)}}e.lineTo(n,a),e.stroke()}_sparkDirection(e){if(!e||e.length<2)return 0;const t=e[0],s=e[1];return Math.atan2(s.y-t.y,s.x-t.x)}_drawFuseSpark(e,t,s,i){const n=performance.now(),a=.75+.25*Math.sin(n*.02+i),o=te*.6*a;e.save(),e.globalCompositeOperation="lighter";const r=e.createRadialGradient(t.x,t.y,0,t.x,t.y,o*2);r.addColorStop(0,"rgba(255,255,200,0.95)"),r.addColorStop(.35,"rgba(255,180,60,0.65)"),r.addColorStop(1,"rgba(255,40,0,0)"),e.fillStyle=r,e.beginPath(),e.arc(t.x,t.y,o*2,0,Math.PI*2),e.fill();const l=this._sparkDirection(s);for(let c=0;c<6;c++){const u=(c*.9+n*.03+i)%(Math.PI*2),f=l+Math.sin(u)*.7,p=o*2.2*(.4+.6*((Math.sin(u*1.7)+1)*.5)),g=t.x+Math.cos(f)*p,T=t.y+Math.sin(f)*p;e.strokeStyle="rgba(255,200,80,0.9)",e.lineWidth=2,e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(g,T),e.stroke()}e.restore()}drawSpeedSpikes(e,t){const s=t._speedRatio||0;if(s<=0)return;const i=t.x,n=t.y,a=t.angle,o=t.base,r=this.speedSpikeState.pulsePhase,l=3+Math.floor(s*2),c=.8+s*.6,u=18+s*25,f=8+s*6,p=12,g=o.lighter(.3).rgbString(),T=o.rgbString();e.save();for(let y=0;y<l;y++){const S=l>1?y/(l-1)-.5:0,v=a+Math.PI+S*c,E=y/l*Math.PI*2,A=.4+(Math.sin(r+E)*.5+.5)*.6,C=u*A,H=f*A;if(C<3)continue;const oe=i+Math.cos(v)*p,re=n+Math.sin(v)*p,Pe=oe+Math.cos(v)*C,Ee=re+Math.sin(v)*C,ge=v+Math.PI/2,ye=H/2,Ve=(.6+s*.3)*(.6+A*.4);e.globalAlpha=Ve;const Se=e.createLinearGradient(oe,re,Pe,Ee);Se.addColorStop(0,g),Se.addColorStop(.4,T),Se.addColorStop(1,"rgba(0, 0, 0, 0)"),e.fillStyle=Se,e.beginPath(),e.moveTo(oe+Math.cos(ge)*ye,re+Math.sin(ge)*ye),e.lineTo(oe-Math.cos(ge)*ye,re-Math.sin(ge)*ye),e.lineTo(Pe,Ee),e.closePath(),e.fill(),e.globalAlpha=Ve*.7,e.strokeStyle=g,e.lineWidth=Math.max(1,H*.25),e.lineCap="round",e.beginPath(),e.moveTo(oe,re),e.lineTo(Pe,Ee),e.stroke()}e.restore()}drawCoin(e,t){const s=w.COIN_RADIUS;e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.arc(t.x+2,t.y+2,s,0,Math.PI*2),e.fill(),e.fillStyle="#FFD700",e.shadowBlur=5,e.shadowColor="rgba(0, 0, 0, 0.3)",e.beginPath(),e.arc(t.x,t.y,s,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="rgba(255, 255, 255, 0.6)",e.beginPath(),e.arc(t.x-s*.3,t.y-s*.3,s*.3,0,Math.PI*2),e.fill()}drawPlayer(e,t){const s=te*(t.sizeScale||1),i=t.base,n=i.darker(.3),a=i.lighter(.1),o=t.isSnipped;let r=1;if(o){const u=Date.now()/100;r=.3+.5*(.5+.5*Math.sin(u*4))}t.num===this.playerId&&t.drones&&t.drones.length>0&&this.drawDroneRangeIndicator(e,t);for(const u of t.drones)this.drawDrone(e,u,i,t);if(e.fillStyle=n.deriveAlpha(r).rgbString(),e.beginPath(),e.arc(t.x+2,t.y+4,s,0,Math.PI*2),e.fill(),o){const u=.5+.5*Math.sin(Date.now()/100*4);e.fillStyle=`rgba(255, ${Math.floor(100*u)}, ${Math.floor(100*u)}, ${r})`}else e.fillStyle=i.rgbString();if(e.beginPath(),e.arc(t.x,t.y,s,0,Math.PI*2),e.fill(),o){const u=.5+.5*Math.sin(Date.now()/100*6);e.strokeStyle=`rgba(255, 50, 50, ${.5+.5*u})`,e.lineWidth=3+2*u,e.beginPath(),e.arc(t.x,t.y,s+4+2*u,0,Math.PI*2),e.stroke()}const l=t.x+Math.cos(t.angle)*s*.6,c=t.y+Math.sin(t.angle)*s*.6;if(e.fillStyle=a.deriveAlpha(r).rgbString(),e.beginPath(),e.arc(l,c,s*.3,0,Math.PI*2),e.fill(),t.hp<t.maxHp){const u=s*2.5,f=6*(t.sizeScale||1),p=t.x-u/2,g=t.y+s+8;e.fillStyle="rgba(20, 20, 20, 0.8)",e.fillRect(p,g,u,f);const T=Math.max(0,t.hp/t.maxHp);T>.5?e.fillStyle="#44ff44":T>.25?e.fillStyle="#ffcc00":e.fillStyle="#ff4444",e.fillRect(p,g,u*T,f),e.strokeStyle="rgba(0, 0, 0, 0.8)",e.lineWidth=Math.max(1,1.5*(t.sizeScale||1));for(let y=1;y<=3;y++){const S=p+u*y/4;e.beginPath(),e.moveTo(S,g),e.lineTo(S,g+f),e.stroke()}e.strokeStyle="#000000",e.lineWidth=Math.max(1,2*(t.sizeScale||1)),e.strokeRect(p,g,u,f)}if(e.fillStyle=n.rgbString(),e.textAlign="center",e.font="bold 14px Arial",o&&(e.fillStyle="rgba(255, 50, 50, 1)",e.fillText("SNIPPED!",t.x,t.y-s-22),e.fillStyle=n.deriveAlpha(r).rgbString()),e.fillText(t.name,t.x,t.y-s-8),this.debugMode&&t.num!==this.playerId){e.strokeStyle="rgba(0, 255, 0, 0.8)",e.lineWidth=2,e.beginPath(),e.arc(t.serverX,t.serverY,s+5,0,Math.PI*2),e.stroke();const u=t.serverX-t.x,f=t.serverY-t.y,p=Math.sqrt(u*u+f*f);p>1&&(e.strokeStyle="rgba(255, 0, 0, 0.8)",e.lineWidth=2,e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(t.serverX,t.serverY),e.stroke()),e.strokeStyle="rgba(0, 100, 255, 0.8)",e.lineWidth=2,e.beginPath(),e.moveTo(t.serverX,t.serverY),e.lineTo(t.serverX+Math.cos(t.serverAngle)*40,t.serverY+Math.sin(t.serverAngle)*40),e.stroke(),e.fillStyle="rgba(255, 255, 0, 1)",e.font="10px monospace",e.fillText(`err: ${p.toFixed(1)}px`,t.x,t.y+s+25)}}drawDroneRangeIndicator(e,t){const s=w.DRONE_RANGE;e.save();const i=Date.now()/1e3;e.strokeStyle="rgba(0, 0, 0, 0.2)",e.lineWidth=3,e.setLineDash([10,10]),e.lineDashOffset=-i*30,e.beginPath(),e.arc(t.x,t.y,s,0,Math.PI*2),e.stroke(),e.restore()}drawDrone(e,t,s,i){const n=xt,a=i&&i.isSnipped,o=i&&i.num===this.playerId;if(e.save(),e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.arc(t.x+2,t.y+2,n,0,Math.PI*2),e.fill(),t.targetId!==null&&!a){const r=Date.now()/150,l=.4+.3*Math.sin(r*4);e.shadowBlur=12*l,e.shadowColor=o?"#FFD700":s?s.rgbString():"#FF6600"}if(a?e.fillStyle="rgba(100, 100, 100, 0.5)":s?e.fillStyle=s.deriveAlpha(o?.95:.8).rgbString():e.fillStyle=o?"rgba(100, 200, 100, 0.95)":"rgba(200, 100, 100, 0.8)",e.beginPath(),e.arc(t.x,t.y,n,0,Math.PI*2),e.fill(),a?e.strokeStyle="rgba(60, 60, 60, 0.6)":e.strokeStyle=s?s.darker(.2).rgbString():"#444",e.lineWidth=2,e.stroke(),e.shadowBlur=0,a?e.fillStyle="rgba(80, 80, 80, 0.4)":e.fillStyle=s?s.lighter(.3).deriveAlpha(.7).rgbString():"rgba(255, 255, 255, 0.5)",e.beginPath(),e.arc(t.x-n*.25,t.y-n*.25,n*.35,0,Math.PI*2),e.fill(),t.targetId!==null&&!a){const r=Date.now()/100,l=.5+.5*Math.sin(r*5);e.fillStyle=`rgba(255, 100, 100, ${.6+.4*l})`,e.beginPath(),e.arc(t.x,t.y,n*.3,0,Math.PI*2),e.fill()}if(a){e.strokeStyle="rgba(255, 80, 80, 0.8)",e.lineWidth=2,e.lineCap="round";const r=n*.5;e.beginPath(),e.moveTo(t.x-r,t.y-r),e.lineTo(t.x+r,t.y+r),e.moveTo(t.x+r,t.y-r),e.lineTo(t.x-r,t.y+r),e.stroke()}e.restore()}drawHitscan(e,t){const s=t.getAlpha(),i=t.color;e.save(),e.lineCap="round",e.lineWidth=12*s,e.strokeStyle=i.deriveAlpha(.5*s).rgbString(),e.beginPath(),e.moveTo(t.fromX,t.fromY),e.lineTo(t.toX,t.toY),e.stroke(),e.lineWidth=5*s,e.strokeStyle=i.lighter(.4).deriveAlpha(.95*s).rgbString(),e.beginPath(),e.moveTo(t.fromX,t.fromY),e.lineTo(t.toX,t.toY),e.stroke(),e.lineWidth=2*s,e.strokeStyle=`rgba(255, 255, 255, ${s})`,e.beginPath(),e.moveTo(t.fromX,t.fromY),e.lineTo(t.toX,t.toY),e.stroke();const n=20*s,a=e.createRadialGradient(t.toX,t.toY,0,t.toX,t.toY,n);a.addColorStop(0,i.lighter(.6).deriveAlpha(s).rgbString()),a.addColorStop(.4,i.deriveAlpha(.6*s).rgbString()),a.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=a,e.beginPath(),e.arc(t.toX,t.toY,n,0,Math.PI*2),e.fill(),e.restore()}drawTopBar(e){const t=this.players.get(this.playerId);if(!t)return;e.fillStyle="#3a3a3a",e.fillRect(0,0,this.canvas.width,X),e.textAlign="left",e.textBaseline="alphabetic";const s=t.level||1;t.drones&&t.drones.length;let i=15;const n=X/2+6;e.fillStyle="#88CCFF",e.font="bold 16px Arial",e.fillText("RTT:",i,n),i+=e.measureText("RTT:").width+5,e.fillStyle="white",e.fillText(`${Math.round(this.net.getRTT())}ms`,i,n),i+=e.measureText(`${Math.round(this.net.getRTT())}ms`).width+20,e.fillStyle="#FFD700",e.font="bold 16px Arial",e.fillText("Level:",i,n),i+=e.measureText("Level:").width+5,e.fillStyle="white",e.fillText(s,i,n),i+=e.measureText(String(s)).width+20,e.fillStyle="#FF6B6B",e.font="bold 16px Arial",e.fillText("HP:",i,n),i+=e.measureText("HP:").width+5,e.fillStyle="white",e.fillText(`${Math.round(t.hp)}/${t.maxHp}`,i,n),i+=e.measureText(`${Math.round(t.hp)}/${t.maxHp}`).width+20,e.fillStyle="#9370DB",e.font="bold 16px Arial",e.fillText("XP:",i,n),i+=e.measureText("XP:").width+5,e.fillStyle="white",e.fillText(t.xp,i,n),i+=e.measureText(String(t.xp)).width+20;const a=this.getTerritoryPercent(this.playerId);e.fillStyle="#98FB98",e.font="bold 16px Arial",e.fillText("Territory:",i,n),i+=e.measureText("Territory:").width+5,e.fillStyle="white",e.fillText(`${a.toFixed(2)}%`,i,n)}drawLeaderboard(e){const t=this.getLeaderboard().filter(n=>!n.player.dead),s=Math.min(w.LEADERBOARD_NUM,t.length),i=t.length>0?t[0].portion:0;e.font="18px Arial",e.textAlign="left";for(let n=0;n<s;n++){const{player:a,portion:o}=t[n],r=a.name||"Unnamed",l=a.base,c=l.darker(.3),u=i>0?o/i:0,f=Math.ceil((Bt-Ge)*u+Ge),p=this.canvas.width-f,g=X*(n+1),T=n===0?10:0;e.fillStyle="rgba(10, 10, 10, 0.3)",e.fillRect(p-10,g+10-T,f+10,X+T),e.fillStyle=l.rgbString(),e.fillRect(p,g,f,X-Y),e.fillStyle=c.rgbString(),e.fillRect(p,g+X-Y,f,Y);const y=e.measureText(r).width;e.fillStyle="black",e.fillText(r,p-y-15,g+27);const S=a.num===this.playerId,v=`${(o*100).toFixed(1)}%`;e.fillStyle=S?"#FFD700":"white",e.fillText(v,p+5,g+X-15)}}drawXPBar(e){const t=this.players.get(this.playerId);if(!t)return;const s=t.level||1,i=t.xp||0,n=w.XP_BASE_PER_LEVEL+(s-1)*w.XP_INCREMENT_PER_LEVEL,a=250,o=28,r=(this.canvas.width-a)/2,l=this.canvas.height-45,c=Math.min(1,i/n),u=t.base,f=u.darker(.3);if(e.fillStyle="rgba(10, 10, 10, 0.5)",e.fillRect(r-60,l-2,a+70,o+4),e.font="bold 18px Arial",e.fillStyle="#FFD700",e.textAlign="left",e.fillText(`Lv.${s}`,r-55,l+o-8),e.fillStyle="rgba(60, 60, 60, 0.8)",e.fillRect(r,l,a,o-Y),e.fillStyle="rgba(40, 40, 40, 0.8)",e.fillRect(r,l+o-Y,a,Y),c>0){const p=a*c;e.fillStyle=u.rgbString(),e.fillRect(r,l,p,o-Y),e.fillStyle=f.rgbString(),e.fillRect(r,l+o-Y,p,Y)}e.font="16px Arial",e.fillStyle="white",e.textAlign="center",e.fillText(`${Math.floor(i)}/${n} XP`,r+a/2,l+o-9)}getSelfPlayer(){return this.players.get(this.playerId)}resize(e,t){this.canvas.width=e,this.canvas.height=t}}let K,ae,Q,J,ue,ve,he,Ne,b,ht,ct,ut,Fe,dt,we,Xe,se,Ye,ze,We,be=0,me=1;const ft="swarmblitz.audio.v1";function $t(){try{const h=localStorage.getItem(ft);if(!h)return null;const e=JSON.parse(h);return e&&typeof e=="object"?e:null}catch{return null}}function ke(){try{const h=_e?_e():null;if(!h)return;localStorage.setItem(ft,JSON.stringify(h))}catch{}}function Kt(){const h=document.getElementById("vol-master"),e=document.getElementById("vol-music"),t=document.getElementById("vol-sfx"),s=document.getElementById("vol-master-val"),i=document.getElementById("vol-music-val"),n=document.getElementById("vol-sfx-val");h&&s&&(s.textContent=`${h.value}%`),e&&i&&(i.textContent=`${e.value}%`),t&&n&&(n.textContent=`${t.value}%`)}function Qt(){const h=$t();if(!h)return;typeof h.masterVolume=="number"&&Je(h.masterVolume),typeof h.musicVolume=="number"&&Ze(h.musicVolume),typeof h.sfxVolume=="number"&&et(h.sfxVolume),h.volumes&&typeof h.volumes=="object"&&Pt(h.volumes),typeof h.enabled=="boolean"&&bt(h.enabled);const e=document.getElementById("vol-master"),t=document.getElementById("vol-music"),s=document.getElementById("vol-sfx");e&&typeof h.masterVolume=="number"&&(e.value=String(Math.round(h.masterVolume*100))),t&&typeof h.musicVolume=="number"&&(t.value=String(Math.round(h.musicVolume*100))),s&&typeof h.sfxVolume=="number"&&(s.value=String(Math.round(h.sfxVolume*100))),Kt()}function de(){Mt(),q(),ae&&ae.style.display!=="none"&&at()}function He(){K=document.getElementById("main-ui"),ae=document.getElementById("begin"),Q=document.getElementById("wasted"),J=document.getElementById("settings"),ue=document.getElementById("name"),ve=document.querySelector(".start.start-btn.primary"),he=document.querySelector(".spectate.start-btn.secondary"),Ne=document.getElementById("error"),ht=document.getElementById("death-score"),ct=document.getElementById("death-kills"),ut=document.getElementById("death-level"),Fe=document.getElementById("death-killer-info"),dt=document.getElementById("death-killer-name"),we=Q.querySelector(".start.orange"),Xe=Q.querySelector(".menu.yellow"),se=Q.querySelector(".spectate.green"),Ye=document.querySelector(".toggle.yellow"),ze=document.getElementById("settings-close"),We=document.getElementById("settings-menu-btn"),$e(),window.addEventListener("resize",$e),ve.addEventListener("click",Le),ue.addEventListener("keypress",t=>{t.key==="Enter"&&!ve.disabled&&Le()}),console.log("[INIT] spectateButton:",he),console.log("[INIT] spectateDeathButton:",se),he?he.addEventListener("click",()=>{console.log("[CLICK] Spectate button clicked!"),Qe()}):console.error("[INIT] spectateButton not found!"),se?se.addEventListener("click",()=>{console.log("[CLICK] Spectate death button clicked!"),Qe()}):console.error("[INIT] spectateDeathButton not found!"),we.addEventListener("click",Le),Xe.addEventListener("click",Ke),Ye.addEventListener("click",Zt),ze.addEventListener("click",()=>{J.style.display="none"}),We.addEventListener("click",()=>{J.style.display="none",Ke()});const h=document.getElementById("how-to-play-toggle"),e=document.getElementById("how-to-play-content");h&&e&&h.addEventListener("click",()=>{const t=e.style.display!=="none";e.style.display=t?"none":"block",h.classList.toggle("expanded",!t)}),jt(),Qt(),document.addEventListener("pointerdown",de,{once:!0}),document.addEventListener("touchstart",de,{once:!0,passive:!0}),document.addEventListener("keydown",de,{once:!0}),Jt(),ue.focus()}function jt(){const h=document.getElementById("vol-master"),e=document.getElementById("vol-music"),t=document.getElementById("vol-sfx"),s=document.getElementById("vol-master-val"),i=document.getElementById("vol-music-val"),n=document.getElementById("vol-sfx-val");h&&s&&h.addEventListener("input",()=>{s.textContent=`${h.value}%`,Je(parseInt(h.value,10)/100),ke()}),e&&i&&e.addEventListener("input",()=>{i.textContent=`${e.value}%`,Ze(parseInt(e.value,10)/100),ke()}),t&&n&&t.addEventListener("input",()=>{n.textContent=`${t.value}%`,et(parseInt(t.value,10)/100),ke()})}function Jt(){ve.disabled=!1,he.disabled=!1,we.disabled=!1,se.disabled=!1,Ne.textContent="Ready to play!",Ne.style.color="#4caf50"}function $e(){K&&(K.width=window.innerWidth,K.height=window.innerHeight,b&&b.resize(K.width,K.height))}function Zt(){const h=J.style.display!=="none";J.style.display=h?"none":"block"}function Ke(){b&&(b.disconnect(),b=null),Q.style.display="none",J.style.display="none",ae.style.display="flex",ue.focus(),be=0,me=1,nt(),at()}function Le(){const h=ue.value.trim()||"Player";de(),ae.style.display="none",Q.style.display="none",J.style.display="none",be=0,me=1,ot(),it();const e=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",t=window.location.search.includes("prod");let s;e&&!t?(s="ws://localhost:8787/room/default",console.log("%cðŸ”§ CONNECTING TO LOCAL SERVER","background: #ff9800; color: black; font-size: 16px; padding: 4px 8px;")):(s="wss://swarmblitz.dev-1dd.workers.dev/room/default",console.log("%câ˜ï¸ CONNECTING TO PRODUCTION SERVER","background: #4caf50; color: white; font-size: 16px; padding: 4px 8px;")),console.log("WebSocket URL:",s),b=new lt(K,{wsUrl:s,onDeath:pt,onKill:mt,onLevelUp:gt}),b.connect(h)}function Qe(){console.log("[SPECTATE] startSpectate() called"),de(),console.log("[SPECTATE] Hiding screens..."),ae.style.display="none",Q.style.display="none",J.style.display="none",ot(),it();const h=window.location.search.includes("prod");let e;h?(e="wss://swarmblitz.dev-1dd.workers.dev/room/default",console.log("%cðŸ‘ SPECTATING PRODUCTION SERVER","background: #9c27b0; color: white; font-size: 16px; padding: 4px 8px;")):(e="ws://localhost:8787/room/default",console.log("%cðŸ‘ SPECTATING LOCAL SERVER","background: #9c27b0; color: white; font-size: 16px; padding: 4px 8px;")),console.log("[SPECTATE] wsUrl:",e),console.log("[SPECTATE] Creating GameClient..."),b=new lt(K,{wsUrl:e,spectateMode:!0,onDeath:pt,onKill:mt,onLevelUp:gt}),console.log("[SPECTATE] GameClient created:",b),console.log("[SPECTATE] Calling connectSpectate()..."),b.connectSpectate(),console.log("[SPECTATE] connectSpectate() called")}function pt(h){console.log("You died!",h);const e=b?b.getSelfPlayer():null,t=e?e.level:me;let s="0.00%";b&&(s=`${b.getTerritoryPercent(b.playerId).toFixed(2)}%`),ht.textContent=s,ct.textContent=be.toString(),ut.textContent=t.toString();let i=null;if(b&&b.lastKillerName)i=b.lastKillerName;else if(h.killerNum!==void 0&&h.killerNum!==65535){const n=b?b.players.get(h.killerNum):null;n&&(i=n.name)}i?(dt.textContent=i,Fe.style.display="block"):Fe.style.display="none",setTimeout(()=>{b&&(b.disconnect(),b=null),we.disabled=!1,se.disabled=!1,Q.style.display="flex"},1500)}function mt(h){console.log("You killed someone!",h),be++}function gt(h){console.log("Level up!",h),h.newLevel>me&&(me=h.newLevel)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",He):He();window.getGameClient=()=>b;
