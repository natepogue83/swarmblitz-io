(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();const W={INPUT:2,PING:3,FRAME:18,DEAD:19,PONG:20},U={POSITION:1,ANGLE:2,HP:4,XP:8,LEVEL:16,DRONES:32,TERRITORY:64,TRAIL:128},b={PLAYER_JOIN:1,PLAYER_LEAVE:2,PLAYER_KILL:3,COIN_SPAWN:4,COIN_PICKUP:5,HITSCAN:6,CAPTURE:7,LEVEL_UP:8,SNIP_START:9},le={POS_MAX:65535,ANGLE_MAX:255,ANGLE_SCALE:65535,HP_MAX:255};function E(l,e){return l/le.POS_MAX*e}function ye(l){return l/le.ANGLE_MAX*Math.PI*2}function Se(l,e){return l/le.HP_MAX*e}function Ke(l){const e=l>>8&255,t=l>>4&15,s=l&15;return{hue:e/255,sat:t/15,lum:s/15}}class Je{constructor(e){this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.view=new DataView(this.buffer),this.offset=0}readU8(){return this.view.getUint8(this.offset++)}readU16(){const e=this.view.getUint16(this.offset,!0);return this.offset+=2,e}readU32(){const e=this.view.getUint32(this.offset,!0);return this.offset+=4,e}readI8(){return this.view.getInt8(this.offset++)}readI16(){const e=this.view.getInt16(this.offset,!0);return this.offset+=2,e}readF32(){const e=this.view.getFloat32(this.offset,!0);return this.offset+=4,e}readString(){const e=this.readU8(),t=new Uint8Array(this.buffer,this.offset,e);return this.offset+=e,new TextDecoder().decode(t)}readBytes(e){const t=new Uint8Array(this.buffer,this.offset,e);return this.offset+=e,t}hasMore(){return this.offset<this.buffer.byteLength}}const P={DISCONNECTED:0,CONNECTING:1,CONNECTED:2,RECONNECTING:3};class je{constructor(e={}){this.url=e.url||"ws://localhost:8787/room/default",this.reconnectDelay=e.reconnectDelay||1e3,this.maxReconnectDelay=e.maxReconnectDelay||3e4,this.inputThrottleMs=e.inputThrottleMs||50,this.ws=null,this.state=P.DISCONNECTED,this.reconnectAttempts=0,this.playerId=null,this.mapSize=0,this.rtt=0,this.lastPingTime=0,this.pingInterval=null,this.lastInputTime=0,this.pendingAngle=null,this.onStateChange=e.onStateChange||(()=>{}),this.onInit=e.onInit||(()=>{}),this.onFrame=e.onFrame||(()=>{}),this.onEvent=e.onEvent||(()=>{}),this.onError=e.onError||(()=>{}),this.onReset=e.onReset||(()=>{})}connect(e){if(this.state===P.DISCONNECTED){this.playerName=e,this.isSpectator=!1,this.setState(P.CONNECTING);try{this.ws=new WebSocket(this.url),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>this.handleOpen(),this.ws.onmessage=t=>this.handleMessage(t),this.ws.onclose=t=>this.handleClose(t),this.ws.onerror=t=>this.handleError(t)}catch(t){this.onError(t),this.scheduleReconnect()}}}connectSpectate(){if(this.state===P.DISCONNECTED){this.playerName=null,this.isSpectator=!0,this.setState(P.CONNECTING);try{this.ws=new WebSocket(this.url),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>this.handleOpenSpectate(),this.ws.onmessage=e=>this.handleMessage(e),this.ws.onclose=e=>this.handleClose(e),this.ws.onerror=e=>this.handleError(e)}catch(e){this.onError(e),this.scheduleReconnect()}}}disconnect(){this.reconnectAttempts=0,this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.ws&&(this.ws.onclose=null,this.ws.close(),this.ws=null),this.setState(P.DISCONNECTED)}sendInput(e){if(this.state!==P.CONNECTED)return;const t=Date.now();if(t-this.lastInputTime<this.inputThrottleMs){this.pendingAngle=e;return}this.lastInputTime=t,this.pendingAngle=null;const s=new ArrayBuffer(3),n=new DataView(s);n.setUint8(0,W.INPUT);const i=(e+Math.PI)/(Math.PI*2),o=Math.round(i*le.ANGLE_SCALE)&65535;n.setUint16(1,o,!0),this.ws.send(s)}flushInput(){if(this.pendingAngle!==null){const e=this.pendingAngle;this.pendingAngle=null,this.lastInputTime=0,this.sendInput(e)}}sendPing(){if(this.state!==P.CONNECTED)return;this.lastPingTime=performance.now();const e=new ArrayBuffer(9),t=new DataView(e);t.setUint8(0,W.PING),t.setFloat64(1,this.lastPingTime,!0),this.ws.send(e)}sendReset(){!this.ws||this.ws.readyState!==WebSocket.OPEN||this.ws.send(JSON.stringify({type:"reset"}))}handleOpen(){this.reconnectAttempts=0,this.ws.send(JSON.stringify({type:"hello",name:this.playerName})),this.pingInterval=setInterval(()=>this.sendPing(),2e3)}handleOpenSpectate(){this.reconnectAttempts=0,this.ws.send(JSON.stringify({type:"hello",spectate:!0})),this.pingInterval=setInterval(()=>this.sendPing(),2e3)}handleMessage(e){try{e.data instanceof ArrayBuffer?this.handleBinaryMessage(e.data):this.handleTextMessage(JSON.parse(e.data))}catch(t){console.error("Message parse error:",t)}}handleBinaryMessage(e){const t=new DataView(e);switch(t.getUint8(0)){case W.FRAME:this.handleFrame(e);break;case W.PONG:this.handlePong(t);break;case W.DEAD:this.handleDead(t);break}}handleTextMessage(e){switch(e.type){case"init":this.handleInit(e);break;case"error":this.onError(new Error(e.error));break;case"pong":this.rtt=Date.now()-e.t;break;case"reset":console.log("%cüîÑ Room reset, reconnecting...","color: orange; font-weight: bold;"),this.onReset();break;default:this.onEvent(e)}}handleInit(e){this.playerId=e.playerId,this.mapSize=e.mapSize,this.setState(P.CONNECTED),this.onInit({playerId:e.playerId,mapSize:e.mapSize,player:e.player,players:e.players,coins:e.coins})}handleFrame(e){const t=new Je(e),s=this.mapSize;t.readU8();const n=t.readU32(),i=t.readU8();let o=null;i&&(o=this.readPlayerFull(t,s));const a=t.readU8(),r=[];for(let p=0;p<a;p++)r.push(this.readPlayerFull(t,s));const h=t.readU8(),c=[];for(let p=0;p<h;p++)c.push(this.readPlayerDelta(t,s));const u=t.readU8(),d=[];for(let p=0;p<u;p++)d.push(t.readU16());const m=t.readU8(),y=[];for(let p=0;p<m;p++)y.push({id:t.readU16(),x:t.readU16(),y:t.readU16()});const S=t.readU8(),v=[];for(let p=0;p<S;p++)v.push(this.readEvent(t,s));this.onFrame({frame:n,selfPlayer:o,newPlayers:r,updatedPlayers:c,removedPlayerIds:d,coins:y,events:v})}readPlayerFull(e,t){const s=e.readU16(),n=e.readString(),i=E(e.readU16(),t),o=E(e.readU16(),t),a=ye(e.readU16()),r=Se(e.readU8(),100),h=e.readU8(),c=e.readU16(),u=e.readU8()/100,d=e.readU8(),m=(d&1)!==0,y=(d&2)!==0,S=Ke(e.readU8()),v=e.readU8()/255,p=e.readU8()/255,N=e.readU8(),Z=[];for(let H=0;H<N;H++)Z.push({x:E(e.readU16(),t),y:E(e.readU16(),t)});const ee=e.readU8(),q=[];for(let H=0;H<ee;H++)q.push({x:E(e.readU16(),t),y:E(e.readU16(),t)});const he=e.readU8();return{num:s,name:n,x:i,y:o,angle:a,hp:r,maxHp:100,level:h,xp:c,sizeScale:u,dead:m,isSnipped:y,base:{hue:S,sat:v,lum:p},territory:Z,trail:q,droneCount:he}}readPlayerDelta(e,t){const s=e.readU16(),n=e.readU8(),i={num:s};if(n&U.POSITION&&(i.x=E(e.readU16(),t),i.y=E(e.readU16(),t)),n&U.ANGLE&&(i.angle=ye(e.readU16())),n&U.HP&&(i.hp=Se(e.readU8(),100)),n&U.XP&&(i.xp=e.readU16()),n&U.LEVEL&&(i.level=e.readU8()),n&U.DRONES&&(i.droneCount=e.readU8()),n&U.TERRITORY){const o=e.readU8();i.territory=[];for(let a=0;a<o;a++)i.territory.push({x:E(e.readU16(),t),y:E(e.readU16(),t)})}if(n&U.TRAIL){const o=e.readU8();i.trail=[];for(let a=0;a<o;a++)i.trail.push({x:E(e.readU16(),t),y:E(e.readU16(),t)})}return i}readEvent(e,t){const s=e.readU8(),n={type:s};switch(s){case b.PLAYER_JOIN:n.player=this.readPlayerFull(e,t);break;case b.PLAYER_LEAVE:n.num=e.readU16(),n.silent=e.readU8()===1;break;case b.PLAYER_KILL:n.killerNum=e.readU16(),n.victimNum=e.readU16(),n.killType=e.readU8();break;case b.COIN_SPAWN:n.id=e.readU16(),n.x=E(e.readU16(),t),n.y=E(e.readU16(),t),n.value=e.readU8();break;case b.COIN_PICKUP:n.id=e.readU16(),n.playerNum=e.readU16();break;case b.HITSCAN:n.ownerNum=e.readU16(),n.targetNum=e.readU16(),n.damage=e.readU8();break;case b.CAPTURE:n.playerNum=e.readU16(),n.x=E(e.readU16(),t),n.y=E(e.readU16(),t),n.xpGained=e.readU8();break;case b.LEVEL_UP:n.playerNum=e.readU16(),n.newLevel=e.readU8();break;case b.SNIP_START:n.playerNum=e.readU16(),n.snipperNum=e.readU16();break}return n}handlePong(e){const t=e.getFloat64(1,!0);this.rtt=performance.now()-t}handleDead(e){const t=e.getUint16(1,!0),s=e.getUint8(3);this.onEvent({type:"dead",killerNum:t,killType:s})}handleClose(e){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.ws=null,this.state!==P.DISCONNECTED&&this.scheduleReconnect()}handleError(e){console.error("WebSocket error:",e),this.onError(new Error("WebSocket error"))}scheduleReconnect(){this.setState(P.RECONNECTING);const e=Math.min(this.reconnectDelay*Math.pow(2,this.reconnectAttempts),this.maxReconnectDelay);this.reconnectAttempts++,setTimeout(()=>{this.state===P.RECONNECTING&&(this.setState(P.DISCONNECTED),this.connect(this.playerName))},e)}setState(e){this.state!==e&&(this.state=e,this.onStateChange(e))}getRTT(){return this.rtt}isConnected(){return this.state===P.CONNECTED}}function ue(){for(let l=0;l<arguments.length;l++)if(arguments[l]<0||arguments[l]>1)throw new RangeError("H, S, L, and A parameters must be between [0, 1]")}function Qe(l,e,t){let s,n,i;if(e===0)s=n=i=t;else{const o=(h,c,u)=>(u<0&&(u+=1),u>1&&(u-=1),u<.16666666666666666?h+(c-h)*6*u:u<.5?c:u<.6666666666666666?h+(c-h)*(.6666666666666666-u)*6:h),a=t<.5?t*(1+e):t+e-t*e,r=2*t-a;s=o(r,a,l+1/3),n=o(r,a,l),i=o(r,a,l-1/3)}return[Math.round(s*255),Math.round(n*255),Math.round(i*255)]}class D{constructor(e,t,s,n=1){ue(e,t,s),n!==1&&ue(n),Object.defineProperties(this,{hue:{value:e,enumerable:!0},sat:{value:t,enumerable:!0},lum:{value:s,enumerable:!0},alpha:{value:n,enumerable:!0}})}deriveLumination(e){let t=Math.min(Math.max(this.lum+e,0),1);return new D(this.hue,this.sat,t,this.alpha)}deriveHue(e){const t=this.hue-e;return new D(t-Math.floor(t),this.sat,this.lum,this.alpha)}deriveSaturation(e){let t=Math.min(Math.max(this.sat+e,0),1);return new D(this.hue,t,this.lum,this.alpha)}deriveAlpha(e){return ue(e),new D(this.hue,this.sat,this.lum,e)}lighter(e){return this.deriveLumination(e)}darker(e){return this.deriveLumination(-e)}rgbString(){const e=Qe(this.hue,this.sat,this.lum);return`rgba(${e[0]}, ${e[1]}, ${e[2]}, ${this.alpha})`}static fromData(e){return new D(e.hue,e.sat,e.lum,e.alpha??1)}static possColors(){const e=[192,150,100].map(n=>n/240),t=[0,10,20,25,30,35,40,45,50,60,70,100,110,120,125,130,135,140,145,150,160,170,180,190,200,210,220].map(n=>n/240),s=[];for(const n of e)for(const i of t)s.push(new D(i,n,.5,1));for(let n=s.length-1;n>0;n--){const i=Math.floor(Math.random()*(n+1));[s[n],s[i]]=[s[i],s[n]]}return s}}const w={CELL_WIDTH:40,SPEED:4,BORDER_WIDTH:20,LEADERBOARD_NUM:5,SNIP_FUSE_SPEED_MULT:1.5,SNIP_EXP_ACCEL_PER_SEC:.6375,SNIP_FUSE_MAX_SPEED_MULT:6,SNIP_GRACE_PERIOD:.25,COIN_RADIUS:8,XP_BASE_PER_LEVEL:100,XP_INCREMENT_PER_LEVEL:25,DRONE_ORBIT_RADIUS:55,DRONE_ORBIT_SPEED:2,DRONE_RADIUS:10};let g=null,C=null,B=!1;const f={masterVolume:.6,sfxVolume:.8,musicVolume:.3,enabled:!0,volumes:{playerLaser:.3,enemyLaser:.2,playerFuse:1,enemyFuse:.7,capture:1,levelUp:.8,death:2,kill:2,coinPickup:1,hit:1.5,trailing:.4,speedRush:.5}};let k=null,I=null,J=null,M=null,V=!1,F=[],X=[],Y=0,A=null,$=!1;const Ze="/music/playlist/menu/SwarmBlitz - Main Menu Theme.mp3";function Ne(l){const e=[...l];for(let t=e.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}return e}function et(){if(!B)try{g=new(window.AudioContext||window.webkitAudioContext),C=g.createGain(),C.gain.value=f.masterVolume,C.connect(g.destination),B=!0,console.log("[SoundManager] Initialized")}catch(l){console.warn("[SoundManager] Web Audio API not supported:",l),f.enabled=!1}}function Q(){g&&g.state==="suspended"&&g.resume()}function tt(l){f.enabled=!!l}function Re(l){f.masterVolume=Math.max(0,Math.min(1,l)),C&&(C.gain.value=f.masterVolume),Fe()}function Le(l){f.musicVolume=Math.max(0,Math.min(1,l)),Fe()}function ke(l){f.sfxVolume=Math.max(0,Math.min(1,l))}function st(l){for(const[e,t]of Object.entries(l))Object.prototype.hasOwnProperty.call(f.volumes,e)&&(f.volumes[e]=Math.max(0,Math.min(1,t)))}function ve(){return{enabled:f.enabled,masterVolume:f.masterVolume,sfxVolume:f.sfxVolume,musicVolume:f.musicVolume,volumes:{...f.volumes}}}function nt(){if(!B||!f.enabled||f.volumes.playerLaser<=0)return;Q();const l=f.volumes.playerLaser,e=g.currentTime,t=.15,s=g.createOscillator(),n=g.createOscillator(),i=g.createGain(),o=g.createBiquadFilter();s.type="sawtooth",n.type="square",s.frequency.setValueAtTime(1800,e),s.frequency.exponentialRampToValueAtTime(400,e+t*.7),n.frequency.setValueAtTime(1400,e),n.frequency.exponentialRampToValueAtTime(300,e+t*.7),o.type="lowpass",o.frequency.setValueAtTime(4e3,e),o.frequency.exponentialRampToValueAtTime(800,e+t),o.Q.value=2,i.gain.setValueAtTime(0,e),i.gain.linearRampToValueAtTime(.35*f.sfxVolume*l,e+.01),i.gain.exponentialRampToValueAtTime(.01,e+t),s.connect(o),n.connect(o),o.connect(i),i.connect(C),s.start(e),n.start(e),s.stop(e+t),n.stop(e+t)}function it(l,e=800){if(!B||!f.enabled||f.volumes.enemyLaser<=0)return;Q();const t=f.volumes.enemyLaser,s=Math.max(0,1-l/e);if(s<.05)return;const n=g.currentTime,i=.12,o=g.createOscillator(),a=g.createOscillator(),r=g.createGain(),h=g.createBiquadFilter();o.type="sawtooth",a.type="triangle",o.frequency.setValueAtTime(900,n),o.frequency.exponentialRampToValueAtTime(250,n+i*.8),a.frequency.setValueAtTime(700,n),a.frequency.exponentialRampToValueAtTime(180,n+i*.8),h.type="lowpass",h.frequency.setValueAtTime(2500,n),h.frequency.exponentialRampToValueAtTime(500,n+i),h.Q.value=3;const c=.25*f.sfxVolume*t*s;r.gain.setValueAtTime(0,n),r.gain.linearRampToValueAtTime(c,n+.008),r.gain.exponentialRampToValueAtTime(.01,n+i),o.connect(h),a.connect(h),h.connect(r),r.connect(C),o.start(n),a.start(n),o.stop(n+i),a.stop(n+i)}function ot(){if(!B||!f.enabled||f.volumes.coinPickup<=0)return;Q();const l=f.volumes.coinPickup,e=g.currentTime,t=g.createOscillator(),s=g.createOscillator(),n=g.createGain();t.type="sine",s.type="triangle",t.frequency.setValueAtTime(800,e),t.frequency.exponentialRampToValueAtTime(1400,e+.08),s.frequency.setValueAtTime(1200,e),s.frequency.exponentialRampToValueAtTime(2100,e+.08),n.gain.setValueAtTime(0,e),n.gain.linearRampToValueAtTime(.2*f.sfxVolume*l,e+.015),n.gain.exponentialRampToValueAtTime(.01,e+.2),t.connect(n),s.connect(n),n.connect(C),t.start(e),s.start(e),t.stop(e+.2),s.stop(e+.2);const i=g.createOscillator(),o=g.createGain();i.type="sine",i.frequency.setValueAtTime(2400,e+.02),i.frequency.exponentialRampToValueAtTime(3200,e+.1),o.gain.setValueAtTime(0,e+.02),o.gain.linearRampToValueAtTime(.08*f.sfxVolume*l,e+.04),o.gain.exponentialRampToValueAtTime(.01,e+.15),i.connect(o),o.connect(C),i.start(e+.02),i.stop(e+.15)}function at(){if(!B||!f.enabled||k)return;Q();const e=g.sampleRate*1.5,t=g.createBuffer(1,e,g.sampleRate),s=t.getChannelData(0);for(let m=0;m<e;m++){const y=m/g.sampleRate,S=(Math.random()*2-1)*.5,v=Math.random()>.7?(Math.random()*2-1)*.6:0,p=Math.random()>.97?(Math.random()*2-1)*1:0,N=Math.sin(y*150+Math.random()*2)*.2*(Math.random()>.5?1:0);s[m]=S+v+p+N}const n=g.createBufferSource();n.buffer=t,n.loop=!0;const i=g.createBiquadFilter();i.type="highpass",i.frequency.value=1500,i.Q.value=.7;const o=g.createBiquadFilter();o.type="peaking",o.frequency.value=5e3,o.Q.value=1,o.gain.value=6;const a=g.createOscillator();a.type="sawtooth",a.frequency.value=80;const r=g.createGain();r.gain.value=.08;const h=g.createBiquadFilter();h.type="bandpass",h.frequency.value=200,h.Q.value=3,I=g.createGain();const c=f.volumes.playerFuse??1;I.gain.value=.15*f.sfxVolume*c;const u=g.createOscillator();u.type="sine",u.frequency.value=12;const d=g.createGain();d.gain.value=.02,n.connect(i),i.connect(o),o.connect(I),a.connect(h),h.connect(r),r.connect(I),u.connect(d),d.connect(I.gain),I.connect(C),n.start(),a.start(),u.start(),k={noise:n,burnOsc:a,lfo:u},J=o}function lt(){if(k)try{if(I){const l=g.currentTime;I.gain.linearRampToValueAtTime(0,l+.1)}setTimeout(()=>{try{k&&(k.noise.stop(),k.burnOsc.stop(),k.lfo.stop())}catch{}k=null,I=null,J=null},150)}catch{k=null,I=null,J=null}}function rt(l){if(!I||!B||!f.enabled||f.volumes.playerFuse<=0)return;const e=f.volumes.playerFuse,t=.15,n=(t+(.45-t)*l)*f.sfxVolume*e,i=g.currentTime;if(I.gain.linearRampToValueAtTime(n,i+.05),J){const r=4+6*l;J.gain.linearRampToValueAtTime(r,i+.05)}}async function ht(){try{return F=(await(await fetch("/api/playlist")).json()).tracks||[],console.log("[SoundManager] Playlist loaded:",F.length,"tracks"),F.length>0}catch(l){return console.warn("[SoundManager] Could not fetch playlist:",l),!1}}function me(){Ue()}function De(){if(!V||X.length===0)return;const l=X[Y],e=`/music/playlist/${encodeURIComponent(l)}`;console.log("[SoundManager] Playing track:",l,`(${Y+1}/${X.length})`),M&&(M.pause(),M.removeEventListener("ended",me)),M=new Audio(e),M.volume=f.musicVolume*f.masterVolume,M.addEventListener("ended",me),M.play().catch(t=>{console.warn("[SoundManager] Could not play track:",t),Ue()})}function Ue(){V&&(Y++,Y>=X.length&&(console.log("[SoundManager] All tracks played, reshuffling playlist"),X=Ne(F),Y=0),De())}async function xe(){if(!(!f.enabled||V)){if(V=!0,F.length===0&&!await ht()){console.warn("[SoundManager] No tracks in playlist"),V=!1;return}X=Ne(F),Y=0,De(),console.log("[SoundManager] Background music started with",F.length,"tracks")}}function Oe(){if(V){if(V=!1,M){M.removeEventListener("ended",me);const l=M,e=setInterval(()=>{l.volume>.05?l.volume=Math.max(0,l.volume-.05):(clearInterval(e),l.pause())},30)}console.log("[SoundManager] Background music stopped")}}function Ve(){!f.enabled||$||(V&&Oe(),$=!0,A&&A.pause(),A=new Audio(Ze),A.volume=f.musicVolume*f.masterVolume,A.loop=!0,A.play().catch(l=>{console.warn("[SoundManager] Could not play menu music:",l),$=!1}),console.log("[SoundManager] Menu music started"))}function _e(){if($){if($=!1,A){const l=A,e=setInterval(()=>{l.volume>.05?l.volume=Math.max(0,l.volume-.05):(clearInterval(e),l.pause())},30)}console.log("[SoundManager] Menu music stopped")}}function Fe(){const l=f.musicVolume*f.masterVolume;M&&(M.volume=l),A&&(A.volume=l)}const R=45,L=5,te=w.CELL_WIDTH/2,ut=w.DRONE_RADIUS,ct=400,we=65;class se{constructor(e){this.num=e.num,this.name=e.name||"Player",this.x=e.x,this.y=e.y,this.angle=e.angle||0,this.serverX=e.x,this.serverY=e.y,this.serverAngle=e.angle||0,this.correctionX=0,this.correctionY=0,this.hp=e.hp||100,this.maxHp=e.maxHp||100,this.level=e.level||1,this.xp=e.xp||0,this.sizeScale=e.sizeScale||1,this.dead=e.dead||!1,this.isSnipped=e.isSnipped||!1,this.territory=e.territory||[],this.trail=e.trail||[],this.droneCount=e.droneCount!==void 0?e.droneCount:this.level,this.droneOrbitPhase=0,this.drones=[],e.base?this.base=new D(e.base.hue,e.base.sat,e.base.lum):this.base=new D(Math.random(),.8,.5)}update(e,t=!1){if(t&&e.x!==void 0&&e.y!==void 0){const s=e.x-this.x,n=e.y-this.y;this.correctionX+=s,this.correctionY+=n,Math.sqrt(s*s+n*n)>100&&(this.x=e.x,this.y=e.y,this.correctionX=0,this.correctionY=0)}e.x!==void 0&&(this.serverX=e.x),e.y!==void 0&&(this.serverY=e.y),e.angle!==void 0&&(this.serverAngle=e.angle),e.hp!==void 0&&(this.hp=e.hp),e.maxHp!==void 0&&(this.maxHp=e.maxHp),e.level!==void 0&&(this.level=e.level),e.xp!==void 0&&(this.xp=e.xp),e.sizeScale!==void 0&&(this.sizeScale=e.sizeScale),e.droneCount!==void 0?this.droneCount=e.droneCount:e.level!==void 0&&(this.droneCount=e.level),e.dead!==void 0&&(this.dead=e.dead),e.isSnipped!==void 0&&(this.isSnipped=e.isSnipped),e.territory&&(this.territory=e.territory),e.trail&&(this.trail=e.trail)}updateDrones(e){const t=w.DRONE_ORBIT_RADIUS,s=w.DRONE_ORBIT_SPEED;for(this.droneOrbitPhase+=s*(e/1e3),this.droneOrbitPhase>Math.PI*2&&(this.droneOrbitPhase-=Math.PI*2);this.drones.length<this.droneCount;)this.drones.push({id:this.drones.length,x:this.x,y:this.y,targetId:null});for(;this.drones.length>this.droneCount;)this.drones.pop();for(let n=0;n<this.drones.length;n++){const i=this.drones[n],o=n/this.droneCount*Math.PI*2,a=this.droneOrbitPhase+o;i.x=this.x+Math.cos(a)*t,i.y=this.y+Math.sin(a)*t}}predict(e,t,s,n){this.x+=this.correctionX*.08,this.y+=this.correctionY*.08,this.correctionX*=1-.08,this.correctionY*=1-.08;let o=this.serverAngle-this.angle;for(;o>Math.PI;)o-=Math.PI*2;for(;o<-Math.PI;)o+=Math.PI*2;this.angle+=o*.03;const a=9*(e/1e3);let r=n-this.angle;for(;r>Math.PI;)r-=Math.PI*2;for(;r<-Math.PI;)r+=Math.PI*2;for(Math.abs(r)>a&&(r=Math.sign(r)*a),this.angle+=r;this.angle>Math.PI;)this.angle-=Math.PI*2;for(;this.angle<-Math.PI;)this.angle+=Math.PI*2;const h=t*(e/1e3)*60;this.x+=Math.cos(this.angle)*h,this.y+=Math.sin(this.angle)*h;const c=15;this.x=Math.max(c,Math.min(s-c,this.x)),this.y=Math.max(c,Math.min(s-c,this.y)),this.updateDrones(e)}interpolateOther(e,t){let s=this.serverAngle-this.angle;for(;s>Math.PI;)s-=Math.PI*2;for(;s<-Math.PI;)s+=Math.PI*2;const n=Math.min(1,.2*(e/16.67));for(this.angle+=s*n;this.angle>Math.PI;)this.angle-=Math.PI*2;for(;this.angle<-Math.PI;)this.angle+=Math.PI*2;const i=t*(e/1e3)*60;this.x+=Math.cos(this.angle)*i,this.y+=Math.sin(this.angle)*i;const o=this.serverX-this.x,a=this.serverY-this.y,r=Math.sqrt(o*o+a*a);if(r>200)this.x=this.serverX,this.y=this.serverY;else{const h=Math.min(.25,.05+r*.002);this.x+=o*h,this.y+=a*h}this.updateDrones(e)}}class ce{constructor(e){this.id=e.id,this.x=e.x,this.y=e.y,this.value=e.value||5}}class dt{constructor(e,t,s,n,i){this.fromX=e,this.fromY=t,this.toX=s,this.toY=n,this.color=i,this.startTime=performance.now(),this.duration=100}isExpired(){return performance.now()-this.startTime>this.duration}getAlpha(){const e=performance.now()-this.startTime;return Math.max(0,1-e/this.duration)}}class Be{constructor(e,t={}){this.canvas=e,this.ctx=e.getContext("2d"),this.net=new je({url:t.wsUrl||"ws://localhost:8787/room/default",onStateChange:s=>this.handleStateChange(s),onInit:s=>this.handleInit(s),onFrame:s=>this.handleFrame(s),onEvent:s=>this.handleEvent(s),onError:s=>this.handleError(s)}),this.mapSize=0,this.playerId=null,this.players=new Map,this.coins=new Map,this.effects=[],this.cameraX=0,this.cameraY=0,this.cameraTargetX=0,this.cameraTargetY=0,this.cameraScale=1,this.mouseX=0,this.mouseY=0,this.targetAngle=0,this.mouseSet=!1,this.wasdKeys={w:!1,a:!1,s:!1,d:!1},this.useWasd=!1,this.wasdCurrentAngle=0,this.lastFrameTime=performance.now(),this.networkTickMs=100,this.interpolationDelay=this.networkTickMs,this.onDeath=t.onDeath||(()=>{}),this.onKill=t.onKill||(()=>{}),this.onLevelUp=t.onLevelUp||(()=>{}),this.debugMode=!1,this.lastNetworkUpdate=0,this.networkGaps=[],this.snipFuses=new Map,this._localSnippedPrev=!1,this.handleMouseMove=this.handleMouseMove.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),this.gameLoop=this.gameLoop.bind(this),this.setupInput()}startSnipFuse(e,t){const s=this.players.get(e);if(!s||!s.trail||s.trail.length<2)return;let n={x:s.x,y:s.y};if(t!==65535){const r=this.players.get(t);r&&(n={x:r.x,y:r.y})}const i=this._closestPointOnTrail(n,s.trail),o=i.point||{x:s.trail[0].x,y:s.trail[0].y},a=i.index??0;this.snipFuses.set(e,{playerNum:e,snipperNum:t,startPoint:o,segmentIndex:a,elapsed:0,progressDist:0,fusePos:{x:o.x,y:o.y},ratio:0,remainingPoints:null})}_closestPointOnTrail(e,t){let s={dist2:1/0,point:null,index:0};for(let n=0;n<t.length-1;n++){const i=t[n],o=t[n+1],a=this._closestPointOnSegment(e,i,o),r=e.x-a.x,h=e.y-a.y,c=r*r+h*h;c<s.dist2&&(s={dist2:c,point:a,index:n})}return s}_closestPointOnSegment(e,t,s){const n=s.x-t.x,i=s.y-t.y,o=e.x-t.x,a=e.y-t.y,r=n*n+i*i;if(r===0)return{x:t.x,y:t.y};let h=(o*n+a*i)/r;return h=Math.max(0,Math.min(1,h)),{x:t.x+n*h,y:t.y+i*h}}_pointAtDistance(e,t){if(e.length===0)return null;if(e.length===1)return{x:e[0].x,y:e[0].y};let s=t;for(let n=0;n<e.length-1;n++){const i=e[n],o=e[n+1],a=Math.hypot(o.x-i.x,o.y-i.y);if(!(a<=1e-4)){if(s<=a){const r=s/a;return{x:i.x+(o.x-i.x)*r,y:i.y+(o.y-i.y)*r}}s-=a}}return{x:e[e.length-1].x,y:e[e.length-1].y}}_pointAtDistanceWithIndex(e,t){if(e.length===0)return{point:null,index:0};if(e.length===1)return{point:{x:e[0].x,y:e[0].y},index:0};let s=t;for(let n=0;n<e.length-1;n++){const i=e[n],o=e[n+1],a=Math.hypot(o.x-i.x,o.y-i.y);if(!(a<=1e-4)){if(s<=a){const r=s/a;return{point:{x:i.x+(o.x-i.x)*r,y:i.y+(o.y-i.y)*r},index:n}}s-=a}}return{point:{x:e[e.length-1].x,y:e[e.length-1].y},index:e.length-2}}_sumLength(e){let t=0;for(let s=0;s<e.length-1;s++)t+=Math.hypot(e[s+1].x-e[s].x,e[s+1].y-e[s].y);return t}updateSnipFuses(e){const t=e/1e3;for(const[i,o]of Array.from(this.snipFuses.entries())){const a=this.players.get(i);if(!a||!a.isSnipped||!a.trail||a.trail.length<2){this.snipFuses.delete(i);continue}o.elapsed+=t;const r=w.SPEED,h=w.SNIP_FUSE_SPEED_MULT,c=w.SNIP_EXP_ACCEL_PER_SEC,u=w.SNIP_GRACE_PERIOD,d=Math.max(0,o.elapsed-u),m=r*h*60,y=Math.exp(c*d);let S=m*y;const v=w.SNIP_FUSE_MAX_SPEED_MULT;S=Math.min(S,r*v*60),o.elapsed>u&&(o.progressDist+=S*t);const p=Math.max(0,Math.min(a.trail.length-2,o.segmentIndex)),N=[o.startPoint,...a.trail.slice(p+1),{x:a.x,y:a.y}],Z=this._sumLength(N),ee=Math.max(1,Z);o.ratio=Math.max(0,Math.min(1,o.progressDist/ee));const q=this._pointAtDistanceWithIndex(N,Math.min(o.progressDist,ee));o.fusePos=q.point;const he=N.slice(q.index+1);o.remainingPoints=[o.fusePos,...he]}const s=this.players.get(this.playerId),n=!!(s&&s.isSnipped);if(n&&!this._localSnippedPrev&&at(),!n&&this._localSnippedPrev&&lt(),this._localSnippedPrev=n,n){const i=this.snipFuses.get(this.playerId);i&&rt(i.ratio)}}setupInput(){this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),this.canvas.addEventListener("touchstart",this.handleTouchMove,{passive:!1}),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp)}cleanupInput(){this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("touchmove",this.handleTouchMove),this.canvas.removeEventListener("touchstart",this.handleTouchMove),window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp)}handleKeyDown(e){const t=document.activeElement,s=t&&t.tagName?t.tagName.toLowerCase():"";if(s==="input"||s==="textarea"||s==="select"||e.repeat)return;const n=(e.key||"").toLowerCase();if(e.key==="F3"){this.debugMode=!this.debugMode,console.log("Debug mode:",this.debugMode?"ON":"OFF");return}if(n==="r"){console.log("%cüîÑ RESETTING ROOM...","color: orange; font-weight: bold;"),this.net.sendReset();return}(n==="w"||n==="a"||n==="s"||n==="d")&&this.setKeyState(n,!0)}handleKeyUp(e){const t=(e.key||"").toLowerCase();(t==="w"||t==="a"||t==="s"||t==="d")&&this.setKeyState(t,!1)}setKeyState(e,t){const s=(e||"").toLowerCase();s in this.wasdKeys&&(this.wasdKeys[s]=!!t,this.useWasd=!!(this.wasdKeys.w||this.wasdKeys.a||this.wasdKeys.s||this.wasdKeys.d))}handleMouseMove(e){const t=this.canvas.getBoundingClientRect();this.mouseX=e.clientX-t.left,this.mouseY=e.clientY-t.top,this.mouseSet=!0,this.updateTargetAngle()}handleTouchMove(e){if(e.preventDefault(),e.touches.length>0){const t=this.canvas.getBoundingClientRect();this.mouseX=e.touches[0].clientX-t.left,this.mouseY=e.touches[0].clientY-t.top,this.mouseSet=!0,this.updateTargetAngle()}}updateTargetAngle(){const e=this.players.get(this.playerId);if(!e)return;const t=this.cameraX+(this.mouseX-this.canvas.width/2)/this.cameraScale,s=this.cameraY+(this.mouseY-this.canvas.height/2)/this.cameraScale;this.targetAngle=Math.atan2(s-e.y,t-e.x),this.useWasd||(this.wasdCurrentAngle=this.targetAngle)}connect(e){this.playerName=e,this.net.connect(e)}connectSpectate(){this.spectateMode=!0,this.net.connectSpectate()}disconnect(){this.net.disconnect(),this.stopGameLoop(),this.cleanupInput()}handleStateChange(e){console.log("Connection state:",e)}handleInit(e){this.playerId=e.playerId,this.mapSize=e.mapSize,this.players.clear(),this.coins.clear(),this.effects=[];for(const t of e.players)this.players.set(t.num,new se(t));for(const t of e.coins)this.coins.set(t.id,new ce(t));if(this.spectateMode){this.cameraX=this.mapSize/2,this.cameraY=this.mapSize/2,this.cameraTargetX=this.mapSize/2,this.cameraTargetY=this.mapSize/2;const t=50;this.cameraScale=Math.min(this.canvas.width/(this.mapSize+t*2),this.canvas.height/(this.mapSize+t*2))}else{const t=this.players.get(this.playerId);t&&(this.cameraX=t.x,this.cameraY=t.y,this.cameraTargetX=t.x,this.cameraTargetY=t.y)}this.startGameLoop()}handleFrame(e){const t=performance.now();if(this.lastNetworkUpdate){const s=t-this.lastNetworkUpdate;this.networkGaps.push(s),this.networkGaps.length>20&&this.networkGaps.shift(),s>150&&this.debugMode&&console.warn(`[NET] Long gap between updates: ${s.toFixed(0)}ms`)}if(this.lastNetworkUpdate=t,e.selfPlayer){let s=this.players.get(e.selfPlayer.num);s?s.update(e.selfPlayer,!0):(s=new se(e.selfPlayer),this.players.set(e.selfPlayer.num,s))}for(const s of e.newPlayers)this.players.has(s.num)||this.players.set(s.num,new se(s));for(const s of e.updatedPlayers){const n=this.players.get(s.num);n&&n.update(s,!1)}for(const s of e.removedPlayerIds)this.players.delete(s);this.coins.clear();for(const s of e.coins)this.coins.set(s.id,new ce(s));for(const s of e.events)this.handleEvent(s)}handleEvent(e){switch(e.type){case b.HITSCAN:this.addHitscanEffect(e);break;case b.PLAYER_KILL:e.victimNum===this.playerId?this.onDeath(e):e.killerNum===this.playerId&&this.onKill(e);break;case b.LEVEL_UP:e.playerNum===this.playerId&&this.onLevelUp(e);break;case b.PLAYER_JOIN:e.player&&!this.players.has(e.player.num)&&this.players.set(e.player.num,new se(e.player));break;case b.PLAYER_LEAVE:this.players.delete(e.num);break;case b.COIN_SPAWN:this.coins.set(e.id,new ce(e));break;case b.COIN_PICKUP:this.coins.delete(e.id),e.playerNum===this.playerId&&ot();break;case b.SNIP_START:this.startSnipFuse(e.playerNum,e.snipperNum);break;case"dead":this.onDeath(e);break}}addHitscanEffect(e){const t=this.players.get(e.ownerNum),s=this.players.get(e.targetNum);if(!t||!s)return;const n=t.base;let i=t.x,o=t.y;if(t.drones.length>0){const r=t.drones[Math.floor(Math.random()*t.drones.length)];i=r.x,o=r.y}this.effects.push(new dt(i,o,s.x,s.y,n));const a=this.players.get(this.playerId);if(a)if(e.ownerNum===this.playerId)nt();else{const r=Math.hypot(i-a.x,o-a.y);it(r)}}handleError(e){console.error("Network error:",e)}startGameLoop(){this.running=!0,this.lastFrameTime=performance.now(),requestAnimationFrame(this.gameLoop)}stopGameLoop(){this.running=!1}gameLoop(e){if(!this.running)return;const t=e-this.lastFrameTime;this.lastFrameTime=e,this.update(t),this.render(),this.net.flushInput(),requestAnimationFrame(this.gameLoop)}update(e){const t=this.players.get(this.playerId);if(!this.spectateMode&&t&&!t.dead){const s=this.computeInputAngle(t,e);typeof s=="number"&&Number.isFinite(s)&&(this.targetAngle=s,this.net.sendInput(this.targetAngle))}for(const[s,n]of this.players)!this.spectateMode&&s===this.playerId&&t&&!t.dead?n.predict(e,w.SPEED,this.mapSize,this.targetAngle):n.interpolateOther(e,w.SPEED);if(this.spectateMode){this.cameraX=this.mapSize/2,this.cameraY=this.mapSize/2;const s=50;this.cameraScale=Math.min(this.canvas.width/(this.mapSize+s*2),this.canvas.height/(this.mapSize+s*2))}else if(t){this.cameraTargetX=t.x,this.cameraTargetY=t.y;const s=.15;this.cameraX+=(this.cameraTargetX-this.cameraX)*s,this.cameraY+=(this.cameraTargetY-this.cameraY)*s}this.updateSnipFuses(e),this.effects=this.effects.filter(s=>!s.isExpired())}computeInputAngle(e,t){if(this.useWasd){let r=0,h=0;if(this.wasdKeys.w&&(h-=1),this.wasdKeys.s&&(h+=1),this.wasdKeys.a&&(r-=1),this.wasdKeys.d&&(r+=1),r===0&&h===0)return null;const c=Math.atan2(h,r);let u=c-this.wasdCurrentAngle;for(;u>Math.PI;)u-=Math.PI*2;for(;u<-Math.PI;)u+=Math.PI*2;const d=.15*(t/16.67);for(Math.abs(u)<=d?this.wasdCurrentAngle=c:this.wasdCurrentAngle+=Math.sign(u)*d;this.wasdCurrentAngle>Math.PI;)this.wasdCurrentAngle-=Math.PI*2;for(;this.wasdCurrentAngle<-Math.PI;)this.wasdCurrentAngle+=Math.PI*2;return this.wasdCurrentAngle}if(!this.mouseSet)return null;const s=this.cameraX+(this.mouseX-this.canvas.width/2)/this.cameraScale,n=this.cameraY+(this.mouseY-this.canvas.height/2)/this.cameraScale,i=s-e.x,o=n-e.y;if(i*i+o*o<100)return null;const a=Math.atan2(o,i);return this.wasdCurrentAngle=a,a}render(){const e=this.ctx,t=this.canvas.width,s=this.canvas.height,n=s-R;e.fillStyle="#e2ebf3",e.fillRect(0,0,t,s),e.save(),e.translate(0,R),e.beginPath(),e.rect(0,0,t,n),e.clip(),e.translate(t/2,n/2),e.scale(this.cameraScale,this.cameraScale),e.translate(-this.cameraX,-this.cameraY),this.drawGrid(e);const i=Array.from(this.players.values()).sort((o,a)=>o.num-a.num);for(const o of i)this.drawTerritory(e,o);for(const o of this.coins.values())this.drawCoin(e,o);for(const o of i)this.drawTrail(e,o);for(const o of i)o.dead||this.drawPlayer(e,o);for(const o of this.effects)this.drawHitscan(e,o);e.restore(),this.drawTopBar(e),this.drawLeaderboard(e),this.drawXPBar(e),this.debugMode&&this.drawDebugHUD(e)}drawDebugHUD(e){let s=150;const n=16;e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(5,s-15,250,180),e.fillStyle="#00ff00",e.font="12px monospace",e.textAlign="left",e.fillText("=== DEBUG MODE (press D to toggle) ===",10,s),s+=n;let i=0,o=0,a=0;for(const[m,y]of this.players){if(m===this.playerId||y.dead)continue;const S=y.serverX-y.x,v=y.serverY-y.y,p=Math.sqrt(S*S+v*v);i+=p,o=Math.max(o,p),a++}const r=a>0?i/a:0;e.fillText(`Players: ${this.players.size} (${a} others)`,10,s),s+=n,e.fillText(`Avg position error: ${r.toFixed(1)}px`,10,s),s+=n,e.fillText(`Max position error: ${o.toFixed(1)}px`,10,s),s+=n;const h=this.networkGaps.length>0?this.networkGaps.reduce((m,y)=>m+y,0)/this.networkGaps.length:0,c=this.networkGaps.length>0?Math.max(...this.networkGaps):0,u=performance.now()-this.lastNetworkUpdate;e.fillText(`Net update gap: avg ${h.toFixed(0)}ms, max ${c.toFixed(0)}ms`,10,s),s+=n,e.fillStyle=u>150?"#ff0000":"#00ff00",e.fillText(`Time since last update: ${u.toFixed(0)}ms`,10,s),e.fillStyle="#00ff00",s+=n;const d=this.players.get(this.playerId);if(d){s+=n,e.fillStyle="#ffff00",e.fillText("--- Local Player ---",10,s),s+=n,e.fillStyle="#00ff00",e.fillText(`Pos: (${d.x.toFixed(1)}, ${d.y.toFixed(1)})`,10,s),s+=n,e.fillText(`Server: (${d.serverX.toFixed(1)}, ${d.serverY.toFixed(1)})`,10,s),s+=n;const m=Math.sqrt(Math.pow(d.serverX-d.x,2)+Math.pow(d.serverY-d.y,2));e.fillText(`Correction offset: ${m.toFixed(1)}px`,10,s)}}drawGrid(e){const t=this.mapSize,s=w.BORDER_WIDTH;e.fillStyle="rgb(211, 225, 237)",e.fillRect(0,0,t,t),e.strokeStyle="rgba(180, 200, 220, 0.5)",e.lineWidth=1;const n=w.CELL_WIDTH*2;e.beginPath();for(let i=0;i<=t;i+=n)e.moveTo(i,0),e.lineTo(i,t);for(let i=0;i<=t;i+=n)e.moveTo(0,i),e.lineTo(t,i);e.stroke(),e.fillStyle="lightgray",e.fillRect(-s,0,s,t),e.fillRect(-s,-s,t+s*2,s),e.fillRect(t,0,s,t),e.fillRect(-s,t,t+s*2,s)}drawTerritory(e,t){if(!t.territory||t.territory.length<3)return;const s=t.base,n=t.isSnipped;let i=1;if(n){const o=Date.now()/100;i=.3+.5*(.5+.5*Math.sin(o*4))}e.fillStyle=s.deriveAlpha(.4*i).rgbString(),e.beginPath(),e.moveTo(t.territory[0].x,t.territory[0].y);for(let o=1;o<t.territory.length;o++)e.lineTo(t.territory[o].x,t.territory[o].y);e.closePath(),e.fill(),e.strokeStyle=s.deriveAlpha(.9*i).rgbString(),e.lineWidth=2.5,e.lineJoin="round",e.lineCap="round",e.stroke()}drawTrail(e,t){if(!t.trail||t.trail.length<1)return;const n=t.base.lighter(.2);e.strokeStyle=n.rgbString(),e.lineWidth=te,e.lineCap="round",e.lineJoin="round";const i=t.x,o=t.y;if(t.isSnipped){const a=this.snipFuses.get(t.num);if(a&&a.remainingPoints&&a.remainingPoints.length>=2&&a.fusePos){e.beginPath(),e.moveTo(a.remainingPoints[0].x,a.remainingPoints[0].y);for(let m=1;m<a.remainingPoints.length;m++)e.lineTo(a.remainingPoints[m].x,a.remainingPoints[m].y);e.stroke();const r=performance.now(),h=.75+.25*Math.sin(r*.02+t.num),c=te*.6*h;e.save(),e.globalCompositeOperation="lighter";const u=e.createRadialGradient(a.fusePos.x,a.fusePos.y,0,a.fusePos.x,a.fusePos.y,c*2);u.addColorStop(0,"rgba(255,255,200,0.95)"),u.addColorStop(.35,"rgba(255,180,60,0.65)"),u.addColorStop(1,"rgba(255,40,0,0)"),e.fillStyle=u,e.beginPath(),e.arc(a.fusePos.x,a.fusePos.y,c*2,0,Math.PI*2),e.fill();const d=this._sparkDirection(a.remainingPoints);for(let m=0;m<6;m++){const y=(m*.9+r*.03+t.num)%(Math.PI*2),S=d+Math.sin(y)*.7,v=c*2.2*(.4+.6*((Math.sin(y*1.7)+1)*.5)),p=a.fusePos.x+Math.cos(S)*v,N=a.fusePos.y+Math.sin(S)*v;e.strokeStyle="rgba(255,200,80,0.9)",e.lineWidth=2,e.beginPath(),e.moveTo(a.fusePos.x,a.fusePos.y),e.lineTo(p,N),e.stroke()}e.restore();return}}e.beginPath(),e.moveTo(t.trail[0].x,t.trail[0].y);for(let a=1;a<t.trail.length-1;a++)e.lineTo(t.trail[a].x,t.trail[a].y);if(t.trail.length>1){const a=t.trail[t.trail.length-1];if(Math.hypot(a.x-i,a.y-o)>te*2){const h=a.x+(i-a.x)*.5,c=a.y+(o-a.y)*.5;e.lineTo(h,c)}}e.lineTo(i,o),e.stroke()}_sparkDirection(e){if(!e||e.length<2)return 0;const t=e[0],s=e[1];return Math.atan2(s.y-t.y,s.x-t.x)}drawCoin(e,t){const s=w.COIN_RADIUS;e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.arc(t.x+2,t.y+2,s,0,Math.PI*2),e.fill(),e.fillStyle="#FFD700",e.shadowBlur=5,e.shadowColor="rgba(0, 0, 0, 0.3)",e.beginPath(),e.arc(t.x,t.y,s,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="rgba(255, 255, 255, 0.6)",e.beginPath(),e.arc(t.x-s*.3,t.y-s*.3,s*.3,0,Math.PI*2),e.fill()}drawPlayer(e,t){const s=te*(t.sizeScale||1),n=t.base,i=n.darker(.3),o=n.lighter(.1),a=t.isSnipped;let r=1;if(a){const u=Date.now()/100;r=.3+.5*(.5+.5*Math.sin(u*4))}for(const u of t.drones)this.drawDrone(e,u,n,t);if(e.fillStyle=i.deriveAlpha(r).rgbString(),e.beginPath(),e.arc(t.x+2,t.y+4,s,0,Math.PI*2),e.fill(),a){const u=.5+.5*Math.sin(Date.now()/100*4);e.fillStyle=`rgba(255, ${Math.floor(100*u)}, ${Math.floor(100*u)}, ${r})`}else e.fillStyle=n.rgbString();if(e.beginPath(),e.arc(t.x,t.y,s,0,Math.PI*2),e.fill(),a){const u=.5+.5*Math.sin(Date.now()/100*6);e.strokeStyle=`rgba(255, 50, 50, ${.5+.5*u})`,e.lineWidth=3+2*u,e.beginPath(),e.arc(t.x,t.y,s+4+2*u,0,Math.PI*2),e.stroke()}const h=t.x+Math.cos(t.angle)*s*.6,c=t.y+Math.sin(t.angle)*s*.6;if(e.fillStyle=o.deriveAlpha(r).rgbString(),e.beginPath(),e.arc(h,c,s*.3,0,Math.PI*2),e.fill(),t.hp<t.maxHp){const u=s*2.5,d=6*(t.sizeScale||1),m=t.x-u/2,y=t.y+s+8;e.fillStyle="rgba(20, 20, 20, 0.8)",e.fillRect(m,y,u,d);const S=Math.max(0,t.hp/t.maxHp);S>.5?e.fillStyle="#44ff44":S>.25?e.fillStyle="#ffcc00":e.fillStyle="#ff4444",e.fillRect(m,y,u*S,d),e.strokeStyle="rgba(0, 0, 0, 0.8)",e.lineWidth=Math.max(1,1.5*(t.sizeScale||1));for(let v=1;v<=3;v++){const p=m+u*v/4;e.beginPath(),e.moveTo(p,y),e.lineTo(p,y+d),e.stroke()}e.strokeStyle="#000000",e.lineWidth=Math.max(1,2*(t.sizeScale||1)),e.strokeRect(m,y,u,d)}if(e.fillStyle=i.rgbString(),e.textAlign="center",e.font="bold 14px Arial",a&&(e.fillStyle="rgba(255, 50, 50, 1)",e.fillText("SNIPPED!",t.x,t.y-s-22),e.fillStyle=i.deriveAlpha(r).rgbString()),e.fillText(t.name,t.x,t.y-s-8),this.debugMode&&t.num!==this.playerId){e.strokeStyle="rgba(0, 255, 0, 0.8)",e.lineWidth=2,e.beginPath(),e.arc(t.serverX,t.serverY,s+5,0,Math.PI*2),e.stroke();const u=t.serverX-t.x,d=t.serverY-t.y,m=Math.sqrt(u*u+d*d);m>1&&(e.strokeStyle="rgba(255, 0, 0, 0.8)",e.lineWidth=2,e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(t.serverX,t.serverY),e.stroke()),e.strokeStyle="rgba(0, 100, 255, 0.8)",e.lineWidth=2,e.beginPath(),e.moveTo(t.serverX,t.serverY),e.lineTo(t.serverX+Math.cos(t.serverAngle)*40,t.serverY+Math.sin(t.serverAngle)*40),e.stroke(),e.fillStyle="rgba(255, 255, 0, 1)",e.font="10px monospace",e.fillText(`err: ${m.toFixed(1)}px`,t.x,t.y+s+25)}}drawDrone(e,t,s,n){const i=ut,o=n&&n.isSnipped,a=n&&n.num===this.playerId;if(e.save(),e.fillStyle="rgba(0, 0, 0, 0.3)",e.beginPath(),e.arc(t.x+2,t.y+2,i,0,Math.PI*2),e.fill(),t.targetId!==null&&!o){const r=Date.now()/150,h=.4+.3*Math.sin(r*4);e.shadowBlur=12*h,e.shadowColor=a?"#FFD700":s?s.rgbString():"#FF6600"}if(o?e.fillStyle="rgba(100, 100, 100, 0.5)":s?e.fillStyle=s.deriveAlpha(a?.95:.8).rgbString():e.fillStyle=a?"rgba(100, 200, 100, 0.95)":"rgba(200, 100, 100, 0.8)",e.beginPath(),e.arc(t.x,t.y,i,0,Math.PI*2),e.fill(),o?e.strokeStyle="rgba(60, 60, 60, 0.6)":e.strokeStyle=s?s.darker(.2).rgbString():"#444",e.lineWidth=2,e.stroke(),e.shadowBlur=0,o?e.fillStyle="rgba(80, 80, 80, 0.4)":e.fillStyle=s?s.lighter(.3).deriveAlpha(.7).rgbString():"rgba(255, 255, 255, 0.5)",e.beginPath(),e.arc(t.x-i*.25,t.y-i*.25,i*.35,0,Math.PI*2),e.fill(),t.targetId!==null&&!o){const r=Date.now()/100,h=.5+.5*Math.sin(r*5);e.fillStyle=`rgba(255, 100, 100, ${.6+.4*h})`,e.beginPath(),e.arc(t.x,t.y,i*.3,0,Math.PI*2),e.fill()}if(o){e.strokeStyle="rgba(255, 80, 80, 0.8)",e.lineWidth=2,e.lineCap="round";const r=i*.5;e.beginPath(),e.moveTo(t.x-r,t.y-r),e.lineTo(t.x+r,t.y+r),e.moveTo(t.x+r,t.y-r),e.lineTo(t.x-r,t.y+r),e.stroke()}e.restore()}drawHitscan(e,t){const s=t.getAlpha(),n=t.color;e.save(),e.lineCap="round",e.lineWidth=12*s,e.strokeStyle=n.deriveAlpha(.5*s).rgbString(),e.beginPath(),e.moveTo(t.fromX,t.fromY),e.lineTo(t.toX,t.toY),e.stroke(),e.lineWidth=5*s,e.strokeStyle=n.lighter(.4).deriveAlpha(.95*s).rgbString(),e.beginPath(),e.moveTo(t.fromX,t.fromY),e.lineTo(t.toX,t.toY),e.stroke(),e.lineWidth=2*s,e.strokeStyle=`rgba(255, 255, 255, ${s})`,e.beginPath(),e.moveTo(t.fromX,t.fromY),e.lineTo(t.toX,t.toY),e.stroke();const i=20*s,o=e.createRadialGradient(t.toX,t.toY,0,t.toX,t.toY,i);o.addColorStop(0,n.lighter(.6).deriveAlpha(s).rgbString()),o.addColorStop(.4,n.deriveAlpha(.6*s).rgbString()),o.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=o,e.beginPath(),e.arc(t.toX,t.toY,i,0,Math.PI*2),e.fill(),e.restore()}drawTopBar(e){const t=this.players.get(this.playerId);if(!t)return;e.fillStyle="#3a3a3a",e.fillRect(0,0,this.canvas.width,R),e.textAlign="left",e.textBaseline="alphabetic";const s=t.level||1;t.drones&&t.drones.length;let n=15;const i=R/2+6;e.fillStyle="#88CCFF",e.font="bold 16px Arial",e.fillText("RTT:",n,i),n+=e.measureText("RTT:").width+5,e.fillStyle="white",e.fillText(`${Math.round(this.net.getRTT())}ms`,n,i),n+=e.measureText(`${Math.round(this.net.getRTT())}ms`).width+20,e.fillStyle="#FFD700",e.font="bold 16px Arial",e.fillText("Level:",n,i),n+=e.measureText("Level:").width+5,e.fillStyle="white",e.fillText(s,n,i),n+=e.measureText(String(s)).width+20,e.fillStyle="#FF6B6B",e.font="bold 16px Arial",e.fillText("HP:",n,i),n+=e.measureText("HP:").width+5,e.fillStyle="white",e.fillText(`${Math.round(t.hp)}/${t.maxHp}`,n,i),n+=e.measureText(`${Math.round(t.hp)}/${t.maxHp}`).width+20,e.fillStyle="#9370DB",e.font="bold 16px Arial",e.fillText("XP:",n,i),n+=e.measureText("XP:").width+5,e.fillStyle="white",e.fillText(t.xp,n,i)}drawLeaderboard(e){const t=Array.from(this.players.values()).filter(n=>!n.dead).sort((n,i)=>i.level-n.level||i.xp-n.xp),s=Math.min(w.LEADERBOARD_NUM,t.length);e.font="18px Arial",e.textAlign="left";for(let n=0;n<s;n++){const i=t[n],o=i.name||"Unnamed",a=i.base,r=a.darker(.3),h=1-n/s,c=Math.ceil((ct-we)*h+we),u=this.canvas.width-c,d=R*(n+1),m=n===0?10:0;e.fillStyle="rgba(10, 10, 10, 0.3)",e.fillRect(u-10,d+10-m,c+10,R+m),e.fillStyle=a.rgbString(),e.fillRect(u,d,c,R-L),e.fillStyle=r.rgbString(),e.fillRect(u,d+R-L,c,L);const y=e.measureText(o).width;e.fillStyle="black",e.fillText(o,u-y-15,d+27);const S=i.num===this.playerId;e.fillStyle=S?"#FFD700":"white",e.fillText(`Lv.${i.level}`,u+5,d+R-15)}}drawXPBar(e){const t=this.players.get(this.playerId);if(!t)return;const s=t.level||1,n=t.xp||0,i=w.XP_BASE_PER_LEVEL+(s-1)*w.XP_INCREMENT_PER_LEVEL,o=250,a=28,r=(this.canvas.width-o)/2,h=this.canvas.height-45,c=Math.min(1,n/i),u=t.base,d=u.darker(.3);if(e.fillStyle="rgba(10, 10, 10, 0.5)",e.fillRect(r-60,h-2,o+70,a+4),e.font="bold 18px Arial",e.fillStyle="#FFD700",e.textAlign="left",e.fillText(`Lv.${s}`,r-55,h+a-8),e.fillStyle="rgba(60, 60, 60, 0.8)",e.fillRect(r,h,o,a-L),e.fillStyle="rgba(40, 40, 40, 0.8)",e.fillRect(r,h+a-L,o,L),c>0){const m=o*c;e.fillStyle=u.rgbString(),e.fillRect(r,h,m,a-L),e.fillStyle=d.rgbString(),e.fillRect(r,h+a-L,m,L)}e.font="16px Arial",e.fillStyle="white",e.textAlign="center",e.fillText(`${Math.floor(n)}/${i} XP`,r+o/2,h+a-9)}getSelfPlayer(){return this.players.get(this.playerId)}resize(e,t){this.canvas.width=e,this.canvas.height=t}}let x,G,O,_,z,ne,ge,pe,T,Xe,Ye,Ge,ie,qe,oe,be,ae,Te,Ee,Pe,re=0,j=1;const He="swarmblitz.audio.v1";function ft(){try{const l=localStorage.getItem(He);if(!l)return null;const e=JSON.parse(l);return e&&typeof e=="object"?e:null}catch{return null}}function de(){try{const l=ve?ve():null;if(!l)return;localStorage.setItem(He,JSON.stringify(l))}catch{}}function mt(){const l=document.getElementById("vol-master"),e=document.getElementById("vol-music"),t=document.getElementById("vol-sfx"),s=document.getElementById("vol-master-val"),n=document.getElementById("vol-music-val"),i=document.getElementById("vol-sfx-val");l&&s&&(s.textContent=`${l.value}%`),e&&n&&(n.textContent=`${e.value}%`),t&&i&&(i.textContent=`${t.value}%`)}function gt(){const l=ft();if(!l)return;typeof l.masterVolume=="number"&&Re(l.masterVolume),typeof l.musicVolume=="number"&&Le(l.musicVolume),typeof l.sfxVolume=="number"&&ke(l.sfxVolume),l.volumes&&typeof l.volumes=="object"&&st(l.volumes),typeof l.enabled=="boolean"&&tt(l.enabled);const e=document.getElementById("vol-master"),t=document.getElementById("vol-music"),s=document.getElementById("vol-sfx");e&&typeof l.masterVolume=="number"&&(e.value=String(Math.round(l.masterVolume*100))),t&&typeof l.musicVolume=="number"&&(t.value=String(Math.round(l.musicVolume*100))),s&&typeof l.sfxVolume=="number"&&(s.value=String(Math.round(l.sfxVolume*100))),mt()}function K(){et(),Q(),G&&G.style.display!=="none"&&Ve()}function Me(){x=document.getElementById("main-ui"),G=document.getElementById("begin"),O=document.getElementById("wasted"),_=document.getElementById("settings"),z=document.getElementById("name"),ne=document.querySelector(".start.start-btn.primary"),ge=document.querySelector(".spectate.start-btn.secondary"),pe=document.getElementById("error"),Xe=document.getElementById("death-score"),Ye=document.getElementById("death-kills"),Ge=document.getElementById("death-level"),ie=document.getElementById("death-killer-info"),qe=document.getElementById("death-killer-name"),oe=O.querySelector(".start.orange"),be=O.querySelector(".menu.yellow"),ae=O.querySelector(".spectate.green"),Te=document.querySelector(".toggle.yellow"),Ee=document.getElementById("settings-close"),Pe=document.getElementById("settings-menu-btn"),Ie(),window.addEventListener("resize",Ie),ne.addEventListener("click",fe),z.addEventListener("keypress",t=>{t.key==="Enter"&&!ne.disabled&&fe()}),ge.addEventListener("click",Ce),ae.addEventListener("click",Ce),oe.addEventListener("click",fe),be.addEventListener("click",Ae),Te.addEventListener("click",St),Ee.addEventListener("click",()=>{_.style.display="none"}),Pe.addEventListener("click",()=>{_.style.display="none",Ae()});const l=document.getElementById("how-to-play-toggle"),e=document.getElementById("how-to-play-content");l&&e&&l.addEventListener("click",()=>{const t=e.style.display!=="none";e.style.display=t?"none":"block",l.classList.toggle("expanded",!t)}),pt(),gt(),document.addEventListener("pointerdown",K,{once:!0}),document.addEventListener("touchstart",K,{once:!0,passive:!0}),document.addEventListener("keydown",K,{once:!0}),yt(),z.focus()}function pt(){const l=document.getElementById("vol-master"),e=document.getElementById("vol-music"),t=document.getElementById("vol-sfx"),s=document.getElementById("vol-master-val"),n=document.getElementById("vol-music-val"),i=document.getElementById("vol-sfx-val");l&&s&&l.addEventListener("input",()=>{s.textContent=`${l.value}%`,Re(parseInt(l.value,10)/100),de()}),e&&n&&e.addEventListener("input",()=>{n.textContent=`${e.value}%`,Le(parseInt(e.value,10)/100),de()}),t&&i&&t.addEventListener("input",()=>{i.textContent=`${t.value}%`,ke(parseInt(t.value,10)/100),de()})}function yt(){ne.disabled=!1,ge.disabled=!1,oe.disabled=!1,ae.disabled=!1,pe.textContent="Ready to play!",pe.style.color="#4caf50"}function Ie(){x&&(x.width=window.innerWidth,x.height=window.innerHeight,T&&T.resize(x.width,x.height))}function St(){const l=_.style.display!=="none";_.style.display=l?"none":"block"}function Ae(){T&&(T.disconnect(),T=null),O.style.display="none",_.style.display="none",G.style.display="flex",z.focus(),re=0,j=1,Oe(),Ve()}function fe(){const l=z.value.trim()||"Player";K(),G.style.display="none",O.style.display="none",_.style.display="none",re=0,j=1,_e(),xe();const e=window.location.search.includes("prod");let t;e?(t="wss://swarmblitz.dev-1dd.workers.dev/room/default",console.log("%c‚òÅÔ∏è CONNECTING TO PRODUCTION SERVER","background: #4caf50; color: white; font-size: 16px; padding: 4px 8px;")):(t="ws://localhost:8787/room/default",console.log("%cüîß CONNECTING TO LOCAL SERVER","background: #ff9800; color: black; font-size: 16px; padding: 4px 8px;")),console.log("WebSocket URL:",t),T=new Be(x,{wsUrl:t,onDeath:We,onKill:$e,onLevelUp:ze}),T.connect(l)}function Ce(){K(),G.style.display="none",O.style.display="none",_.style.display="none",_e(),xe();const l=window.location.search.includes("prod");let e;l?(e="wss://swarmblitz.dev-1dd.workers.dev/room/default",console.log("%cüëÅ SPECTATING PRODUCTION SERVER","background: #9c27b0; color: white; font-size: 16px; padding: 4px 8px;")):(e="ws://localhost:8787/room/default",console.log("%cüëÅ SPECTATING LOCAL SERVER","background: #9c27b0; color: white; font-size: 16px; padding: 4px 8px;")),T=new Be(x,{wsUrl:e,spectateMode:!0,onDeath:We,onKill:$e,onLevelUp:ze}),T.connectSpectate()}function We(l){console.log("You died!",l);const e=T?T.getSelfPlayer():null,t=e?e.level:j,s="0.00%";if(Xe.textContent=s,Ye.textContent=re.toString(),Ge.textContent=t.toString(),l.killerNum!==void 0&&l.killerNum!==65535){const n=T?T.players.get(l.killerNum):null;n?(qe.textContent=n.name,ie.style.display="block"):ie.style.display="none"}else ie.style.display="none";setTimeout(()=>{T&&(T.disconnect(),T=null),oe.disabled=!1,ae.disabled=!1,O.style.display="flex"},1500)}function $e(l){console.log("You killed someone!",l),re++}function ze(l){console.log("Level up!",l),l.newLevel>j&&(j=l.newLevel)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Me):Me();window.getGameClient=()=>T;
